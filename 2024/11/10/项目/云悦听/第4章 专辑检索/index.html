

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://p0.itc.cn/q_70/images03/20230516/bab1646e504942d4a9d964cde5d8b15d.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pz">
  <meta name="keywords" content="">
  
    <meta name="description" content="第4章 专辑检索学习目标：  专辑索引库设计（字段、字段类型（Nested嵌套类型）） 专辑数据到索引库 全量导入 增量导入   多条件专辑数据检索 不同分类下热门的专辑列表 搜索词自动补全  1、检索业务介绍   1. 根据用户输入的检索条件，查询出对用的商品  - **业务数据**:包含专辑ID、专辑名称、专辑封面、主播名称、专辑声音数量、付费类型、分类ID、统计信息、专辑标签等  - **过">
<meta property="og:type" content="article">
<meta property="og:title" content="4-2、专辑检索">
<meta property="og:url" content="http://example.com/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/index.html">
<meta property="og:site_name" content="PZ">
<meta property="og:description" content="第4章 专辑检索学习目标：  专辑索引库设计（字段、字段类型（Nested嵌套类型）） 专辑数据到索引库 全量导入 增量导入   多条件专辑数据检索 不同分类下热门的专辑列表 搜索词自动补全  1、检索业务介绍   1. 根据用户输入的检索条件，查询出对用的商品  - **业务数据**:包含专辑ID、专辑名称、专辑封面、主播名称、专辑声音数量、付费类型、分类ID、统计信息、专辑标签等  - **过">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/yunyueting.png">
<meta property="article:published_time" content="2024-11-10T11:33:21.000Z">
<meta property="article:modified_time" content="2024-11-29T11:33:54.000Z">
<meta property="article:author" content="pz">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/yunyueting.png">
  
  
  
  <title>4-2、专辑检索 - PZ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>PZ</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/null') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="4-2、专辑检索"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-11-10 19:33" pubdate>
          2024年11月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          80 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">4-2、专辑检索</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="第4章-专辑检索"><a href="#第4章-专辑检索" class="headerlink" title="第4章 专辑检索"></a>第4章 专辑检索</h2><p><strong>学习目标：</strong></p>
<ul>
<li>专辑索引库设计（字段、字段类型（<strong>Nested嵌套类型</strong>））</li>
<li>专辑数据到索引库<ul>
<li>全量导入</li>
<li>增量导入</li>
</ul>
</li>
<li>多条件专辑数据检索</li>
<li>不同分类下热门的专辑列表</li>
<li>搜索词自动补全</li>
</ul>
<h1 id="1、检索业务介绍"><a href="#1、检索业务介绍" class="headerlink" title="1、检索业务介绍"></a>1、检索业务介绍</h1><p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/%E6%A3%80%E7%B4%A2-%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![检索-关键字搜索](第4章 专辑检索/检索-关键字搜索.gif)

-->

<pre><code class="hljs">1. 根据用户输入的检索条件，查询出对用的商品
 - **业务数据**:包含专辑ID、专辑名称、专辑封面、主播名称、专辑声音数量、付费类型、分类ID、统计信息、专辑标签等
 - **过滤条件**:关键字、分类、专辑标签等
 - **排序方式:**热门、时间、播放量
</code></pre>
<h2 id="1-1-专辑上架"><a href="#1-1-专辑上架" class="headerlink" title="1.1 专辑上架"></a>1.1 专辑上架</h2><p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/%E6%A3%80%E7%B4%A2-%E4%B8%8A%E6%9E%B6.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![检索-上架](第4章 专辑检索/检索-上架.gif)

-->

<p>需要获取的数据有：</p>
<ol>
<li>获取专辑信息（有）但是需要将其发布到feign 上 给检索微服务使用</li>
<li>根据专辑Id获取专辑属性信息（无）</li>
<li>获取分类信息（无）</li>
<li>获取用户信息（有）但是需要将其发布到feign上</li>
</ol>
<h3 id="1-1-1-封装实体类"><a href="#1-1-1-封装实体类" class="headerlink" title="1.1.1 封装实体类"></a>1.1.1 封装实体类</h3><p>商品上架，下架信息存在不同的数据库表中，所以我们将商品的上架-下架的字段统一封装到实体类中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(indexName = &quot;albuminfo&quot;)</span><br><span class="hljs-meta">@JsonIgnoreProperties(ignoreUnknown = true)</span><span class="hljs-comment">//目的：防止json字符串转成实体对象时因未识别字段报错</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlbumInfoIndex</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">// 专辑Id</span><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">//  es 中能分词的字段，这个字段数据类型必须是 text！keyword 不分词！ analyzer = &quot;ik_max_word&quot;</span><br>    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br>    <span class="hljs-keyword">private</span> String albumTitle;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br>    <span class="hljs-keyword">private</span> String albumIntro;<br>    <br>    <span class="hljs-comment">//  主播名称</span><br>    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String announcerName;<br><br>    <span class="hljs-comment">//专辑封面</span><br>    <span class="hljs-meta">@Field(type = FieldType.Keyword, index = false)</span><br>    <span class="hljs-keyword">private</span> String coverUrl;<br><br>    <span class="hljs-comment">//专辑包含声音总数</span><br>    <span class="hljs-meta">@Field(type = FieldType.Long, index = false)</span><br>    <span class="hljs-keyword">private</span> Integer includeTrackCount;<br><br>    <span class="hljs-comment">//专辑是否完结：0-否；1-完结</span><br>    <span class="hljs-meta">@Field(type = FieldType.Long, index = false)</span><br>    <span class="hljs-keyword">private</span> String isFinished;<br><br>    <span class="hljs-comment">//付费类型：免费、vip免费、付费</span><br>    <span class="hljs-meta">@Field(type = FieldType.Keyword, index = false)</span><br>    <span class="hljs-keyword">private</span> String payType;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Date,format = DateFormat.date_time, pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createTime; <br><br>    <span class="hljs-meta">@Field(type = FieldType.Long)</span><br>    <span class="hljs-keyword">private</span> Long category1Id;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Long)</span><br>    <span class="hljs-keyword">private</span> Long category2Id;<br><br>    <span class="hljs-meta">@Field(type = FieldType.Long)</span><br>    <span class="hljs-keyword">private</span> Long category3Id;<br><br>    <span class="hljs-comment">//播放量</span><br>    <span class="hljs-meta">@Field(type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">playStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//订阅量</span><br>    <span class="hljs-meta">@Field(type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">subscribeStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//购买量</span><br>    <span class="hljs-meta">@Field(type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">buyStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//评论数</span><br>    <span class="hljs-meta">@Field(type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">commentStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//商品的热度！</span><br>    <span class="hljs-meta">@Field(type = FieldType.Double)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Double</span> <span class="hljs-variable">hotScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">0d</span>;<br><br>    <span class="hljs-comment">// 专辑属性值</span><br>    <span class="hljs-comment">// Nested 支持嵌套查询</span><br>    <span class="hljs-meta">@Field(type = FieldType.Nested)</span><br>    <span class="hljs-keyword">private</span> List&lt;AttributeValueIndex&gt; attributeValueIndexList;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="1-1-2-根据专辑Id-获取专辑数据"><a href="#1-1-2-根据专辑Id-获取专辑数据" class="headerlink" title="1.1.2 根据专辑Id 获取专辑数据"></a>1.1.2 根据专辑Id 获取专辑数据</h3><p>AlbumInfoFeignClient根据专辑Id 获取到专辑数据,需要将这个接口发布到feign上.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取专辑信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;api/album/albumInfo/getAlbumInfo/&#123;id&#125;&quot;)</span><br>Result&lt;AlbumInfo&gt; <span class="hljs-title function_">getAlbumInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result&lt;AlbumInfo&gt; <span class="hljs-title function_">getAlbumInfo</span><span class="hljs-params">(Long albumId)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-1-3-根据专辑Id获取专辑属性信息"><a href="#1-1-3-根据专辑Id获取专辑属性信息" class="headerlink" title="1.1.3 根据专辑Id获取专辑属性信息"></a>1.1.3 根据专辑Id获取专辑属性信息</h3><p>service-client	-	service-album-client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 获取专辑属性值列表</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@GetMapping(&quot;api/album/albumInfo/findAlbumAttributeValue/&#123;albumId&#125;&quot;)</span><br>Result&lt;List&lt;AlbumAttributeValue&gt;&gt; <span class="hljs-title function_">findAlbumAttributeValue</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;albumId&quot;)</span> Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<p>AlbumInfoDegradeFeignClient 降级类</p>
<p>注意:</p>
<p><strong>降级</strong>：定义一个 <code>fallback</code> 类（<code>AlbumInfoDegradeFeignClient</code>），当 <code>Feign</code> 客户端请求失败时会调用这个降级方法。</p>
<p><strong>熔断</strong>：熔断器本身会在服务调用失败率超过一定阈值时切断对该服务的请求，避免持续失败。如果需要使用熔断功能，可以结合 <strong>Hystrix</strong> 或 <strong>Resilience4j</strong> 来处理。</p>
<p><strong>反复调用</strong>一个故障的方法就会发生熔断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;AlbumAttributeValue&gt;&gt; <span class="hljs-title function_">findAlbumAttributeValue</span><span class="hljs-params">(Long albumId)</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service-album 中的AlbumInfoApiController控制器添加方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据专辑Id 获取到专辑属性列表</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@Operation(summary = &quot;获取专辑属性值列表&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;findAlbumAttributeValue/&#123;albumId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;AlbumAttributeValue&gt;&gt; <span class="hljs-title function_">findAlbumAttributeValue</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long albumId)</span> &#123;<br>  <span class="hljs-comment">//	获取到专辑属性集合</span><br>  List&lt;AlbumAttributeValue&gt; albumAttributeValueList = albumInfoService.findAlbumAttributeValueByAlbumId(albumId);<br>  <span class="hljs-keyword">return</span> Result.ok(albumAttributeValueList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 根据专辑Id 获取到专辑属性列表</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br>List&lt;AlbumAttributeValue&gt; <span class="hljs-title function_">findAlbumAttributeValueByAlbumId</span><span class="hljs-params">(Long albumId)</span><br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;AlbumAttributeValue&gt; <span class="hljs-title function_">findAlbumAttributeValueByAlbumId</span><span class="hljs-params">(Long albumId)</span> &#123;<br>LambdaQueryWrapper&lt;AlbumAttributeValue&gt; lambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>lambdaQueryWrapper.eq(AlbumAttributeValue::getAlbumId,albumId);<br>  List&lt;AlbumAttributeValue&gt; albumAttributeValueList = albumAttributeValueMapper.selectList(lambdaQueryWrapper);<br>  <span class="hljs-comment">//	返回集合数据</span><br>  <span class="hljs-keyword">return</span> albumAttributeValueList;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="1-1-4-根据三级分类Id查询分类数据"><a href="#1-1-4-根据三级分类Id查询分类数据" class="headerlink" title="1.1.4 根据三级分类Id查询分类数据"></a>1.1.4 根据三级分类Id查询分类数据</h3><p>远程调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;service-album&quot;, fallback = CategoryDegradeFeignClient.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CategoryFeignClient</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据三级分类Id 获取到分类数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> category3Id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;api/album/category/getCategoryView/&#123;category3Id&#125;&quot;)</span><br>    Result&lt;BaseCategoryView&gt; <span class="hljs-title function_">getCategoryView</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long category3Id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>熔断类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CategoryDegradeFeignClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CategoryFeignClient</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result&lt;BaseCategoryView&gt; <span class="hljs-title function_">getCategoryView</span><span class="hljs-params">(Long category3Id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在BaseCategoryApiController 控制器中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据三级分类Id 获取到分类信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> category3Id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;通过三级分类id查询分类信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;getCategoryView/&#123;category3Id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;BaseCategoryView&gt; <span class="hljs-title function_">getCategoryView</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long category3Id)</span>&#123;<br>   <span class="hljs-comment">// 调用服务层方法</span><br>   <span class="hljs-type">BaseCategoryView</span> <span class="hljs-variable">baseCategoryView</span> <span class="hljs-operator">=</span> baseCategoryService.getCategoryViewByCategory3Id(category3Id);<br>   <span class="hljs-keyword">return</span> Result.ok(baseCategoryView);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据三级分类Id 查询分类数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> category3Id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>BaseCategoryView <span class="hljs-title function_">getCategoryViewByCategory3Id</span><span class="hljs-params">(Long category3Id)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> BaseCategoryView <span class="hljs-title function_">getCategoryViewByCategory3Id</span><span class="hljs-params">(Long category3Id)</span> &#123;<br>   <span class="hljs-keyword">return</span> baseCategoryViewMapper.selectById(category3Id);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="1-1-5-根据用户Id-获取到用户信息"><a href="#1-1-5-根据用户Id-获取到用户信息" class="headerlink" title="1.1.5 根据用户Id 获取到用户信息."></a>1.1.5 根据用户Id 获取到用户信息.</h3><p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据用户Id获取用户信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;根据用户id获取用户信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;getUserInfoVo/&#123;userId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;UserInfoVo&gt; <span class="hljs-title function_">getUserInfoVo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> &#123;<br>   <span class="hljs-comment">// 获取用户信息</span><br>   <span class="hljs-type">UserInfoVo</span> <span class="hljs-variable">userInfoVo</span> <span class="hljs-operator">=</span> userInfoService.getUserInfoVoByUserId(userId);<br>   <span class="hljs-keyword">return</span> Result.ok(userInfoVo);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>远程调用接口与熔断类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据userId 获取到用户信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;api/user/userInfo/getUserInfoVo/&#123;userId&#125;&quot;)</span><br>Result&lt;UserInfoVo&gt; <span class="hljs-title function_">getUserInfoVo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result&lt;UserInfoVo&gt; <span class="hljs-title function_">getUserInfoVo</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-1-6-专辑上架"><a href="#1-1-6-专辑上架" class="headerlink" title="1.1.6 专辑上架"></a>1.1.6 专辑上架</h3><h4 id="1-1-6-1-控制器"><a href="#1-1-6-1-控制器" class="headerlink" title="1..1.6.1 控制器"></a>1..1.6.1 控制器</h4><p>SearchApiController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 上架专辑</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@Operation(summary = &quot;上架专辑&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/upperAlbum/&#123;albumId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">upperAlbum</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long albumId)</span>&#123;<br>  <span class="hljs-comment">//  调用服务层方法.</span><br>  <span class="hljs-built_in">this</span>.searchService.upperAlbum(albumId);<br>  <span class="hljs-comment">//  默认返回</span><br>  <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-1-2-接口与实现"><a href="#1-6-1-2-接口与实现" class="headerlink" title="1.6.1.2 接口与实现"></a>1.6.1.2 接口与实现</h4><p>SearchService 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 上架专辑</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">upperAlbum</span><span class="hljs-params">(Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<p>SearchServiceImpl 实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> AlbumIndexRepository albumIndexRepository;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">upperAlbum</span><span class="hljs-params">(Long albumId)</span> &#123;<br>  <span class="hljs-comment">//  获取专辑信息</span><br>  Result&lt;AlbumInfo&gt; albumInfoResult = albumInfoFeignClient.getAlbumInfo(albumId);<br>  <span class="hljs-type">AlbumInfo</span> <span class="hljs-variable">albumInfo</span> <span class="hljs-operator">=</span> albumInfoResult.getData();<br>  Assert.notNull(albumInfo,<span class="hljs-string">&quot;专辑为空&quot;</span>);<br>    <br>  <span class="hljs-comment">//  获取专辑属性信息</span><br>  Result&lt;List&lt;AlbumAttributeValue&gt;&gt; albumAttributeValueResult = albumInfoFeignClient.findAlbumAttributeValue(albumId);<br>  List&lt;AlbumAttributeValue&gt; albumAttributeValueList = albumAttributeValueResult.getData();<br>  Assert.notNull(albumAttributeValueList,<span class="hljs-string">&quot;专辑属性为空&quot;</span>);<br>    <br>  <span class="hljs-comment">//  根据三级分类Id 获取到分类数据</span><br>  Result&lt;BaseCategoryView&gt; baseCategoryViewResult = categoryFeignClient.getCategoryView(albumInfo.getCategory3Id());<br>  <span class="hljs-type">BaseCategoryView</span> <span class="hljs-variable">baseCategoryView</span> <span class="hljs-operator">=</span> baseCategoryViewResult.getData();<br>  Assert.notNull(baseCategoryView,<span class="hljs-string">&quot;分类为空&quot;</span>);<br>    <br>  <span class="hljs-comment">//  根据用户Id 获取到用户信息</span><br>  Result&lt;UserInfoVo&gt; userInfoVoResult = userInfoFeignClient.getUserInfoVo(albumInfo.getUserId());<br>  <span class="hljs-type">UserInfoVo</span> <span class="hljs-variable">userInfoVo</span> <span class="hljs-operator">=</span> userInfoVoResult.getData();<br>  Assert.notNull(userInfoVo,<span class="hljs-string">&quot;用户信息为空&quot;</span>);<br><br>  <span class="hljs-comment">//  创建索引库对象</span><br>  <span class="hljs-type">AlbumInfoIndex</span> <span class="hljs-variable">albumInfoIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlbumInfoIndex</span>();<br>  BeanUtils.copyProperties(albumInfo,albumInfoIndex);<br><br>  <span class="hljs-comment">//  赋值属性值信息</span><br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(albumAttributeValueList))&#123;<br>    List&lt;AttributeValueIndex&gt; attributeValueIndexList = albumAttributeValueList.stream().map(albumAttributeValue -&gt; &#123;<br>      <span class="hljs-type">AttributeValueIndex</span> <span class="hljs-variable">attributeValueIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttributeValueIndex</span>();<br>      BeanUtils.copyProperties(albumAttributeValue, attributeValueIndex);<br>      <span class="hljs-keyword">return</span> attributeValueIndex;<br>    &#125;).collect(Collectors.toList());<br>      <br>    <span class="hljs-comment">//  保存数据</span><br>    albumInfoIndex.setAttributeValueIndexList(attributeValueIndexList);<br>  &#125;<br>    <br>  <span class="hljs-comment">//  赋值分类数据</span><br>  albumInfoIndex.setCategory1Id(baseCategoryView.getCategory1Id());<br>  albumInfoIndex.setCategory2Id(baseCategoryView.getCategory2Id());<br>  albumInfoIndex.setCategory3Id(baseCategoryView.getCategory3Id());<br>    <br>  <span class="hljs-comment">//  赋值主播名称</span><br>  albumInfoIndex.setAnnouncerName(userInfoVo.getNickname());<br>  <br>  <span class="hljs-comment">//更新统计量与得分，默认随机，方便测试</span><br>  <span class="hljs-type">int</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">1000</span>);<br>  <span class="hljs-type">int</span> <span class="hljs-variable">num2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100</span>);<br>  <span class="hljs-type">int</span> <span class="hljs-variable">num3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">50</span>);<br>  <span class="hljs-type">int</span> <span class="hljs-variable">num4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">300</span>);<br>  albumInfoIndex.setPlayStatNum(num1);<br>  albumInfoIndex.setSubscribeStatNum(num2);<br>  albumInfoIndex.setBuyStatNum(num3);<br>  albumInfoIndex.setCommentStatNum(num4);<br>  <span class="hljs-type">double</span> <span class="hljs-variable">hotScore</span> <span class="hljs-operator">=</span> num1*<span class="hljs-number">0.2</span> + num2*<span class="hljs-number">0.3</span> + num3*<span class="hljs-number">0.4</span> + num4*<span class="hljs-number">0.1</span>;<br>  <span class="hljs-comment">//  设置热度排名</span><br>  albumInfoIndex.setHotScore(hotScore);<br>  <span class="hljs-comment">//  保存商品上架信息</span><br>  albumIndexRepository.save(albumInfoIndex);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建操作es索引库的对象</p>
<p>service&#x2F;service-search&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;tingshu&#x2F;search&#x2F;repository&#x2F;AlbumIndexRepository.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> AlbumIndexRepository</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span>: 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AlbumIndexRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;AlbumInfoIndex,Long&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-1-6-3-异步任务-线程池优化"><a href="#1-1-6-3-异步任务-线程池优化" class="headerlink" title="1.1.6.3 异步任务+线程池优化"></a>1.1.6.3 异步任务+线程池优化</h4><p>CompletableFuture异步编排类:  可以创建多线程去执行任务并获取到线程的执行结果！</p>
<p>在Java 8中 CompletableFuture ，提供了非常强大的Future的扩展功能，可以帮助我们简化异步编程的复杂性，提供了函数式编程的能力，可以通过回调的方式处理计算结果，并且提供了转换和组合CompletableFuture的方法。</p>
<p> 创建异步对象：</p>
<blockquote>
<ul>
<li>runAsync方法不支持返回值</li>
<li>supplyAsync可以支持返回值</li>
</ul>
</blockquote>
<p>代码案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-comment">//  无返回值</span><br>        CompletableFuture&lt;Void&gt; completableFuture = CompletableFuture.runAsync(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;我是无返回值的线程&quot;</span>);<br>        &#125;);<br>        System.out.println(completableFuture.get());<br>        <span class="hljs-comment">//  有返回值</span><br>        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-number">1024</span>);<br>        System.out.println(future.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>计算完成时回调方法:</p>
<blockquote>
<ul>
<li>whenComplete：是执行当前任务的线程执行继续执行 whenComplete 的任务。</li>
<li>whenCompleteAsync：是执行把 whenCompleteAsync 这个任务继续提交给线程池来进行执行</li>
<li>exceptionally处理异常情况。BiConsumer&lt;? super T,? super Throwable&gt;可以定义处理业务</li>
</ul>
</blockquote>
<p>代码案例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1024</span>;<br>        &#125;).whenComplete((t, s) -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;t:\t&quot;</span>+t);<br>            System.out.println(<span class="hljs-string">&quot;s:\t&quot;</span>+s);<br>        &#125;).exceptionally(e-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;e:\t&quot;</span>+e);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">404</span>;<br>        &#125;);<br>        System.out.println(future.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>线程串行化与并行化方法:</p>
<blockquote>
<ul>
<li>thenApply 方法：当一个线程依赖另一个线程时，获取上一个任务返回的结果，并返回当前任务的返回值。</li>
<li>thenAccept方法：消费处理结果。接收任务的处理结果，并消费处理，无返回结果。</li>
</ul>
</blockquote>
<p>串行化:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>            <span class="hljs-comment">//  int i = 1 / 0;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1024</span>;<br>        &#125;).thenApply(f -&gt; &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * f;<br>        &#125;).whenComplete((t, s) -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;t:\t&quot;</span> + t);<br>            System.out.println(<span class="hljs-string">&quot;s:\t&quot;</span> + s);<br>        &#125;).exceptionally(e -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;e:\t&quot;</span> + e);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">404</span>;<br>        &#125;);<br>        System.out.println(future.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>并行化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-comment">// 线程1执行返回的结果：hello</span><br>        CompletableFuture&lt;String&gt; futureA = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">&quot;hello&quot;</span>);<br><br>        <span class="hljs-comment">// 线程2 获取到线程1执行的结果</span><br>        CompletableFuture&lt;Void&gt; futureB = futureA.thenAcceptAsync((s) -&gt; &#123;<br>            delaySec(<span class="hljs-number">3</span>);<br>            printCurrTime(s + <span class="hljs-string">&quot; 第一个线程&quot;</span>);<br>        &#125;);<br><br>        CompletableFuture&lt;Void&gt; futureC = futureA.thenAcceptAsync((s) -&gt; &#123;<br>            delaySec(<span class="hljs-number">1</span>);<br>            printCurrTime(s + <span class="hljs-string">&quot; 第二个线程&quot;</span>);<br>        &#125;);<br><br>        System.out.println(futureB.get());<br>        System.out.println(futureC.get());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printCurrTime</span><span class="hljs-params">(String str)</span> &#123;<br>        System.out.println(str);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delaySec</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(i * <span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>多任务组合:</p>
<blockquote>
<ul>
<li>allOf：等待所有任务完成</li>
<li>anyOf：只要有一个任务完成</li>
</ul>
</blockquote>
<p>代码案例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-comment">//1.创建异步任务对象 CompletableFuture  A任务需要返回值</span><br>        CompletableFuture&lt;Long&gt; futureA = CompletableFuture.supplyAsync(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">10</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;A任务执行&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">10L</span>;<br>        &#125;);<br><br>        <span class="hljs-comment">//2.基于上面对象 构建 B任务对象</span><br>        CompletableFuture&lt;String&gt; futureB = futureA.thenApplyAsync((aResult) -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">5000</span>);<br>                System.out.println(<span class="hljs-string">&quot;B任务执行&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;);<br><br><br>        <span class="hljs-comment">//3.基于上面对象 构建 C任务对象</span><br>        CompletableFuture&lt;String&gt; futureC = futureA.thenApplyAsync((aResult) -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">11</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;C任务执行&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;);<br><br>        <span class="hljs-comment">//  CompletableFuture.anyOf(futureA, futureB, futureC).join();</span><br>        CompletableFuture.allOf(futureA, futureB, futureC).join();<br>        System.out.println(<span class="hljs-string">&quot;执行后续业务代码&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>代码优化</strong></p>
<p>创建线程池：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.search.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ArrayBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.ThreadPoolExecutor;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ThreadPoolExecutorConfig</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span>: TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span>: 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExecutorConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ThreadPoolExecutor <span class="hljs-title function_">threadPoolExecutor</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//  创建线程池--自定义线程池.</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<br>                <span class="hljs-number">8</span>,<br>                <span class="hljs-number">16</span>,<br>                <span class="hljs-number">3</span>,<br>                TimeUnit.SECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>)<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">upperAlbum</span><span class="hljs-params">(Long albumId)</span> &#123;<br>  <span class="hljs-comment">//  本质：将数据保存到es、 数据载体：AlbumInfoIndex   es</span><br>  <span class="hljs-comment">//  1.专辑基本信息 2.专辑属性信息 3.专辑分类信息 --专辑微服务提供数据:  4.用户信息</span><br>  <span class="hljs-type">AlbumInfoIndex</span> <span class="hljs-variable">albumInfoIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlbumInfoIndex</span>();<br>  <span class="hljs-comment">//  多线程：</span><br>  CompletableFuture&lt;AlbumInfo&gt; albumInfoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    Result&lt;AlbumInfo&gt; albumInfoResult = albumInfoFeignClient.getAlbumInfo(albumId);<br>    <span class="hljs-comment">//  判断</span><br>    Assert.notNull(albumInfoResult, <span class="hljs-string">&quot;专辑返回结果为空&quot;</span>);<br>    <span class="hljs-type">AlbumInfo</span> <span class="hljs-variable">albumInfo</span> <span class="hljs-operator">=</span> albumInfoResult.getData();<br>    Assert.notNull(albumInfo, <span class="hljs-string">&quot;专辑为空&quot;</span>);<br>    <span class="hljs-comment">//  赋值：</span><br>    <span class="hljs-comment">//  处理专辑信息，属性拷贝：属性必须一致.</span><br>    BeanUtils.copyProperties(albumInfo, albumInfoIndex);<br>    <span class="hljs-keyword">return</span> albumInfo;<br>  &#125;, threadPoolExecutor);<br><br>  <span class="hljs-comment">//  获取属性标签</span><br>  CompletableFuture&lt;Void&gt; attributeCompletableFuture = CompletableFuture.runAsync(() -&gt; &#123;<br>    Result&lt;List&lt;AlbumAttributeValue&gt;&gt; albumAttributeValueResult = albumInfoFeignClient.findAlbumAttributeValue(albumId);<br>    <span class="hljs-comment">//  判断</span><br>    Assert.notNull(albumAttributeValueResult, <span class="hljs-string">&quot;专辑属性结果集为空&quot;</span>);<br>    List&lt;AlbumAttributeValue&gt; albumAttributeValueList = albumAttributeValueResult.getData();<br>    Assert.notNull(albumAttributeValueList, <span class="hljs-string">&quot;专辑属性为空&quot;</span>);<br>    <span class="hljs-comment">//  想不到... 循环遍历获取数据，同时返回一个新的集合。map stream 对应的泛型：就是集合的泛型.</span><br>    List&lt;AttributeValueIndex&gt; attributeValueList = albumAttributeValueList.stream().map(albumAttributeValue -&gt; &#123;<br>      <span class="hljs-comment">//  创建对象 AttributeValueIndex</span><br>      <span class="hljs-type">AttributeValueIndex</span> <span class="hljs-variable">attributeValueIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttributeValueIndex</span>();<br>      <span class="hljs-comment">//  赋值：</span><br>      <span class="hljs-comment">//            attributeValueIndex.setAttributeId(albumAttributeValue.getAttributeId());</span><br>      <span class="hljs-comment">//            attributeValueIndex.setValueId(albumAttributeValue.getValueId());</span><br>      BeanUtils.copyProperties(albumAttributeValue, attributeValueIndex);<br>      <span class="hljs-comment">//  返回</span><br>      <span class="hljs-keyword">return</span> attributeValueIndex;<br>    &#125;).collect(Collectors.toList());<br>    <span class="hljs-comment">//  给属性赋值：</span><br>    albumInfoIndex.setAttributeValueIndexList(attributeValueList);<br><br>  &#125;, threadPoolExecutor);<br>  <span class="hljs-comment">//  包含一级分类，二级分类，三级分类; 查询base_category_view 数据</span><br>  CompletableFuture&lt;Void&gt; categoryCompletableFuture = albumInfoCompletableFuture.thenAcceptAsync(albumInfo -&gt; &#123;<br>    Result&lt;BaseCategoryView&gt; baseCategoryViewResult = categoryFeignClient.getCategoryView(albumInfo.getCategory3Id());<br><br>    Assert.notNull(baseCategoryViewResult, <span class="hljs-string">&quot;专辑分类结果集为空&quot;</span>);<br>    <span class="hljs-type">BaseCategoryView</span> <span class="hljs-variable">baseCategoryView</span> <span class="hljs-operator">=</span> baseCategoryViewResult.getData();<br>    Assert.notNull(baseCategoryView, <span class="hljs-string">&quot;专辑分类为空&quot;</span>);<br>    <span class="hljs-comment">//  赋值分类数据</span><br>    albumInfoIndex.setCategory1Id(baseCategoryView.getCategory1Id());<br>    albumInfoIndex.setCategory2Id(baseCategoryView.getCategory2Id());<br>    albumInfoIndex.setCategory3Id(baseCategoryView.getCategory3Id());<br>  &#125;, threadPoolExecutor);<br><br>  <span class="hljs-comment">//        Result&lt;UserInfo&gt; userInfoResult = userInfoFeignClient.getUserInfoVo(albumInfo.getUserId());</span><br>  CompletableFuture&lt;Void&gt; userCompletableFuture = albumInfoCompletableFuture.thenAcceptAsync(albumInfo -&gt; &#123;<br>    Result&lt;UserInfoVo&gt; userInfoResult = userInfoFeignClient.getUserInfoVo(albumInfo.getUserId());<br>    Assert.notNull(userInfoResult, <span class="hljs-string">&quot;用户结果集为空&quot;</span>);<br>    <span class="hljs-type">UserInfoVo</span> <span class="hljs-variable">userInfoVo</span> <span class="hljs-operator">=</span> userInfoResult.getData();<br>    Assert.notNull(userInfoVo, <span class="hljs-string">&quot;用户为空&quot;</span>);<br><br>    <span class="hljs-comment">//  赋值主播</span><br>    albumInfoIndex.setAnnouncerName(userInfoVo.getNickname());<br>  &#125;, threadPoolExecutor);<br>  <span class="hljs-comment">//  赋值：初始化统计信息</span><br>  <span class="hljs-type">int</span> <span class="hljs-variable">playStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000</span>);<br>  <span class="hljs-type">int</span> <span class="hljs-variable">subscribeStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">100000000</span>);<br>  <span class="hljs-type">int</span> <span class="hljs-variable">buyStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">10000000</span>);<br>  <span class="hljs-type">int</span> <span class="hljs-variable">commentStatNum</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">1000000000</span>);<br>  albumInfoIndex.setPlayStatNum(playStatNum);<br>  albumInfoIndex.setSubscribeStatNum(subscribeStatNum);<br>  albumInfoIndex.setBuyStatNum(buyStatNum);<br>  albumInfoIndex.setCommentStatNum(commentStatNum);<br>  <span class="hljs-comment">//  热度排名：默认是0；</span><br>  <span class="hljs-comment">//  albumInfoIndex.setHotScore();</span><br>  <span class="hljs-comment">//  进行多任务组合：</span><br>  CompletableFuture.allOf(<br>    albumInfoCompletableFuture,<br>    categoryCompletableFuture,<br>    attributeCompletableFuture,<br>    userCompletableFuture).join();<br>  <span class="hljs-comment">//  保存albumInfoIndex到es！ 必须先有索引库. -- 使用内置类，在启动项目的时候，会根据AlbumInfoIndex.class 中定义的数据类型与索引库名称，自动创建.</span><br>  goodsRepository.save(albumInfoIndex);<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="1-2-专辑下架"><a href="#1-2-专辑下架" class="headerlink" title="1.2 专辑下架"></a>1.2 专辑下架</h2><p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/%E6%A3%80%E7%B4%A2-%E4%B8%8B%E6%9E%B6.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![检索-下架](第4章 专辑检索/检索-下架.gif)

-->

<h3 id="1-2-1-控制器"><a href="#1-2-1-控制器" class="headerlink" title="1.2.1 控制器"></a>1.2.1 控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 下架专辑</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@Operation(summary = &quot;下架专辑&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;lowerAlbum/&#123;albumId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">lowerAlbum</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long albumId)</span> &#123;<br>  searchService.lowerAlbum(albumId);<br>  <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-2-2-接口与实现"><a href="#1-2-2-接口与实现" class="headerlink" title="1.2.2 接口与实现"></a>1.2.2 接口与实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 下架专辑</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">lowerAblum</span><span class="hljs-params">(Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lowerAblum</span><span class="hljs-params">(Long albumId)</span> &#123;<br>  albumIndexRepository.deleteById(albumId);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过这个url <a target="_blank" rel="noopener" href="http://localhost:8502/doc.html">http://localhost:8502/doc.html</a> 进行测试！</p>
<h2 id="1-3、利用mq实现专辑自动上架-下架"><a href="#1-3、利用mq实现专辑自动上架-下架" class="headerlink" title="1.3、利用mq实现专辑自动上架-下架"></a>1.3、利用mq实现专辑自动上架-下架</h2><h3 id="1-3-1-上架-发送消息"><a href="#1-3-1-上架-发送消息" class="headerlink" title="1.3.1 上架-发送消息"></a>1.3.1 上架-发送消息</h3><h4 id="1-3-1-1-保存专辑"><a href="#1-3-1-1-保存专辑" class="headerlink" title="1.3.1.1 保存专辑"></a>1.3.1.1 保存专辑</h4><p>service&#x2F;service-album&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;yunyueting&#x2F;album&#x2F;service&#x2F;impl&#x2F;AlbumInfoServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//	发送上架消息</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(albumInfo.getIsOpen()))&#123;<br>  rabbitService.sendMessage(MqConst.EXCHANGE_ALBUM, MqConst.ROUTING_ALBUM_UPPER, albumInfo.getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-3-1-2-更新专辑"><a href="#1-3-1-2-更新专辑" class="headerlink" title="1.3.1.2 更新专辑"></a>1.3.1.2 更新专辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateAlbumInfo</span><span class="hljs-params">(Long id, AlbumInfoVo albumInfoVo)</span> &#123;<br>  <span class="hljs-type">AlbumInfo</span> <span class="hljs-variable">albumInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(id);<br>  BeanUtils.copyProperties(albumInfoVo, albumInfo);<br>  <span class="hljs-comment">//	根据id 修改数据</span><br>  <span class="hljs-built_in">this</span>.updateById(albumInfo);<br><br>  <span class="hljs-comment">//	先删除专辑属性数据</span><br>  albumAttributeValueMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;AlbumAttributeValue&gt;().eq(AlbumAttributeValue::getAlbumId,id));<br><br>  <span class="hljs-comment">//	保存专辑属性数据</span><br>  List&lt;AlbumAttributeValueVo&gt; albumAttributeValueVoList = albumInfoVo.getAlbumAttributeValueVoList();<br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(albumAttributeValueVoList))&#123;<br>    albumAttributeValueVoList.forEach(albumAttributeValueVo -&gt; &#123;<br>      <span class="hljs-comment">//	创建专辑属性对象</span><br>      <span class="hljs-type">AlbumAttributeValue</span> <span class="hljs-variable">albumAttributeValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlbumAttributeValue</span>();<br>      <span class="hljs-comment">//	进行数据拷贝</span><br>      BeanUtils.copyProperties(albumAttributeValueVo,albumAttributeValue);<br>      <span class="hljs-comment">//	赋值专辑属性Id</span><br>      albumAttributeValue.setAlbumId(id);<br>      albumAttributeValueMapper.insert(albumAttributeValue);<br>    &#125;);<br>  &#125;<br>  <span class="hljs-comment">//	更新上架下架</span><br>  <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;1&quot;</span>.equals(albumInfo.getIsOpen())) &#123;<br>   rabbitService.sendMessage(MqConst.EXCHANGE_ALBUM, MqConst.ROUTING_ALBUM_UPPER, albumInfo.getId());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    rabbitService.sendMessage(MqConst.EXCHANGE_ALBUM, MqConst.ROUTING_ALBUM_LOWER, albumInfo.getId());<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-2-下架-发送消息"><a href="#1-3-2-下架-发送消息" class="headerlink" title="1.3.2 下架-发送消息"></a>1.3.2 下架-发送消息</h3><h4 id="1-3-2-1-删除专辑"><a href="#1-3-2-1-删除专辑" class="headerlink" title="1.3.2.1 删除专辑"></a>1.3.2.1 删除专辑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAlbumInfoById</span><span class="hljs-params">(Long id)</span> &#123;<br>  <span class="hljs-comment">//	删除专辑表的数据 album_info</span><br>  <span class="hljs-built_in">this</span>.removeById(id);<br>  <span class="hljs-comment">//	删除专辑属性信息</span><br>  albumAttributeValueMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;AlbumAttributeValue&gt;().eq(AlbumAttributeValue::getAlbumId,id));<br>  <span class="hljs-comment">//	删除专辑对应的统计数据</span><br>  albumStatMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;AlbumStat&gt;().eq(AlbumStat::getAlbumId,id));<br>  <span class="hljs-comment">//下架</span><br>  rabbitService.sendMessage(MqConst.EXCHANGE_ALBUM, MqConst.ROUTING_ALBUM_LOWER, albumInfo.getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-3-监听消息"><a href="#1-3-3-监听消息" class="headerlink" title="1.3.3 监听消息"></a>1.3.3 监听消息</h3><p>在service-search微服务中添加监听方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.search.receiver;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.rabbit.constant.MqConst;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.search.service.SearchService;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><span class="hljs-keyword">import</span> lombok.SneakyThrows;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchReceiver</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SearchService searchService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 专辑上架</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            exchange = @Exchange(value = MqConst.EXCHANGE_ALBUM, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            value = @Queue(value = MqConst.QUEUE_ALBUM_UPPER, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            key = &#123;MqConst.ROUTING_ALBUM_UPPER&#125;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">upperGoods</span><span class="hljs-params">(Long albumId, Message message, Channel channel)</span> &#123;<br>        <span class="hljs-comment">//业务处理</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != albumId) &#123;<br>            searchService.upperAlbum(albumId);<br>        &#125;<br><br>        <span class="hljs-comment">//手动应答</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 专辑下架</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            exchange = @Exchange(value = MqConst.EXCHANGE_ALBUM, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            value = @Queue(value = MqConst.QUEUE_ALBUM_LOWER, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            key = &#123;MqConst.ROUTING_ALBUM_LOWER&#125;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lowerGoods</span><span class="hljs-params">(Long albumId, Message message, Channel channel)</span> &#123;<br>        <span class="hljs-comment">//业务处理</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != albumId) &#123;<br>            searchService.lowerAlbum(albumId);<br>        &#125;<br><br>        <span class="hljs-comment">//手动应答</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-4-批量上传专辑"><a href="#1-3-4-批量上传专辑" class="headerlink" title="1.3.4 批量上传专辑"></a>1.3.4 批量上传专辑</h3><p>SearchApiController </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量上架</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;批量上架&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;batchUpperAlbum&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">batchUpperAlbum</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">//  循环</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">1500</span>; i++) &#123;<br>        searchService.upperAlbum(i);<br>    &#125;<br>    <span class="hljs-comment">//  返回数据</span><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="2、专辑检索"><a href="#2、专辑检索" class="headerlink" title="2、专辑检索"></a>2、专辑检索</h1><h2 id="2-1-根据关键词检索"><a href="#2-1-根据关键词检索" class="headerlink" title="2.1 根据关键词检索"></a>2.1 根据关键词检索</h2><p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/%E6%A3%80%E7%B4%A2-%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2-17055730237394.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![检索-关键字搜索](第4章 专辑检索/检索-关键字搜索-17055730237394.gif)

-->

<h3 id="2-1-1-封装检索条件"><a href="#2-1-1-封装检索条件" class="headerlink" title="2.1.1 封装检索条件"></a>2.1.1 封装检索条件</h3><p>根据用户可能根据不同的检索条件检索数据，所以将用户可能输入的检索条件封装到一个实体对象中 <strong>AlbumIndexQuery</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Schema(description = &quot;专辑信息搜索&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlbumIndexQuery</span> &#123;<br><br>   <span class="hljs-meta">@Schema(description = &quot;关键字&quot;)</span><br>   <span class="hljs-keyword">private</span> String keyword;<br><br>   <span class="hljs-meta">@Schema(description = &quot;一级分类&quot;)</span><br>   <span class="hljs-keyword">private</span> Long category1Id;<br><br>   <span class="hljs-meta">@Schema(description = &quot;二级分类&quot;)</span><br>   <span class="hljs-keyword">private</span> Long category2Id;<br><br>   <span class="hljs-meta">@Schema(description = &quot;三级分类&quot;)</span><br>   <span class="hljs-keyword">private</span> Long category3Id;<br><br>   <span class="hljs-meta">@Schema(description = &quot;属性（属性id:属性值id）&quot;)</span><br>   <span class="hljs-keyword">private</span> List&lt;String&gt; attributeList;<br><br>   <span class="hljs-comment">// order=1:asc  排序规则   0:asc</span><br>   <span class="hljs-meta">@Schema(description = &quot;排序（综合排序[1:desc] 播放量[2:desc] 发布时间[3:desc]；asc:升序 desc:降序）&quot;)</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<span class="hljs-comment">// 1：综合排序 2：播放量 3：最近更新</span><br><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<span class="hljs-comment">//分页信息</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-1-2-封装返回结果集"><a href="#2-1-2-封装返回结果集" class="headerlink" title="2.1.2 封装返回结果集"></a>2.1.2 封装返回结果集</h3><p>将检索的结果统一封装到一个实体类便于显示检索内容 <strong>AlbumSearchResponseVo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlbumSearchResponseVo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//检索出来的专辑信息</span><br>    <span class="hljs-keyword">private</span> List&lt;AlbumInfoIndexVo&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> Long total;<span class="hljs-comment">//总记录数</span><br>    <span class="hljs-keyword">private</span> Integer pageSize;<span class="hljs-comment">//每页显示的内容</span><br>    <span class="hljs-keyword">private</span> Integer pageNo;<span class="hljs-comment">//当前页面</span><br>    <span class="hljs-keyword">private</span> Long totalPages;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-1-3-检索功能实现"><a href="#2-1-3-检索功能实现" class="headerlink" title="2.1.3 检索功能实现"></a>2.1.3 检索功能实现</h3><p>根据检索条件编写静态dsl语句</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs json"># 根据关键词与分类属性Id 过滤<br>GET /albuminfo/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;should&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;albumTitle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小说&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;albumIntro&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小说&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;category3Id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1152&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># 根据属性与属性值Id 进行过滤<br>GET /albuminfo/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;nested&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;attributeValueIndexList&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;must&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                  <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;attributeValueIndexList.attributeId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15&quot;</span><br>                      <span class="hljs-punctuation">&#125;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                  <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                      <span class="hljs-attr">&quot;attributeValueIndexList.valueId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;32&quot;</span><br>                      <span class="hljs-punctuation">&#125;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                  <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">]</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># 分页-排序-高亮<br>GET /albuminfo/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;albumTitle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小说&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;from&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;playStatNum&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;desc&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;highlight&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;albumTitle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;pre_tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;post_tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;&lt;/font&gt;&quot;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h4 id="2-1-3-1-控制器"><a href="#2-1-3-1-控制器" class="headerlink" title="2.1.3.1 控制器"></a>2.1.3.1 控制器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据关键词检索</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumIndexQuery</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@Operation(summary = &quot;专辑搜索列表&quot;)</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AlbumIndexQuery albumIndexQuery)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>  <span class="hljs-comment">//  调用服务层方法.</span><br>  <span class="hljs-type">AlbumSearchResponseVo</span> <span class="hljs-variable">albumSearchResponseVo</span> <span class="hljs-operator">=</span> searchService.search(albumIndexQuery);<br>  <span class="hljs-keyword">return</span> Result.ok(albumSearchResponseVo);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-1-3-2-接口与实现"><a href="#2-1-3-2-接口与实现" class="headerlink" title="2.1.3.2 接口与实现"></a>2.1.3.2 接口与实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据关键词检索</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumIndexQuery</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br>AlbumSearchResponseVo <span class="hljs-title function_">search</span><span class="hljs-params">(AlbumIndexQuery albumIndexQuery)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ElasticsearchClient elasticsearchClient;<br><br><span class="hljs-keyword">public</span> AlbumSearchResponseVo <span class="hljs-title function_">search</span><span class="hljs-params">(AlbumIndexQuery albumIndexQuery)</span> &#123;<br>  <span class="hljs-comment">//  构建dsl语句</span><br>  <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.buildQueryDsl(albumIndexQuery);<br>  <span class="hljs-comment">//  调用查询方法</span><br>  SearchResponse&lt;AlbumInfoIndex&gt; response = <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    response = elasticsearchClient.search(request, AlbumInfoIndex.class);<br>  &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>  &#125;<br>  <span class="hljs-comment">//  得到返回的结果集</span><br>  <span class="hljs-type">AlbumSearchResponseVo</span> <span class="hljs-variable">responseVO</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.parseSearchResult(response);<br>  responseVO.setPageSize(albumIndexQuery.getPageSize());<br>  responseVO.setPageNo(albumIndexQuery.getPageNo());<br>  <span class="hljs-comment">// 获取总页数</span><br>  <span class="hljs-type">long</span> <span class="hljs-variable">totalPages</span> <span class="hljs-operator">=</span> (responseVO.getTotal() + albumIndexQuery.getPageSize() - <span class="hljs-number">1</span>) / albumIndexQuery.getPageSize();<br>  responseVO.setTotalPages(totalPages);<br>  <span class="hljs-keyword">return</span> responseVO;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-2-1-动态生成dsl语句"><a href="#2-1-3-2-1-动态生成dsl语句" class="headerlink" title="2.1.3.2.1 动态生成dsl语句"></a>2.1.3.2.1 动态生成dsl语句</h5><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/8.5/installation.html">elastic.co&#x2F;guide&#x2F;en&#x2F;elasticsearch&#x2F;client&#x2F;java-api-client&#x2F;8.5&#x2F;installation.html</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 获取查询请求对象 - 生成 dsl 语句.</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> albumIndexQuery</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">private</span> SearchRequest <span class="hljs-title function_">buildQueryDsl</span><span class="hljs-params">(AlbumIndexQuery albumIndexQuery)</span> &#123;<br>  <span class="hljs-comment">//  检索入口： 关键词</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">keyword</span> <span class="hljs-operator">=</span> albumIndexQuery.getKeyword();<br>  SearchRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">requestBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>.Builder();<br>  <span class="hljs-comment">//  &#123;query - bool &#125;</span><br>  BoolQuery.<span class="hljs-type">Builder</span> <span class="hljs-variable">boolQuery</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoolQuery</span>.Builder();<br>  <span class="hljs-comment">//  &#123;query - bool - should - match&#125;</span><br>  <span class="hljs-comment">//  MatchQuery.Builder matchQuery = new MatchQuery.Builder();</span><br>  <span class="hljs-comment">//  matchQuery.field(&quot;albumTitle&quot;).query(keyword);</span><br>  <span class="hljs-comment">//  boolQuery.should(f-&gt; f.match(matchQuery.build()));</span><br>  <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(keyword)) &#123;<br>    <span class="hljs-comment">//  &#123;query - bool - should - match&#125;</span><br>    boolQuery.should(f -&gt; f.match(s -&gt; s.field(<span class="hljs-string">&quot;albumTitle&quot;</span>).query(keyword)));<br>    boolQuery.should(f -&gt; f.match(s -&gt; s.field(<span class="hljs-string">&quot;albumIntro&quot;</span>).query(keyword)));<br>    <span class="hljs-comment">//  高亮</span><br>    requestBuilder.highlight(h-&gt;h.fields(<span class="hljs-string">&quot;albumTitle&quot;</span>,<br>                                         <span class="hljs-comment">//                    f-&gt;f.preTags(&quot;&lt;font color:red&gt;&quot;).postTags(&quot;&lt;/font&gt;&quot;)</span><br>                                         f-&gt;f.preTags(<span class="hljs-string">&quot;&lt;span style=color:red&gt;&quot;</span>).postTags(<span class="hljs-string">&quot;&lt;/span&gt;&quot;</span>)<br>                                        ));<br>  &#125;<br><br>  <span class="hljs-comment">//  入口：分类Id  复制小括号，写死右箭头，落地大括号</span><br>  <span class="hljs-comment">//  一级分类Id</span><br>  <span class="hljs-type">Long</span> <span class="hljs-variable">category1Id</span> <span class="hljs-operator">=</span> albumIndexQuery.getCategory1Id();<br>  <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(category1Id)) &#123;<br>    boolQuery.filter(f -&gt; f.term(s -&gt; s.field(<span class="hljs-string">&quot;category1Id&quot;</span>).value(category1Id)));<br>  &#125;<br>  <span class="hljs-comment">//  二级分类Id</span><br>  <span class="hljs-type">Long</span> <span class="hljs-variable">category2Id</span> <span class="hljs-operator">=</span> albumIndexQuery.getCategory2Id();<br>  <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(category2Id)) &#123;<br>    boolQuery.filter(f -&gt; f.term(s -&gt; s.field(<span class="hljs-string">&quot;category2Id&quot;</span>).value(category2Id)));<br>  &#125;<br>  <span class="hljs-comment">//  三级分类Id</span><br>  <span class="hljs-type">Long</span> <span class="hljs-variable">category3Id</span> <span class="hljs-operator">=</span> albumIndexQuery.getCategory3Id();<br>  <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(category3Id)) &#123;<br>    boolQuery.filter(f -&gt; f.term(s -&gt; s.field(<span class="hljs-string">&quot;category3Id&quot;</span>).value(category3Id)));<br>  &#125;<br><br>  <span class="hljs-comment">//  根据属性Id 检索 前端传递数据的时候 属性Id:属性值Id 属性Id:属性值Id</span><br>  List&lt;String&gt; attributeList = albumIndexQuery.getAttributeList();<br>  <span class="hljs-comment">//  判断集合不为空</span><br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(attributeList)) &#123;<br>    <span class="hljs-comment">//  循环遍历.</span><br>    <span class="hljs-keyword">for</span> (String attribute : attributeList) &#123;<br>      <span class="hljs-comment">//  需要使用 : 分割</span><br>      String[] split = attribute.split(<span class="hljs-string">&quot;:&quot;</span>);<br>      <span class="hljs-comment">//  判断</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != split &amp;&amp; split.length == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-comment">//  创建nestedQuery 对象.</span><br>        <span class="hljs-type">NestedQuery</span> <span class="hljs-variable">nestedQuery</span> <span class="hljs-operator">=</span> NestedQuery.of(f -&gt; f.path(<span class="hljs-string">&quot;attributeValueIndexList&quot;</span>)<br>                                                 .query(q -&gt; q.bool(<br>                                                   m -&gt; m.must(s -&gt; s.match(<br>                                                     a -&gt; a.field(<span class="hljs-string">&quot;attributeValueIndexList.attributeId&quot;</span>).query(split[<span class="hljs-number">0</span>])<br>                                                   ))<br>                                                   .must(s -&gt; s.match(<br>                                                     a -&gt; a.field(<span class="hljs-string">&quot;attributeValueIndexList.valueId&quot;</span>).query(split[<span class="hljs-number">1</span>])<br>                                                   ))<br>                                                 ))<br>                                                );<br>        boolQuery.filter(f -&gt; f.nested(nestedQuery));<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//  排序 分页 高亮 排序（综合排序[1:desc] 播放量[2:desc] 发布时间[3:desc]；asc:升序 desc:降序）</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> albumIndexQuery.getOrder();<br>  <span class="hljs-comment">//  定义一个排序字段</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">orderField</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-comment">//  定义一个排序规则</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">sort</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-comment">//  判断</span><br>  <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(order)) &#123;<br>    <span class="hljs-comment">//  分割数据</span><br>    String[] split = order.split(<span class="hljs-string">&quot;:&quot;</span>);<br>    <span class="hljs-comment">//  判断这个数组</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != split &amp;&amp; split.length == <span class="hljs-number">2</span>) &#123;<br>      <span class="hljs-keyword">switch</span> (split[<span class="hljs-number">0</span>]) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;1&quot;</span>:<br>          orderField = <span class="hljs-string">&quot;hotScore&quot;</span>;<br>          <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;2&quot;</span>:<br>          orderField = <span class="hljs-string">&quot;playStatNum&quot;</span>;<br>          <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;3&quot;</span>:<br>          orderField = <span class="hljs-string">&quot;createTime&quot;</span>;<br>          <span class="hljs-keyword">break</span>;<br>      &#125;<br>      sort = split[<span class="hljs-number">1</span>];<br>    &#125;<br>    <span class="hljs-comment">//  判断 desc SortOrder.Desc  asc SortOrder.Asc</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">finalSort</span> <span class="hljs-operator">=</span> sort;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">finalOrderField</span> <span class="hljs-operator">=</span> orderField;<br>    requestBuilder.sort(f-&gt;f.field(o-&gt;o.field(finalOrderField).order(<span class="hljs-string">&quot;asc&quot;</span>.equals(finalSort)?SortOrder.Asc:SortOrder.Desc)));<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//  默认排序规则 _score</span><br>    requestBuilder.sort(f-&gt;f.field(o-&gt;o.field(<span class="hljs-string">&quot;_score&quot;</span>).order(SortOrder.Desc)));<br>  &#125;<br>  <span class="hljs-comment">//  字段选择</span><br>  requestBuilder.source(s-&gt;s.filter(f-&gt;f.excludes(<span class="hljs-string">&quot;attributeValueIndexList&quot;</span>)));<br>  <span class="hljs-comment">//  分页： (pageNo-1)*pageSize()</span><br>  <span class="hljs-type">Integer</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (albumIndexQuery.getPageNo() - <span class="hljs-number">1</span>)*albumIndexQuery.getPageSize();<br>  requestBuilder.from(from);<br>  requestBuilder.size(albumIndexQuery.getPageSize());<br><br>  <span class="hljs-comment">//  &#123;query &#125;</span><br>  <span class="hljs-comment">//  GET /albuminfo/_search</span><br>  requestBuilder.index(<span class="hljs-string">&quot;albuminfo&quot;</span>).query(f -&gt; f.bool(boolQuery.build()));<br>  <span class="hljs-comment">//  创建对象</span><br>  <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> requestBuilder.build();<br>  System.out.println(<span class="hljs-string">&quot;dsl:\t&quot;</span>+searchRequest.toString());<br>  <span class="hljs-comment">//  返回</span><br>  <span class="hljs-keyword">return</span> searchRequest;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-1-3-2-2-获取查询结果集"><a href="#2-1-3-2-2-获取查询结果集" class="headerlink" title="2.1.3.2.2 获取查询结果集"></a>2.1.3.2.2 获取查询结果集</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取结果集对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> searchResponse</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> AlbumSearchResponseVo <span class="hljs-title function_">parseSearchResult</span><span class="hljs-params">(SearchResponse&lt;AlbumInfoIndex&gt; searchResponse)</span> &#123;<br>    <span class="hljs-comment">//  创建对象</span><br>    <span class="hljs-type">AlbumSearchResponseVo</span> <span class="hljs-variable">searchResponseVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlbumSearchResponseVo</span>();<br>    <span class="hljs-comment">//  private List&lt;AlbumInfoIndexVo&gt; list = new ArrayList&lt;&gt;();</span><br>    <span class="hljs-comment">//  private Long total;//总记录数</span><br>    <span class="hljs-comment">//  获取数据</span><br>    HitsMetadata&lt;AlbumInfoIndex&gt; hits = searchResponse.hits();<br>    <span class="hljs-comment">//  总记录数</span><br>    searchResponseVo.setTotal(hits.total().value());<br>    <span class="hljs-comment">//  获取数据</span><br>    List&lt;Hit&lt;AlbumInfoIndex&gt;&gt; subHist = hits.hits();<br>    <span class="hljs-comment">//  判断</span><br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(subHist))&#123;<br>        <span class="hljs-comment">//  循环遍历.</span><br>        List&lt;AlbumInfoIndexVo&gt; list = subHist.stream().map(albumInfoIndexHit -&gt; &#123;<br>            <span class="hljs-comment">//  创建对象</span><br>            <span class="hljs-type">AlbumInfoIndexVo</span> <span class="hljs-variable">albumInfoIndexVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlbumInfoIndexVo</span>();<br>            <span class="hljs-type">AlbumInfoIndex</span> <span class="hljs-variable">albumInfoIndex</span> <span class="hljs-operator">=</span> albumInfoIndexHit.source();<br>            <span class="hljs-comment">//  进行赋值</span><br>            BeanUtils.copyProperties(albumInfoIndex, albumInfoIndexVo);<br>            <span class="hljs-comment">//  判断用户是否根据关键词进行检索.</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != albumInfoIndexHit.highlight().get(<span class="hljs-string">&quot;albumTitle&quot;</span>))&#123;<br>                <span class="hljs-comment">//  获取高亮数据</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">albumTitle</span> <span class="hljs-operator">=</span> albumInfoIndexHit.highlight().get(<span class="hljs-string">&quot;albumTitle&quot;</span>).get(<span class="hljs-number">0</span>);<br>                <span class="hljs-comment">//  赋值高亮数据</span><br>                albumInfoIndexVo.setAlbumTitle(albumTitle);<br>            &#125;<br>            <span class="hljs-comment">//  返回数据</span><br>            <span class="hljs-keyword">return</span> albumInfoIndexVo;<br>        &#125;).collect(Collectors.toList());<br>        <span class="hljs-comment">//  赋值</span><br>        searchResponseVo.setList(list);<br>    &#125;<br>    <span class="hljs-comment">//  返回数据</span><br>    <span class="hljs-keyword">return</span> searchResponseVo;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-2-根据一级分类Id-查询频道数据"><a href="#2-2-根据一级分类Id-查询频道数据" class="headerlink" title="2.2 根据一级分类Id 查询频道数据"></a>2.2 根据一级分类Id 查询频道数据</h2><h3 id="2-3-1-业务分析"><a href="#2-3-1-业务分析" class="headerlink" title="2.3.1 业务分析"></a>2.3.1 业务分析</h3><p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/%E6%A3%80%E7%B4%A2-%E7%83%AD%E5%BA%A6%E6%90%9C%E7%B4%A2.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![检索-热度搜索](第4章 专辑检索/检索-热度搜索.gif)

-->

<p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/tingshu056.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第4章 专辑检索/tingshu056.png)

-->





<p>获取频道页数据时，页面需要将存储一个 List<map> 集合，map中需要存储 </map></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//	根据三级分类Id 找到三级分类对象&#123;category3Id, categoryName&#125;</span><br>map.put(<span class="hljs-string">&quot;baseCategory3&quot;</span>, category3IdToMap.get(category3Id));<br><span class="hljs-comment">//	专辑的集合数据</span><br>map.put(<span class="hljs-string">&quot;list&quot;</span>, albumInfoIndexList);<br></code></pre></td></tr></table></figure>

<p>该接口是获取一级分类下，置顶到频道页的三级分类（base_category3（is_top&#x3D;1））的热门数据</p>
<h3 id="2-3-2-控制器"><a href="#2-3-2-控制器" class="headerlink" title="2.3.2 控制器"></a>2.3.2 控制器</h3><p>SearchApiController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据一级分类Id获取数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;获取频道页数据&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;channel/&#123;category1Id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">channel</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long category1Id)</span> &#123;<br><br>  <span class="hljs-comment">//  调用服务层方法</span><br>  List&lt;Map&lt;String, Object&gt;&gt; mapList = <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>    mapList = searchService.channel(category1Id);<br>  &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>  &#125;<br>  <span class="hljs-keyword">return</span> Result.ok(mapList);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-接口与实现"><a href="#2-3-3-接口与实现" class="headerlink" title="2.3.3 接口与实现"></a>2.3.3 接口与实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 根据一级分类Id 获取置顶数据</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br>List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">channel</span><span class="hljs-params">(Long category1Id)</span>;<br></code></pre></td></tr></table></figure>

<p>基本DSL语句：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /albuminfo/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;category3Id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-string">&quot;1001&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;1002&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;1003&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;1004&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;1005&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;1006&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-string">&quot;1007&quot;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;groupByCategory3IdAgg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;category3Id&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;topTenHotScoreAgg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;top_hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;hotScore&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;desc&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>思路：</p>
<ol>
<li>先根据一级分类Id获取到三级分类集合数据</li>
<li>获取到三级分类Id集合</li>
<li>根据三级分类Id 集合生成根据三级分类Id查询专辑数据</li>
<li>根据三级分类Id聚合并获取到前6条数据并按照热度排名进行降序排列</li>
<li>从聚合中获取到数据并封装到返回数据的集合中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">channel</span><span class="hljs-params">(Long category1Id)</span> &#123;<br>    <span class="hljs-comment">//  根据一级分类Id 获取到置顶数据集合</span><br>    Result&lt;List&lt;BaseCategory3&gt;&gt; baseCategory3ListResult = categoryFeignClient.findTopBaseCategory3(category1Id);<br>    <span class="hljs-comment">//  获取数据</span><br>    List&lt;BaseCategory3&gt; baseCategory3List = baseCategory3ListResult.getData();<br>    <span class="hljs-comment">//  建立对应关系 key = 三级分类Id value = 三级分类对象</span><br>    Map&lt;Long, BaseCategory3&gt; category3IdToMap = baseCategory3List.stream().collect(Collectors.toMap(BaseCategory3::getId, baseCategory3 -&gt; baseCategory3));<br>    <span class="hljs-comment">//  获取到三级分类Id 集合</span><br>    List&lt;Long&gt; idList = baseCategory3List.stream().map(BaseCategory3::getId).collect(Collectors.toList());<br>    <span class="hljs-comment">//  将这个idList进行转换</span><br>    List&lt;FieldValue&gt; valueList = idList.stream().map(id -&gt; FieldValue.of(id)).collect(Collectors.toList());<br>    <span class="hljs-comment">//  调用查询方法:</span><br>    SearchRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>.Builder();<br>    request.index(<span class="hljs-string">&quot;albuminfo&quot;</span>).query(q-&gt;q.terms(f-&gt;f.field(<span class="hljs-string">&quot;category3Id&quot;</span>).terms(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TermsQueryField</span>.Builder().value(valueList).build())));<br>    request.aggregations(<span class="hljs-string">&quot;groupByCategory3IdAgg&quot;</span>,a-&gt;a.terms(t-&gt;t.field(<span class="hljs-string">&quot;category3Id&quot;</span>))<br>            .aggregations(<span class="hljs-string">&quot;topTenHotScoreAgg&quot;</span>,a1-&gt;a1.topHits(s-&gt;s.size(<span class="hljs-number">6</span>).sort(sort-&gt;sort.field(f-&gt;f.field(<span class="hljs-string">&quot;hotScore&quot;</span>).order(SortOrder.Desc))))));<br>    <span class="hljs-comment">//  获取到查询结果集</span><br>    SearchResponse&lt;AlbumInfoIndex&gt; searchResponse = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        searchResponse = elasticsearchClient.search(request.build(), AlbumInfoIndex.class);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>    <span class="hljs-comment">//  声明集合</span><br>    List&lt;Map&lt;String, Object&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">//  从聚合中获取数据</span><br>    <span class="hljs-type">Aggregate</span> <span class="hljs-variable">groupByCategory3IdAgg</span> <span class="hljs-operator">=</span> searchResponse.aggregations().get(<span class="hljs-string">&quot;groupByCategory3IdAgg&quot;</span>);<br>    groupByCategory3IdAgg.lterms().buckets().array().forEach(item -&gt;&#123;<br>        <span class="hljs-comment">//  创建集合数据</span><br>        List&lt;AlbumInfoIndex&gt; albumInfoIndexList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//  获取三级分类Id 对象</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">category3Id</span> <span class="hljs-operator">=</span> item.key();<br>        <span class="hljs-comment">//  获取要置顶的集合数据</span><br>        <span class="hljs-type">Aggregate</span> <span class="hljs-variable">topTenHotScoreAgg</span> <span class="hljs-operator">=</span> item.aggregations().get(<span class="hljs-string">&quot;topTenHotScoreAgg&quot;</span>);<br>        <span class="hljs-comment">//  循环遍历获取聚合中的数据</span><br>        topTenHotScoreAgg.topHits().hits().hits().forEach(hit-&gt;&#123;<br>            <span class="hljs-comment">//  获取到source 的json 字符串数据</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> hit.source().toString();<br>            <span class="hljs-comment">//  将json 字符串转换为AlbumInfoIndex 对象</span><br>            <span class="hljs-type">AlbumInfoIndex</span> <span class="hljs-variable">albumInfoIndex</span> <span class="hljs-operator">=</span> JSON.parseObject(json, AlbumInfoIndex.class);<br>            <span class="hljs-comment">//  将对象添加到集合中</span><br>            albumInfoIndexList.add(albumInfoIndex);<br>        &#125;);<br>        <span class="hljs-comment">//  声明一个map 集合数据</span><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//  存储根据三级分类Id要找到的三级分类</span><br>        map.put(<span class="hljs-string">&quot;baseCategory3&quot;</span>,category3IdToMap.get(category3Id));<br>        <span class="hljs-comment">//  存储所有的专辑集合数据</span><br>        map.put(<span class="hljs-string">&quot;list&quot;</span>,albumInfoIndexList);<br>        <span class="hljs-comment">//  将map 添加到集合中</span><br>        result.add(map);<br>    &#125;);<br>    <span class="hljs-comment">//  返回数据</span><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>远程调用接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据一级分类Id查询置顶到频道页的三级分类列表</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@GetMapping(&quot;api/album/category/findTopBaseCategory3/&#123;category1Id&#125;&quot;)</span><br>Result&lt;List&lt;BaseCategory3&gt;&gt; <span class="hljs-title function_">findTopBaseCategory3</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long category1Id)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;BaseCategory3&gt;&gt; <span class="hljs-title function_">findTopBaseCategory3</span><span class="hljs-params">(Long category1Id)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-1-获取置顶数据"><a href="#2-3-3-1-获取置顶数据" class="headerlink" title="2.3.3.1 获取置顶数据"></a>2.3.3.1 获取置顶数据</h4><p><strong>控制器</strong></p>
<p>BaseCategoryApiController 控制器中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据一级分类Id 查询置顶频道页的三级分类列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;获取一级分类下置顶到频道页的三级分类列表&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;findTopBaseCategory3/&#123;category1Id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;BaseCategory3&gt;&gt; <span class="hljs-title function_">findTopBaseCategory3</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long category1Id)</span> &#123;<br>	<span class="hljs-comment">//	获取三级分类列表</span><br>	List&lt;BaseCategory3&gt; baseCategory3List = baseCategoryService.findTopBaseCategory3ByCategory1Id(category1Id);<br>	<span class="hljs-comment">//	返回数据</span><br>	<span class="hljs-keyword">return</span> Result.ok(baseCategory3List);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>接口与实现</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据一级分类Id 查询置顶频道页的三级分类列表</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br>List&lt;BaseCategory3&gt; <span class="hljs-title function_">findTopBaseCategory3ByCategory1Id</span><span class="hljs-params">(Long category1Id)</span>;<br></code></pre></td></tr></table></figure>

<p>思路：</p>
<ol>
<li>先根据一级分类Id找到二级分类集合</li>
<li>获取到二级分类Id 的集合数据</li>
<li>再根据二级分类Id 与isTop &#x3D; 1查询三级分类数据</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;BaseCategory3&gt; <span class="hljs-title function_">findTopBaseCategory3ByCategory1Id</span><span class="hljs-params">(Long category1Id)</span> &#123;<br>  <span class="hljs-comment">//	select * from base_category3 where base_category3.category2_id in (101,102,103) and is_top = 1 limit 7;</span><br>  <span class="hljs-comment">//	先根据一级分类Id 找到二级分类集合</span><br>  LambdaQueryWrapper&lt;BaseCategory2&gt; baseCategory2LambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>  baseCategory2LambdaQueryWrapper.eq(BaseCategory2::getCategory1Id,category1Id);<br>  List&lt;BaseCategory2&gt; baseCategory2List = baseCategory2Mapper.selectList(baseCategory2LambdaQueryWrapper);<br>  List&lt;Long&gt; category2IdList = baseCategory2List.stream().map(BaseCategory2::getId).collect(Collectors.toList());<br>  <span class="hljs-comment">//	查询置顶消息，每页显示7条数据；</span><br>  LambdaQueryWrapper&lt;BaseCategory3&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>  wrapper.in(BaseCategory3::getCategory2Id,category2IdList).eq(BaseCategory3::getIsTop,<span class="hljs-number">1</span>).last(<span class="hljs-string">&quot; limit 7 &quot;</span>);<br>  <span class="hljs-keyword">return</span> baseCategory3Mapper.selectList(wrapper);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-3-根据一级分类Id获取全部分类信息"><a href="#2-3-根据一级分类Id获取全部分类信息" class="headerlink" title="2.3 根据一级分类Id获取全部分类信息"></a>2.3 根据一级分类Id获取全部分类信息</h2><p>点击全部的时候，加载所有的一级分类信息数据：</p>
<p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/tingshu009.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第4章 专辑检索/tingshu009.png)

-->

<p>实现思路：</p>
<ol>
<li><p>根据一级分类Id 查询一级分类对象</p>
</li>
<li><p>根据一级分类Id查询当前一级分类Id 下对应的集合数据</p>
</li>
<li><p>根据二级分类Id进行分组获取二级分类对象</p>
</li>
<li><p>获取二级下对应的三级分类数据</p>
</li>
<li><p>将数据统一封装到一级分类对象中</p>
<p>格式如下：</p>
</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;categoryChild&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;categoryChild&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;催眠音乐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1001</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;放松音乐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1002</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;提神音乐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1003</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;胎教音乐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1004</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;运动音乐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1005</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;休闲音乐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1006</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;音乐音效&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span><br>	<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;categoryChild&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;助眠引导&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1007</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;放松引导&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1008</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;专注引导&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1009</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;儿童入睡引导&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1010</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;其他&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1011</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;课程引导&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">102</span><br>	<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;categoryChild&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;经典音乐推荐&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1012</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;热歌盘点&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1013</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;歌曲翻唱&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1014</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;音乐教学&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1015</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;音乐故事&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1016</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;其他&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1017</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;主播音乐节目&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">103</span><br>	<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;categoryName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;音乐&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;categoryId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-3-1-控制器"><a href="#2-3-1-控制器" class="headerlink" title="2.3.1 控制器"></a>2.3.1 控制器</h3><p>BaseCategoryApiController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据一级分类Id 获取全部数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;根据一级分类id获取全部分类信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;getBaseCategoryList/&#123;category1Id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;JSONObject&gt; <span class="hljs-title function_">getBaseCategoryList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long category1Id)</span>&#123;<br>   <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> baseCategoryService.getAllCategoryList(category1Id);<br>   <span class="hljs-keyword">return</span> Result.ok(jsonObject);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-2-接口与实现"><a href="#2-3-2-接口与实现" class="headerlink" title="2.3.2 接口与实现"></a>2.3.2 接口与实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据一级分类Id 获取数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> category1Id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>JSONObject <span class="hljs-title function_">getAllCategoryList</span><span class="hljs-params">(Long category1Id)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">getAllCategoryList</span><span class="hljs-params">(Long category1Id)</span> &#123;<br>   <span class="hljs-type">BaseCategory1</span> <span class="hljs-variable">baseCategory1</span> <span class="hljs-operator">=</span> baseCategory1Mapper.selectById(category1Id);<br>   <span class="hljs-comment">// 声明一级分类对象</span><br>   <span class="hljs-type">JSONObject</span> <span class="hljs-variable">category1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>   category1.put(<span class="hljs-string">&quot;categoryId&quot;</span>, category1Id);<br>   category1.put(<span class="hljs-string">&quot;categoryName&quot;</span>, baseCategory1.getName());<br><br>   <span class="hljs-comment">//获取全部分类信息</span><br>   List&lt;BaseCategoryView&gt; baseCategoryViewList = baseCategoryViewMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;BaseCategoryView&gt;().eq(BaseCategoryView::getCategory1Id, category1Id));<br><br>   <span class="hljs-comment">//根据二级分类ID分组转换数据</span><br>   Map&lt;Long, List&lt;BaseCategoryView&gt;&gt; category2Map = baseCategoryViewList.stream().collect(Collectors.groupingBy(BaseCategoryView::getCategory2Id));<br>   List&lt;JSONObject&gt; category2Child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>   <span class="hljs-keyword">for</span>(Map.Entry&lt;Long, List&lt;BaseCategoryView&gt;&gt; entry2 : category2Map.entrySet()) &#123;<br>      <span class="hljs-comment">//二级分类ID</span><br>      <span class="hljs-type">Long</span> <span class="hljs-variable">category2Id</span> <span class="hljs-operator">=</span> entry2.getKey();<br>      <span class="hljs-comment">//二级分类对应的全部数据（三级数据）</span><br>      List&lt;BaseCategoryView&gt; category3List = entry2.getValue();<br><br>      <span class="hljs-comment">// 声明二级分类对象</span><br>      <span class="hljs-type">JSONObject</span> <span class="hljs-variable">category2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>      category2.put(<span class="hljs-string">&quot;categoryId&quot;</span>, category2Id);<br>      category2.put(<span class="hljs-string">&quot;categoryName&quot;</span>, category3List.get(<span class="hljs-number">0</span>).getCategory2Name());<br><br>      <span class="hljs-comment">// 循环三级分类数据</span><br>      List&lt;JSONObject&gt; category3Child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>      category3List.stream().forEach(category3View -&gt; &#123;<br>         <span class="hljs-type">JSONObject</span> <span class="hljs-variable">category3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>         category3.put(<span class="hljs-string">&quot;categoryId&quot;</span>, category3View.getCategory3Id());<br>         category3.put(<span class="hljs-string">&quot;categoryName&quot;</span>, category3View.getCategory3Name());<br>         category3Child.add(category3);<br>      &#125;);<br>      category2Child.add(category2);<br>      <span class="hljs-comment">// 将三级数据放入二级里面</span><br>      category2.put(<span class="hljs-string">&quot;categoryChild&quot;</span>, category3Child);<br>   &#125;<br>   <span class="hljs-comment">// 将二级数据放入一级里面</span><br>   category1.put(<span class="hljs-string">&quot;categoryChild&quot;</span>, category2Child);<br>   <span class="hljs-keyword">return</span> category1;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-4-关键字自动补全功能"><a href="#2-4-关键字自动补全功能" class="headerlink" title="2.4 关键字自动补全功能"></a>2.4 关键字自动补全功能</h2><h3 id="2-4-1-入门案例"><a href="#2-4-1-入门案例" class="headerlink" title="2.4.1 入门案例"></a>2.4.1 入门案例</h3><p><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/%E6%A3%80%E7%B4%A2-%E5%85%B3%E9%94%AE%E5%AD%97%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![检索-关键字自动补全](第4章 专辑检索/检索-关键字自动补全.gif)

-->

<p>根据用户输入的关键词，实现自动填充的效果</p>
<p>API: [Suggesters | Elasticsearch Guide <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/search-suggesters.html#completion-suggester">8.5] | Elastic</a></p>
<p>completion suggest 也叫自动完成，搜索推荐，搜索提示 ，一般多叫自动完成，即auto completion。</p>
<p>比如说我们在百度，搜索，你现在搜索“大话西游” —&gt;<br><img src="/2024/11/10/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20%E4%B8%93%E8%BE%91%E6%A3%80%E7%B4%A2/tingshu057.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第4章 专辑检索/tingshu057.png)

-->

<p>completion，es 实现的时候，是非常高性能的，会构建不是倒排索引，也不是正排索引，就是纯的用于进行前缀搜索的一种特殊的数据结构，而且会全部放在内存中，所以auto completion进行的前缀搜索提示，性能是非常高的。</p>
<p>1. </p>
<ol>
<li><p>初始化设置</p>
<p>要使用completion需要先将其做设置，注意此处suggest的type 为 completion这一种】，另外此处title未设置全词匹配即type非keyword,故会出现补充测试这一现象</p>
</li>
<li><p>存储数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json">#创建索引<br>PUT test<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;completion&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br># 添加数据<br>POST test/_doc<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Pitch Fork&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;Pitch&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Fork&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>POST test/_doc<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Spading Fork&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;Spading&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;Fork&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>POST test/_doc<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br># 查询所有数据 会有三条数据出现<br>GET test/_search<br></code></pre></td></tr></table></figure>
</li>
<li><p>测试 suggest</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"># 检索fo开的的人 会出现三条数据<br>GET test/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fo&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;completion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;suggest&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结果：检索结果集为空，但是建议提词中有三条数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fork&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sA5tvIoBWq_kM3ND-lkp&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Pitch Fork&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Pitch&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Fork&quot;</span><br>              <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fork&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sg5xvIoBWq_kM3NDj1nD&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Spading Fork&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Spading&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Fork&quot;</span><br>              <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sQ5uvIoBWq_kM3NDF1l7&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Fountain&quot;</span><br>              <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>如果检索fon开头的单词,则一条数据都不会出现.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">GET test/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fon&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;completion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;suggest&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fon&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

</li>
<li><p>文档中包含两个fork。”skip_duplicates”: true 作用 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"># 去重显示<br>GET test/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fo&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;completion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;suggest&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skip_duplicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fork&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sA5tvIoBWq_kM3ND-lkp&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Pitch Fork&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Pitch&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Fork&quot;</span><br>              <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sQ5uvIoBWq_kM3NDF1l7&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Fountain&quot;</span><br>              <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

</li>
<li><p>在实际使用中，有时我们输入时可能会出现错误。比如输入 for 时，输入了foe。此时可以使用 fuzzy,  在这里面的 fuzziness 我设置为 auto。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">GET test/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;foe&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;completion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;suggest&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skip_duplicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;fuzzy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;fuzziness&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结果集：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;completer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;foe&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;options&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fork&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sA5tvIoBWq_kM3ND-lkp&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fountain&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sQ5uvIoBWq_kM3NDF1l7&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-4-2-创建并初始化索引库"><a href="#2-4-2-创建并初始化索引库" class="headerlink" title="2.4.2 创建并初始化索引库"></a>2.4.2 创建并初始化索引库</h3><p>项目启动的时候就会生成这个索引库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.search.repository;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.search.SuggestIndex;<br><span class="hljs-keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuggestIndexRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;SuggestIndex, String&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在实现类中引入：</p>
<p>SearchServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SuggestIndexRepository suggestIndexRepository;<br></code></pre></td></tr></table></figure>

<p>在上架方法中追加内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//  上架添加提词数据.</span><br><span class="hljs-comment">//  创建对象 专辑标题提词</span><br><span class="hljs-type">SuggestIndex</span> <span class="hljs-variable">suggestIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuggestIndex</span>();<br>suggestIndex.setId(UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;&quot;</span>));<br>suggestIndex.setTitle(albumInfoIndex.getAlbumTitle());<br>suggestIndex.setKeyword(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;albumInfoIndex.getAlbumTitle()&#125;));<br>suggestIndex.setKeywordPinyin(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;PinYinUtils.toHanyuPinyin(albumInfoIndex.getAlbumTitle())&#125;));<br>suggestIndex.setKeywordSequence(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;PinYinUtils.getFirstLetter(albumInfoIndex.getAlbumTitle())&#125;));<br><span class="hljs-built_in">this</span>.suggestIndexRepository.save(suggestIndex);<br><br><span class="hljs-comment">//  专辑简介提词</span><br><span class="hljs-type">SuggestIndex</span> <span class="hljs-variable">albumIntroSuggestIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuggestIndex</span>();<br>albumIntroSuggestIndex.setId(UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;&quot;</span>));<br>albumIntroSuggestIndex.setTitle(albumInfoIndex.getAlbumIntro());<br>albumIntroSuggestIndex.setKeyword(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;albumInfoIndex.getAlbumIntro()&#125;));<br>albumIntroSuggestIndex.setKeywordPinyin(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;PinYinUtils.toHanyuPinyin(albumInfoIndex.getAlbumIntro())&#125;));<br>albumIntroSuggestIndex.setKeywordSequence(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;PinYinUtils.getFirstLetter(albumInfoIndex.getAlbumIntro())&#125;));<br><span class="hljs-built_in">this</span>.suggestIndexRepository.save(albumIntroSuggestIndex);<br><br><span class="hljs-comment">// 专辑主播提词</span><br><span class="hljs-type">SuggestIndex</span> <span class="hljs-variable">announcerSuggestIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuggestIndex</span>();<br>announcerSuggestIndex.setId(UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>));<br>announcerSuggestIndex.setTitle(albumInfoIndex.getAnnouncerName());<br>announcerSuggestIndex.setKeyword(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;albumInfoIndex.getAnnouncerName()&#125;));<br>announcerSuggestIndex.setKeywordPinyin(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;PinYinUtils.toHanyuPinyin(albumInfoIndex.getAnnouncerName())&#125;));<br>announcerSuggestIndex.setKeywordSequence(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;PinYinUtils.getFirstLetter(albumInfoIndex.getAnnouncerName())&#125;));<br>suggestIndexRepository.save(announcerSuggestIndex);<br></code></pre></td></tr></table></figure>



<h3 id="2-4-3-实现自动补全功能"><a href="#2-4-3-实现自动补全功能" class="headerlink" title="2.4.3 实现自动补全功能"></a>2.4.3 实现自动补全功能</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java">GET /suggestinfo/_search<br>&#123;<br>  <span class="hljs-string">&quot;suggest&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;suggestionKeyword&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;prefix&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-string">&quot;completion&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span>,<br>        <span class="hljs-string">&quot;skip_duplicates&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;fuzzy&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;fuzziness&quot;</span>: <span class="hljs-string">&quot;auto&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;,<br>     <span class="hljs-string">&quot;suggestionkeywordPinyin&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;prefix&quot;</span>: <span class="hljs-string">&quot;sangui&quot;</span>,<br>      <span class="hljs-string">&quot;completion&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;keywordPinyin&quot;</span>,<br>        <span class="hljs-string">&quot;skip_duplicates&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;fuzzy&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;fuzziness&quot;</span>: <span class="hljs-string">&quot;auto&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;,<br>     <span class="hljs-string">&quot;suggestionkeywordSequence&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;prefix&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>      <span class="hljs-string">&quot;completion&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;keywordSequence&quot;</span>,<br>        <span class="hljs-string">&quot;skip_duplicates&quot;</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">10</span>,<br>        <span class="hljs-string">&quot;fuzzy&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;fuzziness&quot;</span>: <span class="hljs-string">&quot;auto&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-1-控制器"><a href="#2-4-3-1-控制器" class="headerlink" title="2.4.3.1  控制器"></a>2.4.3.1  控制器</h4><p>SearchApiController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 自动补全功能</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> keyword</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@Operation(summary = &quot;关键字自动补全&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;completeSuggest/&#123;keyword&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">completeSuggest</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String keyword)</span> &#123;<br>  <span class="hljs-comment">//  根据关键词查询补全</span><br>  List&lt;String&gt; list = searchService.completeSuggest(keyword);<br>  <span class="hljs-comment">//  返回数据</span><br>  <span class="hljs-keyword">return</span> Result.ok(list);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-4-3-2-接口与实现"><a href="#2-4-3-2-接口与实现" class="headerlink" title="2.4.3.2 接口与实现"></a>2.4.3.2 接口与实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 根据关键字自动补全功能</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> keyword</span><br><span class="hljs-comment">* <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">*/</span><br>List&lt;String&gt; <span class="hljs-title function_">completeSuggest</span><span class="hljs-params">(String keyword)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getCompleteSuggest</span><span class="hljs-params">(String keyword)</span> &#123;<br>    <span class="hljs-comment">//  Java 动态生成dsl 语句.</span><br>    SearchRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>.Builder();<br>    searchRequest.index(<span class="hljs-string">&quot;suggestinfo&quot;</span>).suggest(<br>            s-&gt;s.suggesters(<span class="hljs-string">&quot;suggestionKeyword&quot;</span>,f-&gt;f.prefix(keyword).completion(<br>                    c-&gt;c.field(<span class="hljs-string">&quot;keyword&quot;</span>).skipDuplicates(<span class="hljs-literal">true</span>).size(<span class="hljs-number">10</span>)<br>                            .fuzzy(<br>                            z-&gt;z.fuzziness(<span class="hljs-string">&quot;auto&quot;</span>))  <br>                    ))<br>                    .suggesters(<span class="hljs-string">&quot;suggestionkeywordPinyin&quot;</span>,f-&gt;f.prefix(keyword).completion(<br>                            c-&gt;c.field(<span class="hljs-string">&quot;keywordPinyin&quot;</span>).skipDuplicates(<span class="hljs-literal">true</span>).size(<span class="hljs-number">10</span>)<br>                                    .fuzzy(z-&gt;z.fuzziness(<span class="hljs-string">&quot;auto&quot;</span>))<br>                    ))<br>                    .suggesters(<span class="hljs-string">&quot;suggestionkeywordSequence&quot;</span>,f-&gt;f.prefix(keyword).completion(<br>                            c-&gt;c.field(<span class="hljs-string">&quot;keywordSequence&quot;</span>).skipDuplicates(<span class="hljs-literal">true</span>).size(<span class="hljs-number">10</span>)<br>                                    .fuzzy(z-&gt;z.fuzziness(<span class="hljs-string">&quot;auto&quot;</span>))<br>                    ))<br>    );<br>    <span class="hljs-comment">//  获取查询结果</span><br>    SearchResponse&lt;SuggestIndex&gt; searchResponse = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        searchResponse = elasticsearchClient.search(searchRequest.build(), SuggestIndex.class);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>    <span class="hljs-comment">//  获取到结果集,数据转换. set集合无序不重复? 1.hashCode(); 2.equals();   为什么 底层hashMap !map.key=value map.value=new Object();</span><br>    HashSet&lt;String&gt; titleSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>    titleSet.addAll(<span class="hljs-built_in">this</span>.parseResultData(searchResponse,<span class="hljs-string">&quot;suggestionKeyword&quot;</span>));<br>    titleSet.addAll(<span class="hljs-built_in">this</span>.parseResultData(searchResponse,<span class="hljs-string">&quot;suggestionkeywordPinyin&quot;</span>));<br>    titleSet.addAll(<span class="hljs-built_in">this</span>.parseResultData(searchResponse,<span class="hljs-string">&quot;suggestionkeywordSequence&quot;</span>));<br><br>    <br>    <span class="hljs-comment">//  返回数据</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(titleSet);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>内部调用方法parseSearchResult</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理聚合结果集</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> suggestName</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">parseSearchResult</span><span class="hljs-params">(SearchResponse&lt;SuggestIndex&gt; response, String suggestName)</span> &#123;<br>    <span class="hljs-comment">//  创建集合</span><br>    List&lt;String&gt; suggestList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    Map&lt;String, List&lt;Suggestion&lt;SuggestIndex&gt;&gt;&gt; groupBySuggestionListAggMap = response.suggest();<br>    groupBySuggestionListAggMap.get(suggestName).forEach(item -&gt; &#123;<br>        CompletionSuggest&lt;SuggestIndex&gt; completionSuggest =  item.completion();<br>        completionSuggest.options().forEach(it -&gt; &#123;<br>            <span class="hljs-type">SuggestIndex</span> <span class="hljs-variable">suggestIndex</span> <span class="hljs-operator">=</span> it.source();<br>            suggestList.add(suggestIndex.getTitle());<br>        &#125;);<br>    &#125;);<br>    <span class="hljs-comment">//  返回集合列表</span><br>    <span class="hljs-keyword">return</span> suggestList;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-5-日志收集logstash"><a href="#2-5-日志收集logstash" class="headerlink" title="2.5 日志收集logstash"></a>2.5 日志收集logstash</h2><h3 id="2-5-1-添加logstash配置文件"><a href="#2-5-1-添加logstash配置文件" class="headerlink" title="2.5.1 添加logstash配置文件"></a>2.5.1 添加logstash配置文件</h3><p>修改配置文件：logback-spring.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"># 打开logstash 注释<br><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;LOGSTASH&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- logstash ip和暴露的端口，logback就是通过这个地址把日志发送给logstash --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">destination</span>&gt;</span>192.168.200.130:5044<span class="hljs-tag">&lt;/<span class="hljs-name">destination</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;net.logstash.logback.encoder.LogstashEncoder&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br># 打开日志收集配置<br><span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;LOGSTASH&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-2-在service模块中添加依赖-jar-包"><a href="#2-5-2-在service模块中添加依赖-jar-包" class="headerlink" title="2.5.2 在service模块中添加依赖 jar 包"></a>2.5.2 在service模块中添加依赖 jar 包</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.logstash.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="2-5-3-启动项目测试"><a href="#2-5-3-启动项目测试" class="headerlink" title="2.5.3 启动项目测试"></a>2.5.3 启动项目测试</h3>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/" class="category-chain-item">云悦听</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>4-2、专辑检索</div>
      <div>http://example.com/2024/11/10/项目/云悦听/第4章 专辑检索/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>pz</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年11月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/11/15/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC5%E7%AB%A0%20%E8%AF%A6%E6%83%85%E4%BB%8B%E7%BB%8D/" title="5-2、专辑详情">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">5-2、专辑详情</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC4%E7%AB%A0%20ElasticSearch%E5%85%A5%E9%97%A8/" title="4-1、ElasticSearch">
                        <span class="hidden-mobile">4-1、ElasticSearch</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/headerPic.js"></script><!-- hexo injector body_end end --></body>
</html>
