

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://p0.itc.cn/q_70/images03/20230516/bab1646e504942d4a9d964cde5d8b15d.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pz">
  <meta name="keywords" content="">
  
    <meta name="description" content="第7章 订单购买1.1 业务介绍购买专辑分为：购买专辑，购买声音，vip余额购买 在首页点击VIP免费 会出现访问VIP服务配置管理接口       1.2 获取vip服务配置信息在service-user 微服务模块中的  VipServiceConfigApiController 控制器添加映射路径，返回 VipServiceConfig 实体类的集合数据。也就是查询vip_service_c">
<meta property="og:type" content="article">
<meta property="og:title" content="7、订单购买">
<meta property="og:url" content="http://example.com/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/index.html">
<meta property="og:site_name" content="PZ">
<meta property="og:description" content="第7章 订单购买1.1 业务介绍购买专辑分为：购买专辑，购买声音，vip余额购买 在首页点击VIP免费 会出现访问VIP服务配置管理接口       1.2 获取vip服务配置信息在service-user 微服务模块中的  VipServiceConfigApiController 控制器添加映射路径，返回 VipServiceConfig 实体类的集合数据。也就是查询vip_service_c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/yunyueting.png">
<meta property="article:published_time" content="2024-11-18T04:46:21.000Z">
<meta property="article:modified_time" content="2025-01-29T06:11:50.000Z">
<meta property="article:author" content="pz">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/yunyueting.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>7、订单购买 - PZ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<script src="/safe-go/go.js"></script>

<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>PZ</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/null') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="7、订单购买"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-11-18 12:46" pubdate>
          2024年11月18日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          96 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">7、订单购买</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="第7章-订单购买"><a href="#第7章-订单购买" class="headerlink" title="第7章 订单购买"></a>第7章 订单购买</h1><h3 id="1-1-业务介绍"><a href="#1-1-业务介绍" class="headerlink" title="1.1 业务介绍"></a>1.1 业务介绍</h3><p>购买专辑分为：购买专辑，购买声音，vip余额购买</p>
<p>在<strong>首页</strong>点击<strong>VIP免费</strong> 会出现访问VIP服务配置管理接口</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/%E8%AE%A2%E5%8D%95-VIP%E8%B4%AD%E4%B9%B0%E5%85%A5%E5%8F%A3.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![订单-VIP购买入口](第7章 订单/订单-VIP购买入口.gif)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu026.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu026.png)

-->

<h3 id><a href="#" class="headerlink" title></a></h3><h3 id="1-2-获取vip服务配置信息"><a href="#1-2-获取vip服务配置信息" class="headerlink" title="1.2 获取vip服务配置信息"></a>1.2 获取vip服务配置信息</h3><p>在service-user 微服务模块中的  VipServiceConfigApiController 控制器添加映射路径，返回 VipServiceConfig 实体类的集合数据。也就是查询vip_service_config表中的集合数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.user.api;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.VipServiceConfig;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.service.VipServiceConfigService;<br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.Operation;<br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.tags.Tag;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Tag(name = &quot;VIP服务配置管理接口&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;api/user/vipServiceConfig&quot;)</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VipServiceConfigApiController</span> &#123;<br><br>	<span class="hljs-meta">@Autowired</span><br>	<span class="hljs-keyword">private</span> VipServiceConfigService vipServiceConfigService;<br><br>	<span class="hljs-meta">@Operation(summary = &quot;获取全部VIP 服务配置信息&quot;)</span><br>	<span class="hljs-meta">@GetMapping(&quot;findAll&quot;)</span><br>	<span class="hljs-keyword">public</span> Result&lt;List&lt;VipServiceConfig&gt;&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>&#123;<br>		<span class="hljs-comment">//	调用服务层方法</span><br>		List&lt;VipServiceConfig&gt; list = <span class="hljs-built_in">this</span>.vipServiceConfigService.list();<br>		<span class="hljs-keyword">return</span> Result.ok(list);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-购买专辑与vip订单"><a href="#1-3-购买专辑与vip订单" class="headerlink" title="1.3 购买专辑与vip订单"></a>1.3 购买专辑与vip订单</h3><p>购买VIP入口：</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/%E8%AE%A2%E5%8D%95-%E8%8E%B7%E5%8F%96Vip%E5%A5%97%E9%A4%90%E5%88%97%E8%A1%A8.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![订单-获取Vip套餐列表](第7章 订单/订单-获取Vip套餐列表.gif)

-->



<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu028.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu028.png)

-->

<p>购买专辑入口：<strong>看专辑表的price_type 类型 0201 单独购买声音 0202 只能购买整张专辑</strong></p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/%E8%AE%A2%E5%8D%95-%E4%B8%93%E8%BE%91%E8%B4%AD%E4%B9%B0%E5%85%A5%E5%8F%A3.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![订单-专辑购买入口](第7章 订单/订单-专辑购买入口.gif)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu062.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu062.png)

-->

<p>购买声音入口：暂无，有的专辑支持单独购买声音才能看见 购买声音的控制器！</p>
<p>会出现下订单的控制器：<a target="_blank" rel="noopener" href="http://127.0.0.1/api/order/orderInfo/trade">http://127.0.0.1/api/order/orderInfo/trade</a></p>
<p>访问订单控制器时，将提交的数据封装到当前实体对象中 TradeVo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Schema(description = &quot;订单确认对象&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TradeVo</span> &#123;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;付款项目类型不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;付款项目类型: 1001-专辑 1002-声音 1003-vip会员&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String itemType;<br><br>    <span class="hljs-meta">@Positive(message = &quot;付款项目类型Id不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;付款项目类型Id&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Long itemId;<br><br>    <span class="hljs-meta">@Schema(description = &quot;针对声音购买，购买当前集往后多少集&quot;, required = false)</span><br>    <span class="hljs-keyword">private</span> Integer trackCount;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>将返回数据封装到 OrderInfoVo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.vo.order;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.util.Decimal2Serializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;<br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;<br><span class="hljs-keyword">import</span> jakarta.validation.Valid;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.DecimalMax;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.DecimalMin;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.Digits;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.NotEmpty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Schema(description = &quot;订单对象&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderInfoVo</span> &#123;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;交易号不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;交易号&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String tradeNo;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;支付方式不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;支付方式：1101-微信 1102-支付宝 1103-账户余额&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String payWay;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;付款项目类型不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;付款项目类型: 1001-专辑 1002-声音 1003-vip会员&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String itemType;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * value：最小值</span><br><span class="hljs-comment">     * inclusive：是否可以等于最小值，默认true，&gt;= 最小值</span><br><span class="hljs-comment">     * message：错误提示（默认有一个错误提示i18n支持中文）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@DecimalMax</span> 同上</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Digits</span> integer： 整数位最多几位</span><br><span class="hljs-comment">     * fraction：小数位最多几位</span><br><span class="hljs-comment">     * message：同上，有默认提示</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@DecimalMin(value = &quot;0.00&quot;, inclusive = false, message = &quot;订单原始金额必须大于0.00&quot;)</span><br>    <span class="hljs-meta">@DecimalMax(value = &quot;9999.99&quot;, inclusive = true, message = &quot;订单原始金额必须大于9999.99&quot;)</span><br>    <span class="hljs-meta">@Digits(integer = 4, fraction = 2)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单原始金额&quot;, required = true)</span><br>    <span class="hljs-meta">@JsonSerialize(using = Decimal2Serializer.class)</span><br>    <span class="hljs-keyword">private</span> BigDecimal originalAmount;<br><br>    <span class="hljs-meta">@DecimalMin(value = &quot;0.00&quot;, inclusive = true, message = &quot;减免总金额必须大于0.00&quot;)</span><br>    <span class="hljs-meta">@DecimalMax(value = &quot;9999.99&quot;, inclusive = true, message = &quot;减免总金额必须大于9999.99&quot;)</span><br>    <span class="hljs-meta">@Digits(integer = 4, fraction = 2)</span><br>    <span class="hljs-meta">@Schema(description = &quot;减免总金额&quot;, required = true)</span><br>    <span class="hljs-meta">@JsonSerialize(using = Decimal2Serializer.class)</span><br>    <span class="hljs-keyword">private</span> BigDecimal derateAmount;<br><br>    <span class="hljs-meta">@DecimalMin(value = &quot;0.00&quot;, inclusive = false, message = &quot;订单总金额必须大于0.00&quot;)</span><br>    <span class="hljs-meta">@DecimalMax(value = &quot;9999.99&quot;, inclusive = true, message = &quot;订单总金额必须大于9999.99&quot;)</span><br>    <span class="hljs-meta">@Digits(integer = 4, fraction = 2)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单总金额&quot;, required = true)</span><br>    <span class="hljs-meta">@JsonSerialize(using = Decimal2Serializer.class)</span><br>    <span class="hljs-keyword">private</span> BigDecimal orderAmount;<br><br>    <span class="hljs-meta">@Valid</span><br>    <span class="hljs-meta">@NotEmpty(message = &quot;订单明细列表不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单明细列表&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderDetailVo&gt; orderDetailVoList;<br><br>    <span class="hljs-meta">@Schema(description = &quot;订单减免明细列表&quot;)</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderDerateVo&gt; orderDerateVoList;<br><br>    <span class="hljs-meta">@Schema(description = &quot;时间戳&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Long timestamp;<br>    <br>    <span class="hljs-comment">// 校验订单数据：防止用户通过非法手段，改变订单的信息!</span><br>    <span class="hljs-meta">@Schema(description = &quot;签名&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String sign;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-3-1-控制器"><a href="#1-3-1-控制器" class="headerlink" title="1.3.1 控制器"></a>1.3.1 控制器</h4><p>在service-order 微服务中编写确定订单控制器 ，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.order.api;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.login.YunYueTingLogin;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.util.AuthContextHolder;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.order.service.OrderInfoService;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.vo.order.OrderInfoVo;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.vo.order.TradeVo;<br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.Operation;<br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.tags.Tag;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.validation.annotation.Validated;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@Tag(name = &quot;订单管理&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;api/order/orderInfo&quot;)</span><br><span class="hljs-meta">@SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderInfoApiController</span> &#123;<br><br>	<span class="hljs-meta">@Autowired</span><br>	<span class="hljs-keyword">private</span> OrderInfoService orderInfoService;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 确认订单</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> tradeVo</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@YunYueTingLogin</span><br>	<span class="hljs-meta">@Operation(summary = &quot;确认订单&quot;)</span><br>	<span class="hljs-meta">@PostMapping(&quot;trade&quot;)</span><br>	<span class="hljs-keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="hljs-title function_">trade</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated</span> TradeVo tradeVo)</span> &#123;<br>		<span class="hljs-comment">// 获取到用户Id</span><br>		<span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> AuthContextHolder.getUserId();<br>		<span class="hljs-comment">//	调用服务层方法</span><br>		<span class="hljs-type">OrderInfoVo</span> <span class="hljs-variable">orderInfoVo</span> <span class="hljs-operator">=</span> orderInfoService.trade(tradeVo, userId);<br>		<span class="hljs-comment">//	返回数据</span><br>		<span class="hljs-keyword">return</span> Result.ok(orderInfoVo);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-3-2-接口与实现"><a href="#1-3-2-接口与实现" class="headerlink" title="1.3.2 接口与实现"></a>1.3.2 接口与实现</h4><p>思路：</p>
<ol>
<li>专辑订单<ol>
<li>判断用户是否购买过专辑<ol>
<li>如果已购买抛出异常</li>
<li>未购买{要给订单明细，减免金额，总金额等属性赋值}<ol>
<li>判断用户是否属于vip<ol>
<li>vip  计算订单总价与折扣价 赋值订单明细与减免明细</li>
<li>非vip 计算订单总价与折扣价 赋值订单明细与减免明细</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>vip 订单<ol>
<li>根据Id 获取到vip 配置信息</li>
<li>赋值原始金额，减免金额，总金额，订单明细，减免金额</li>
</ol>
</li>
<li>生成一个流水号存储到缓存，防止用户重复提交订单</li>
<li>给OrderInfoVo 实体类赋值<ol>
<li>防止用户非法操作订单金额，将订单对象OrderInfoVo变为字符串，在转换为map。在通过工具类SignHelper将map 变为字符串赋值给签名字段</li>
</ol>
</li>
<li>最后返回OrderInfoVo 对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderInfoService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;OrderInfo&gt; &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 确定订单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> tradeVo</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    OrderInfoVo <span class="hljs-title function_">trade</span><span class="hljs-params">(TradeVo tradeVo, Long userId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderInfoVo <span class="hljs-title function_">trade</span><span class="hljs-params">(TradeVo tradeVo, Long userId)</span> &#123;<br>  <span class="hljs-comment">//获取用户信息</span><br>  Result&lt;UserInfoVo&gt; userInfoVoResult = userInfoFeignClient.getUserInfoVo(userId);<br>  Assert.notNull(userInfoVoResult);<br>  <span class="hljs-type">UserInfoVo</span> <span class="hljs-variable">userInfoVo</span> <span class="hljs-operator">=</span> userInfoVoResult.getData();<br>  Assert.notNull(userInfoVo);<br>  <span class="hljs-comment">//  订单原始金额</span><br>  <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">originalAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.00&quot;</span>);<br>  <span class="hljs-comment">//  减免总金额</span><br>  <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">derateAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.00&quot;</span>);<br>  <span class="hljs-comment">//  订单总价</span><br>  <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">orderAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.00&quot;</span>);<br>  <span class="hljs-comment">//  订单明细集合</span><br>  List&lt;OrderDetailVo&gt; orderDetailVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  <span class="hljs-comment">//  订单减免明细列表</span><br>  List&lt;OrderDerateVo&gt; orderDerateVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>  <span class="hljs-comment">//  1001 专辑</span><br>  <span class="hljs-keyword">if</span> (tradeVo.getItemType().equals(SystemConstant.ORDER_ITEM_TYPE_ALBUM))&#123;<br>    <span class="hljs-comment">//  判断用户是否购买过专辑</span><br>    Result&lt;Boolean&gt; isPaidAlbumResult = <span class="hljs-built_in">this</span>.userInfoFeignClient.isPaidAlbum(tradeVo.getItemId());<br>    Assert.notNull(isPaidAlbumResult);<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">isPaidAlbum</span> <span class="hljs-operator">=</span> isPaidAlbumResult.getData();<br>    Assert.notNull(isPaidAlbum);<br>    <span class="hljs-keyword">if</span> (isPaidAlbum)&#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.REPEAT_BUY_ERROR);<br>    &#125;<br>    <span class="hljs-comment">//  根据专辑Id 获取到专辑数据</span><br>    Result&lt;AlbumInfo&gt; albumInfoResult = albumInfoFeignClient.getAlbumInfo(tradeVo.getItemId());<br>    Assert.notNull(albumInfoResult,<span class="hljs-string">&quot;返回专辑结果集不能为空&quot;</span>);<br>    <span class="hljs-type">AlbumInfo</span> <span class="hljs-variable">albumInfo</span> <span class="hljs-operator">=</span> albumInfoResult.getData();<br>    Assert.notNull(albumInfo,<span class="hljs-string">&quot;专辑对象不能为空&quot;</span>);<br>    <span class="hljs-comment">//  判断当前用户是否是vip</span><br>    <span class="hljs-keyword">if</span> (userInfoVo.getIsVip().intValue()==<span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-comment">//  非VIP 用户</span><br>      originalAmount = albumInfo.getPrice();<br>      <span class="hljs-comment">//  判断是否打折 , 不等于-1 就是打折</span><br>      <span class="hljs-keyword">if</span> (albumInfo.getDiscount().intValue() != -<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-comment">//  打折 100 8  100*0.8</span><br>        derateAmount = originalAmount.multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;10&quot;</span>).subtract(albumInfo.getDiscount())).divide(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">10</span>),<span class="hljs-number">2</span>, RoundingMode.HALF_UP);<br>      &#125;<br>      <span class="hljs-comment">//  订单总价</span><br>      orderAmount = originalAmount.subtract(derateAmount);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// VIP会员</span><br>      originalAmount = albumInfo.getPrice();<br>      <span class="hljs-comment">//discount=-1,不打折，折扣如：8折 9.5折</span><br>      <span class="hljs-keyword">if</span> (albumInfo.getVipDiscount().intValue() != -<span class="hljs-number">1</span>) &#123;<br>        derateAmount = albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">10</span>).subtract(albumInfo.getVipDiscount())).divide(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">10</span>), <span class="hljs-number">2</span>, RoundingMode.HALF_UP);<br>      &#125;<br>      <span class="hljs-comment">//  订单总价</span><br>      orderAmount = originalAmount.subtract(derateAmount);<br>    &#125;                              <br>    <span class="hljs-comment">//  订单明细</span><br>    <span class="hljs-type">OrderDetailVo</span> <span class="hljs-variable">orderDetailVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetailVo</span>();<br>    orderDetailVo.setItemId(tradeVo.getItemId());<br>    orderDetailVo.setItemName(albumInfo.getAlbumTitle());<br>    orderDetailVo.setItemUrl(albumInfo.getCoverUrl());<br>    orderDetailVo.setItemPrice(albumInfo.getPrice());<br>    orderDetailVoList.add(orderDetailVo);<br><br>    <span class="hljs-comment">//  添加订单减免</span><br>    <span class="hljs-keyword">if</span> (originalAmount.subtract(orderAmount).doubleValue() != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-type">OrderDerateVo</span> <span class="hljs-variable">orderDerateVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDerateVo</span>();<br>      orderDerateVo.setDerateType(SystemConstant.ORDER_DERATE_ALBUM_DISCOUNT);<br>      orderDerateVo.setDerateAmount(originalAmount.subtract(orderAmount));<br>      orderDerateVoList.add(orderDerateVo);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tradeVo.getItemType().equals(SystemConstant.ORDER_ITEM_TYPE_VIP))&#123;<br>    <span class="hljs-comment">//  根据id 获取VIP 服务配置信息</span><br>    Result&lt;VipServiceConfig&gt; vipServiceConfigResult = vipServiceConfigFeignClient.getVipServiceConfig(tradeVo.getItemId());<br>    Assert.notNull(vipServiceConfigResult,<span class="hljs-string">&quot;返回vip配置结果集不能为空&quot;</span>);<br>    <span class="hljs-type">VipServiceConfig</span> <span class="hljs-variable">vipServiceConfig</span> <span class="hljs-operator">=</span> vipServiceConfigResult.getData();<br>    Assert.notNull(vipServiceConfig,<span class="hljs-string">&quot;返回vip配置对象不能为空&quot;</span>);<br><br>    originalAmount = vipServiceConfig.getPrice();<br>    derateAmount = vipServiceConfig.getPrice().subtract(vipServiceConfig.getDiscountPrice());<br>    orderAmount = originalAmount.subtract(derateAmount);<br><br>    <span class="hljs-comment">//订单明细</span><br>    <span class="hljs-type">OrderDetailVo</span> <span class="hljs-variable">orderDetailVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetailVo</span>();<br>    orderDetailVo.setItemId(tradeVo.getItemId());<br>    orderDetailVo.setItemName(<span class="hljs-string">&quot;VIP会员&quot;</span>+vipServiceConfig.getName());<br>    orderDetailVo.setItemUrl(vipServiceConfig.getImageUrl());<br>    orderDetailVo.setItemPrice(vipServiceConfig.getDiscountPrice());<br>    orderDetailVoList.add(orderDetailVo);<br><br>    <span class="hljs-comment">//添加订单减免</span><br>    <span class="hljs-keyword">if</span> (originalAmount.subtract(orderAmount).doubleValue() != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-type">OrderDerateVo</span> <span class="hljs-variable">orderDerateVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDerateVo</span>();<br>      orderDerateVo.setDerateType(SystemConstant.ORDER_DERATE_VIP_SERVICE_DISCOUNT);<br>      orderDerateVo.setDerateAmount(originalAmount.subtract(orderAmount));<br>      orderDerateVoList.add(orderDerateVo);<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 防重：生成一个唯一标识，保存到redis中一份</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">tradeNoKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:trade:&quot;</span> + userId;<br>  <span class="hljs-comment">// 定义一个流水号</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">tradeNo</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>  redisTemplate.opsForValue().set(tradeNoKey, tradeNo);<br><br>  <span class="hljs-comment">//构造结果</span><br>  <span class="hljs-type">OrderInfoVo</span> <span class="hljs-variable">orderInfoVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfoVo</span>();<br>  orderInfoVo.setItemType(tradeVo.getItemType());<br>  orderInfoVo.setOriginalAmount(originalAmount);<br>  orderInfoVo.setDerateAmount(derateAmount);<br>  orderInfoVo.setOrderAmount(orderAmount);<br>  orderInfoVo.setTradeNo(tradeNo);<br>  orderInfoVo.setOrderDetailVoList(orderDetailVoList);<br>  orderInfoVo.setOrderDerateVoList(orderDerateVoList);<br>  orderInfoVo.setTimestamp(SignHelper.getTimestamp());<br>  <span class="hljs-comment">//  支付方式默认值 目的是防止用户在前端篡改金额数据</span><br>  orderInfoVo.setPayWay(SystemConstant.ORDER_PAY_WAY_WEIXIN);<br>  <span class="hljs-comment">//  生成签名</span><br>  Map&lt;String, Object&gt; parameterMap = JSON.parseObject(JSON.toJSONString(orderInfoVo), Map.class);<br>  <span class="hljs-comment">// &#123;&quot;orderDerateVoList&quot;:[&#123;&quot;derateType&quot;:&quot;1406&quot;,&quot;derateAmount&quot;:20.00&#125;],&quot;itemType&quot;:&quot;1003&quot;,&quot;orderAmount&quot;:40.00,&quot;originalAmount&quot;:60.00,&quot;tradeNo&quot;:&quot;ed2628826ba54ebfa41632f9173a780d&quot;,&quot;derateAmount&quot;:20.00,&quot;payWay&quot;:&quot;&quot;,&quot;orderDetailVoList&quot;:[&#123;&quot;itemId&quot;:2,&quot;itemName&quot;:&quot;购买VIP3个月&quot;,&quot;itemPrice&quot;:40.00,&quot;itemUrl&quot;:&quot;http://39.98.123.211/group1/vip.png&quot;&#125;],&quot;timestamp&quot;:1699606865851&#125;</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> SignHelper.getSign(parameterMap);<br>  orderInfoVo.setSign(sign);<br>  <span class="hljs-comment">//  返回对象</span><br>  <span class="hljs-keyword">return</span> orderInfoVo;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-4-确定订单远程调用方法"><a href="#1-4-确定订单远程调用方法" class="headerlink" title="1.4 确定订单远程调用方法"></a>1.4 确定订单远程调用方法</h3><p>在service-util 微服务中添加远程 feign 远程调用拦截器，来获取token 数据。</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu063.jpg" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu063.jpg)

-->

<p>如上图：因为微服务之间并没有传递头文件，所以我们可以定义一个拦截器，每次微服务调用之前都先检查下头文件，将请求的头文件中的用户信息再放入到header中，再调用其他微服务即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.common.interceptor;<br><br><span class="hljs-keyword">import</span> feign.RequestInterceptor;<br><span class="hljs-keyword">import</span> feign.RequestTemplate;<br><span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span>&#123;<br>        <span class="hljs-comment">//  获取请求对象</span><br>        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">requestAttributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();<br>        <span class="hljs-comment">//异步编排 与 MQ消费者端 为 null</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != requestAttributes) &#123;<br>            <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">servletRequestAttributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes)requestAttributes;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> servletRequestAttributes.getRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>            requestTemplate.header(<span class="hljs-string">&quot;token&quot;</span>, token);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="1-4-1-判断用户是否购买过专辑"><a href="#1-4-1-判断用户是否购买过专辑" class="headerlink" title="1.4.1 判断用户是否购买过专辑"></a>1.4.1 判断用户是否购买过专辑</h4><p>service-user-client 远程调用 UserInfoFeignClient 添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 判断用户是否购买过专辑</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;api/user/userInfo/isPaidAlbum/&#123;albumId&#125;&quot;)</span><br>Result&lt;Boolean&gt; <span class="hljs-title function_">isPaidAlbum</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;albumId&quot;)</span> Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<p>熔断类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result&lt;Boolean&gt; <span class="hljs-title function_">isPaidAlbum</span><span class="hljs-params">(Long albumId)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service-user 微服务的控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 判断用户是否购买过专辑</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;判断用户是否购买过专辑&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;isPaidAlbum/&#123;albumId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;Boolean&gt; <span class="hljs-title function_">isPaidAlbum</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long albumId)</span> &#123;<br>   <span class="hljs-comment">// 获取到用户Id</span><br>   <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> AuthContextHolder.getUserId();<br>   <span class="hljs-comment">// 调用服务层方法</span><br>   <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> userInfoService.isPaidAlbum(userId, albumId);<br>   <span class="hljs-keyword">return</span> Result.ok(flag);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口与实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据用户Id 与专辑Id 查询结果</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returnx</span></span><br><span class="hljs-comment"> */</span><br>Boolean <span class="hljs-title function_">isPaidAlbum</span><span class="hljs-params">(Long userId, Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">isPaidAlbum</span><span class="hljs-params">(Long userId, Long albumId)</span> &#123;<br>   <span class="hljs-comment">// 根据用户Id 与专辑Id 查询是否有记录</span><br>   <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> userPaidAlbumMapper.selectCount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;UserPaidAlbum&gt;().eq(UserPaidAlbum::getUserId, userId).eq(UserPaidAlbum::getAlbumId, albumId));<br>   <span class="hljs-keyword">if</span> (count&gt;<span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>   &#125;<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="1-4-2-根据Id-获取vip-配置信息"><a href="#1-4-2-根据Id-获取vip-配置信息" class="headerlink" title="1.4.2 根据Id 获取vip 配置信息"></a>1.4.2 根据Id 获取vip 配置信息</h4><p>在service-user-client 模块中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.album.client;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.album.client.impl.VipServiceConfigDegradeFeignClient;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.VipServiceConfig;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 产品列表API接口</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = &quot;service-user&quot;, fallback = VipServiceConfigDegradeFeignClient.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">VipServiceConfigFeignClient</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据itemId获取VIP服务配置信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;api/user/vipServiceConfig/getVipServiceConfig/&#123;id&#125;&quot;)</span><br>    Result&lt;VipServiceConfig&gt; <span class="hljs-title function_">getVipServiceConfig</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>熔断类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.album.client.impl;<br><br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.album.client.VipServiceConfigFeignClient;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.VipServiceConfig;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VipServiceConfigDegradeFeignClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VipServiceConfigFeignClient</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result&lt;VipServiceConfig&gt; <span class="hljs-title function_">getVipServiceConfig</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service-user 微服务模块添加控制器</p>
<p>在VipServiceConfigApiController控制器中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id获取VIP服务配置信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;根据id获取VIP服务配置信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;getVipServiceConfig/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;VipServiceConfig&gt; <span class="hljs-title function_">getVipServiceConfig</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>  <span class="hljs-keyword">return</span> Result.ok(vipServiceConfigService.getById(id));<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-5-获取账户余额"><a href="#1-5-获取账户余额" class="headerlink" title="1.5 获取账户余额"></a>1.5 获取账户余额</h3><p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/%E8%AE%A2%E5%8D%95-%E6%88%91%E7%9A%84%E9%92%B1%E5%8C%85.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![订单-我的钱包](第7章 订单/订单-我的钱包.gif)

-->

<h4 id="1-5-1-初始化账户"><a href="#1-5-1-初始化账户" class="headerlink" title="1.5.1 初始化账户"></a>1.5.1 初始化账户</h4><p>在用户注册的时候，就进行了初始化信息操作！</p>
<h4 id="1-5-2-显示账户的余额"><a href="#1-5-2-显示账户的余额" class="headerlink" title="1.5.2 显示账户的余额"></a>1.5.2 显示账户的余额</h4><p>当刷新主页的时候，会加载当前余额数据。</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu032.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu032.png)

-->

<p>service-account 微服务中UserAccountApiController</p>
<p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取账户可用余额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;获取账号可用金额&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;getAvailableAmount&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;BigDecimal&gt; <span class="hljs-title function_">getAvailableAmount</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-comment">//	调用服务层方法</span><br>	<span class="hljs-keyword">return</span> Result.ok(userAccountService.getAvailableAmount(AuthContextHolder.getUserId()));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取账户可用余额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>BigDecimal <span class="hljs-title function_">getAvailableAmount</span><span class="hljs-params">(Long userId)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据用户Id 获取到可用余额对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>UserAccount <span class="hljs-title function_">getUserAccountByUserId</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getAvailableAmount</span><span class="hljs-params">(Long userId)</span> &#123;<br>  <span class="hljs-comment">//	根据用户Id 获取到用户余额对象</span><br>  <span class="hljs-type">UserAccount</span> <span class="hljs-variable">userAccount</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserAccountByUserId(userId);<br>  <span class="hljs-keyword">return</span> userAccount.getAvailableAmount();<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserAccount <span class="hljs-title function_">getUserAccountByUserId</span><span class="hljs-params">(Long userId)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;UserAccount&gt;().eq(UserAccount::getUserId, userId));<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-6-获取用户声音分集购买支付列表"><a href="#1-6-获取用户声音分集购买支付列表" class="headerlink" title="1.6 获取用户声音分集购买支付列表"></a>1.6 获取用户声音分集购买支付列表</h3><p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/%E8%AE%A2%E5%8D%95-%E5%A3%B0%E9%9F%B3%E7%BB%93%E7%AE%97.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![订单-声音结算](第7章 订单/订单-声音结算.gif)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu035.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu035.png)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu040.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu040.png)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu036.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu036.png)

-->

<p><a target="_blank" rel="noopener" href="http://127.0.0.1/api/album/trackInfo/findUserTrackPaidList/20759">http://127.0.0.1/api/album/trackInfo/findUserTrackPaidList/20759</a></p>
<h4 id="1-6-1-控制器"><a href="#1-6-1-控制器" class="headerlink" title="1.6.1 控制器"></a>1.6.1 控制器</h4><p>TrackInfoApiController 控制器返回数据格式如下： 因为当前专辑只支持单集购买！专辑的价格是 album_info.price –&gt; 当前专辑中的一条声音的价格  <strong>声音总价 &#x3D; album_info.price*trackCount</strong></p>
<p>album_info 表中 price_type类型分为： <strong>0201-单集</strong> 0202-整专辑 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>map.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;本集&quot;</span>); <span class="hljs-comment">// 显示文本</span><br>map.put(<span class="hljs-string">&quot;price&quot;</span>,albumInfo.getPrice()); <span class="hljs-comment">// 专辑声音对应的价格</span><br>map.put(<span class="hljs-string">&quot;trackCount&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">// 记录购买集数</span><br>list.add(map);<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取用户声音分集购买支付列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> trackId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;获取用户声音分集购买支付列表&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/findUserTrackPaidList/&#123;trackId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; <span class="hljs-title function_">findUserTrackPaidList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long trackId)</span> &#123;<br>   <span class="hljs-comment">// 获取购买记录集合</span><br>   List&lt;Map&lt;String,Object&gt;&gt; map = trackInfoService.findUserTrackPaidList(trackId);<br>   <span class="hljs-keyword">return</span> Result.ok(map);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-6-2-接口与实现"><a href="#1-6-2-接口与实现" class="headerlink" title="1.6.2 接口与实现"></a>1.6.2 接口与实现</h4><p>思路：</p>
<ol>
<li>先根据专辑Id **{用户Id}**获取到专辑对应的声音Id集合列表</li>
<li>获取到当前专辑{albumId}中大于{orderNum}当前声音Id的集合列表</li>
<li>获取到当前要支付的声音Id 列表{ 2 与 1 做一个排除即可 }</li>
<li>构造声音分集购买列表</li>
</ol>
<p>mybatis-plus 中的一些比较符号含义</p>
<p>lt：less than 小于<br>le：less than or equal to 小于等于<br>eq：equal to 等于<br>ne：not equal to 不等于<br>ge：greater than or equal to 大于等于<br>gt：greater than 大于</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据声音Id 获取购买列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> trackId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">findUserTrackPaidList</span><span class="hljs-params">(Long trackId)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">findUserTrackPaidList</span><span class="hljs-params">(Long trackId)</span> &#123;<br>   <span class="hljs-comment">// 获取声音对象</span><br>   <span class="hljs-type">TrackInfo</span> <span class="hljs-variable">trackInfo</span> <span class="hljs-operator">=</span> trackInfoMapper.selectById(trackId);<br>   <span class="hljs-comment">// 获取到专辑对象</span><br>   <span class="hljs-type">AlbumInfo</span> <span class="hljs-variable">albumInfo</span> <span class="hljs-operator">=</span> albumInfoService.getById(trackInfo.getAlbumId());<br>   <span class="hljs-comment">// 根据专辑Id 获取到声音Id集合</span><br>   Result&lt;List&lt;Long&gt;&gt; trackIdListResult = userInfoFeignClient.findUserPaidTrackList(trackInfo.getAlbumId());<br>   Assert.notNull(trackIdListResult,<span class="hljs-string">&quot;专辑Id集合不为空&quot;</span>);<br>   List&lt;Long&gt; trackIdList = trackIdListResult.getData();<br>   Assert.notNull(trackIdList,<span class="hljs-string">&quot;声音专辑Id 不为空&quot;</span>);<br><br>   <span class="hljs-comment">// 获取当前专辑并且大于当前声音的全部声音Id</span><br>   List&lt;TrackInfo&gt; trackInfoList = trackInfoMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;TrackInfo&gt;().eq(TrackInfo::getAlbumId, trackInfo.getAlbumId()).gt(TrackInfo::getOrderNum, trackInfo.getOrderNum()).select(TrackInfo::getId));<br>   List&lt;Long&gt; trackIdAllList = trackInfoList.stream().map(TrackInfo::getId).collect(Collectors.toList());<br>   <span class="hljs-comment">// 去除已经支付的</span><br>   List&lt;Long&gt; trackIdNoReaptList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>   <span class="hljs-keyword">if</span>(CollectionUtils.isEmpty(trackIdList)) &#123;<br>      trackIdNoReaptList = trackIdAllList;<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 获取没有购买的声音Id</span><br>      trackIdNoReaptList = trackIdAllList.stream().filter(itemId -&gt; !trackIdList.contains(itemId)).collect(Collectors.toList());<br>   &#125;<br><br>   <span class="hljs-comment">// 构造声音分集购买数据列表</span><br>   List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>   <span class="hljs-comment">// 需要付款的集数有 19</span><br>   <span class="hljs-comment">// 本集</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt;= <span class="hljs-number">0</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;本集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, albumInfo.getPrice());<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, <span class="hljs-number">0</span>);<br>      list.add(map);<br>   &#125;<br><br>   <span class="hljs-comment">//后10集</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">0</span> &amp;&amp; trackIdNoReaptList.size() &lt;= <span class="hljs-number">10</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> trackIdNoReaptList.size();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(count));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后&quot;</span>+trackIdNoReaptList.size()+<span class="hljs-string">&quot;集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, count);<br>      list.add(map);<br>   &#125;<br>   <span class="hljs-comment">// 19</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">10</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">10</span>));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后10集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, <span class="hljs-number">10</span>);<br>      list.add(map);<br>   &#125;<br>   <span class="hljs-comment">// 后20集</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">10</span> &amp;&amp; trackIdNoReaptList.size() &lt;= <span class="hljs-number">20</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> trackIdNoReaptList.size();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(count));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后&quot;</span>+count+<span class="hljs-string">&quot;集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, count);<br>      list.add(map);<br>   &#125;<br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">20</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">20</span>));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后20集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, <span class="hljs-number">20</span>);<br>      list.add(map);<br>   &#125;<br><br>   <span class="hljs-comment">//后30集</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">20</span> &amp;&amp; trackIdNoReaptList.size() &lt;= <span class="hljs-number">30</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> trackIdNoReaptList.size();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(count));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后&quot;</span>+count+<span class="hljs-string">&quot;集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, count);<br>      list.add(map);<br>   &#125;<br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">30</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">30</span>));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后30集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, <span class="hljs-number">30</span>);<br>      list.add(map);<br>   &#125;<br><br>   <span class="hljs-comment">//后50集</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">30</span> &amp;&amp; trackIdNoReaptList.size() &lt;= <span class="hljs-number">50</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> trackIdNoReaptList.size();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(count));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后&quot;</span>+count+<span class="hljs-string">&quot;集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, count);<br>      list.add(map);<br>   &#125;<br>   <span class="hljs-comment">// 最多购买50集;</span><br>   <span class="hljs-keyword">if</span>(trackIdNoReaptList.size() &gt; <span class="hljs-number">50</span>) &#123;<br>      Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>      <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">50</span>));<br>      map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;后50集&quot;</span>);<br>      map.put(<span class="hljs-string">&quot;price&quot;</span>, price);<br>      map.put(<span class="hljs-string">&quot;trackCount&quot;</span>, <span class="hljs-number">50</span>);<br>      list.add(map);<br>   &#125;<br>   <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="1-6-2-1-根据专辑Id-获取到用户已支付声音Id列表"><a href="#1-6-2-1-根据专辑Id-获取到用户已支付声音Id列表" class="headerlink" title="1.6.2.1 根据专辑Id 获取到用户已支付声音Id列表"></a>1.6.2.1 根据专辑Id 获取到用户已支付声音Id列表</h5><p>UserInfoFeignClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取专辑已支付的声音Id集合列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;api/user/userInfo/findUserPaidTrackList/&#123;albumId&#125;&quot;)</span><br>Result&lt;List&lt;Long&gt;&gt; <span class="hljs-title function_">findUserPaidTrackList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<p>熔断类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;Long&gt;&gt; <span class="hljs-title function_">findUserPaidTrackList</span><span class="hljs-params">(Long albumId)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service-user 微服务</p>
<h6 id="1-6-2-1-1-控制器"><a href="#1-6-2-1-1-控制器" class="headerlink" title="1.6.2.1.1 控制器"></a>1.6.2.1.1 控制器</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据专辑Id 获取到用户已支付声音Id列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;根据专辑id获取用户支付过的声音id列表&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;findUserPaidTrackList/&#123;albumId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">findUserPaidTrackList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long albumId)</span>&#123;<br>   <span class="hljs-comment">// 获取用户Id</span><br>   <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> AuthContextHolder.getUserId();<br>   <span class="hljs-comment">// 根据用户Id 与 专辑Id 获取到已购买的声音Id 集合列表</span><br>   List&lt;Long&gt; trackIdList = <span class="hljs-built_in">this</span>.userInfoService.findUserPaidTrackList(userId,albumId);<br>   <span class="hljs-comment">// 返回声音Id 集合数据</span><br>   <span class="hljs-keyword">return</span> Result.ok(trackIdList);<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="1-6-2-1-2-接口与实现类"><a href="#1-6-2-1-2-接口与实现类" class="headerlink" title="1.6.2.1.2 接口与实现类"></a>1.6.2.1.2 接口与实现类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据用户Id 与 专辑Id 获取到已购买的声音Id 集合列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> albumId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>List&lt;Long&gt; <span class="hljs-title function_">findUserPaidTrackList</span><span class="hljs-params">(Long userId, Long albumId)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<p>根据用户Id 与专辑Id 查询已购买的声音列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;Long&gt; <span class="hljs-title function_">findUserPaidTrackList</span><span class="hljs-params">(Long userId, Long albumId)</span> &#123;<br>   <span class="hljs-comment">// 根据用户Id 与 专辑Id 获取到已购买的声音集合</span><br>   List&lt;UserPaidTrack&gt; userPaidTrackList = userPaidTrackMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;UserPaidTrack&gt;().eq(UserPaidTrack::getUserId, userId).eq(UserPaidTrack::getAlbumId, albumId));<br>   <span class="hljs-comment">// 获取到已购买的声音集合Id 列表</span><br>   List&lt;Long&gt; trackIdList = userPaidTrackList.stream().map(UserPaidTrack::getTrackId).collect(Collectors.toList());<br>   <span class="hljs-comment">// 返回集合数据</span><br>   <span class="hljs-keyword">return</span> trackIdList;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-7-购买声音订单"><a href="#1-7-购买声音订单" class="headerlink" title="1.7 购买声音订单"></a>1.7 购买声音订单</h3><h4 id="1-7-1-改造下订单方法"><a href="#1-7-1-改造下订单方法" class="headerlink" title="1.7.1 改造下订单方法"></a>1.7.1 改造下订单方法</h4><p>思路：</p>
<ol>
<li>判断当前购买集数如果小于0则直接抛出异常</li>
<li>根据声音Id，购买集数 获取到下单声音列表 – 详情列表</li>
<li>计算订单总价，原始价格 与 订单明细 （声音不参与折扣）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderInfoVo <span class="hljs-title function_">trade</span><span class="hljs-params">(TradeVo tradeVo, Long userId)</span> &#123;<br>    <span class="hljs-comment">//  获取当前用户对象：</span><br>    Result&lt;UserInfoVo&gt; userInfoVoResult = userInfoFeignClient.getUserInfoVo(userId);<br>    <span class="hljs-type">UserInfoVo</span> <span class="hljs-variable">userInfoVo</span> <span class="hljs-operator">=</span> userInfoVoResult.getData();<br>    <span class="hljs-comment">//  计算金额</span><br>    <span class="hljs-comment">//  订单原始金额</span><br>    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">originalAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.00&quot;</span>);<br>    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">derateAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.00&quot;</span>);<br>    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">orderAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">&quot;0.00&quot;</span>);<br>    <span class="hljs-comment">//  订单明细集合</span><br>    List&lt;OrderDetailVo&gt; orderDetailVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">//  订单减免明细列表</span><br>    List&lt;OrderDerateVo&gt; orderDerateVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-comment">//  判断是否购买专辑 1001</span><br>    <span class="hljs-keyword">if</span> (tradeVo.getItemType().equals(SystemConstant.ORDER_ITEM_TYPE_ALBUM)) &#123;<br>      <span class="hljs-comment">// 此处代码省略....</span><br>      <br>      <span class="hljs-comment">//  购买声音</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tradeVo.getItemType().equals(SystemConstant.ORDER_ITEM_TYPE_TRACK)) &#123;<br>        <span class="hljs-comment">//  判断</span><br>        <span class="hljs-keyword">if</span> (tradeVo.getTrackCount().intValue() &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">YYTException</span>(ResultCodeEnum.ARGUMENT_VALID_ERROR);<br>        &#125;<br>        <span class="hljs-comment">//  获取下单声音列表</span><br>        Result&lt;List&lt;TrackInfo&gt;&gt; trackInfoListResult = trackInfoFeignClient.findPaidTrackInfoList(tradeVo.getItemId(), tradeVo.getTrackCount());<br>        List&lt;TrackInfo&gt; trackInfoList = trackInfoListResult.getData();<br>        <span class="hljs-comment">//  购买声音不支持折扣</span><br>        Result&lt;AlbumInfo&gt; albumInfoResult = albumInfoFeignClient.getAlbumInfo(trackInfoList.get(<span class="hljs-number">0</span>).getAlbumId());<br>        <span class="hljs-type">AlbumInfo</span> <span class="hljs-variable">albumInfo</span> <span class="hljs-operator">=</span> albumInfoResult.getData();<br>        originalAmount = tradeVo.getTrackCount().intValue() &gt; <span class="hljs-number">0</span> ? albumInfo.getPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(tradeVo.getTrackCount())) : albumInfo.getPrice();<br>        <span class="hljs-comment">//  计算订单总价</span><br>        orderAmount = originalAmount;<br><br>        <span class="hljs-comment">//  循环遍历声音集合对象赋值订单明细</span><br>        orderDetailVoList = trackInfoList.stream().map(trackInfo -&gt; &#123;<br>            <span class="hljs-type">OrderDetailVo</span> <span class="hljs-variable">orderDetailVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetailVo</span>();<br>            orderDetailVo.setItemId(trackInfo.getId());<br>            orderDetailVo.setItemUrl(trackInfo.getCoverUrl());<br>            orderDetailVo.setItemPrice(albumInfo.getPrice());<br>            orderDetailVo.setItemName(trackInfo.getTrackTitle());<br>            <span class="hljs-keyword">return</span> orderDetailVo;<br>        &#125;).collect(Collectors.toList());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 此处代码省略....</span><br>      <br>    &#125;<br>    <span class="hljs-comment">// 防重：生成一个唯一标识，保存到redis中一份</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">tradeNoKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:trade:&quot;</span> + userId;<br>    <span class="hljs-comment">// 定义一个流水号</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">tradeNo</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    redisTemplate.opsForValue().set(tradeNoKey, tradeNo);<br><br>    <span class="hljs-comment">//构造结果</span><br>    <span class="hljs-type">OrderInfoVo</span> <span class="hljs-variable">orderInfoVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfoVo</span>();<br>    orderInfoVo.setItemType(tradeVo.getItemType());<br>    orderInfoVo.setOriginalAmount(originalAmount);<br>    orderInfoVo.setDerateAmount(derateAmount);<br>    orderInfoVo.setOrderAmount(orderAmount);<br>    orderInfoVo.setTradeNo(tradeNo);<br>    orderInfoVo.setOrderDetailVoList(orderDetailVoList);<br>    orderInfoVo.setOrderDerateVoList(orderDerateVoList);<br>    orderInfoVo.setTimestamp(SignHelper.getTimestamp());<br>    <span class="hljs-comment">// 默认选择微信支付</span><br>    orderInfoVo.setPayWay(SystemConstant.ORDER_PAY_WAY_WEIXIN);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(JSON.toJSONString(orderInfoVo), Map.class);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> SignHelper.getSign(map);<br>    orderInfoVo.setSign(sign);<br>    <span class="hljs-keyword">return</span> orderInfoVo;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-7-2-远程调用"><a href="#1-7-2-远程调用" class="headerlink" title="1.7.2 远程调用"></a>1.7.2 远程调用</h4><h5 id="1-7-2-1-获取下单声音列表"><a href="#1-7-2-1-获取下单声音列表" class="headerlink" title="1.7.2.1 获取下单声音列表"></a>1.7.2.1 获取下单声音列表</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.album.client;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.album.client.impl.TrackInfoDegradeFeignClient;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.album.TrackInfo;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * 产品列表API接口</span><br><span class="hljs-comment"> * &lt;/p&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = &quot;service-album&quot;, fallback = TrackInfoDegradeFeignClient.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TrackInfoFeignClient</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量获取下单付费声音列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> trackId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> trackCount</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;api/album/trackInfo/findPaidTrackInfoList/&#123;trackId&#125;/&#123;trackCount&#125;&quot;)</span><br>    Result&lt;List&lt;TrackInfo&gt;&gt; <span class="hljs-title function_">findPaidTrackInfoList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;trackId&quot;)</span> Long trackId, <span class="hljs-meta">@PathVariable(&quot;trackCount&quot;)</span> Integer trackCount)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>熔断类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.album.client.impl;<br><br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.album.client.TrackInfoFeignClient;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.result.Result;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.album.TrackInfo;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackInfoDegradeFeignClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TrackInfoFeignClient</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result&lt;List&lt;TrackInfo&gt;&gt; <span class="hljs-title function_">findPaidTrackInfoList</span><span class="hljs-params">(Long trackId, Integer trackCount)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h6 id="1-7-2-1-1-控制器"><a href="#1-7-2-1-1-控制器" class="headerlink" title="1.7.2.1.1 控制器"></a>1.7.2.1.1 控制器</h6><p>service-album 微服务中的TrackInfoApiController控制器添加代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 批量获取下单付费声音列表</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> trackId</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> trackCount</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@Operation(summary = &quot;批量获取下单付费声音列表&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;findPaidTrackInfoList/&#123;trackId&#125;/&#123;trackCount&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;TrackInfo&gt;&gt; <span class="hljs-title function_">findPaidTrackInfoList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long trackId, <span class="hljs-meta">@PathVariable</span> Integer trackCount)</span> &#123;<br>  <span class="hljs-comment">//	调用服务层方法</span><br>  List&lt;TrackInfo&gt; trackInfoList = trackInfoService.findPaidTrackInfoList(trackId, trackCount);<br>  <span class="hljs-comment">//	返回数据列表</span><br>  <span class="hljs-keyword">return</span> Result.ok(trackInfoList);<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="1-7-2-1-2-接口实现类"><a href="#1-7-2-1-2-接口实现类" class="headerlink" title="1.7.2.1.2 接口实现类"></a>1.7.2.1.2 接口实现类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 批量获取下单付费声音列表</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> trackId</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> trackCount</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br>List&lt;TrackInfo&gt; <span class="hljs-title function_">findPaidTrackInfoList</span><span class="hljs-params">(Long trackId, Integer trackCount)</span>;<br></code></pre></td></tr></table></figure>

<p>思路：</p>
<ol>
<li>根据声音Id 获取到当前声音对象</li>
<li>获取已支付的声音Id 列表</li>
<li>判断购买声音的声音集数是否大于0<ol>
<li>大于0</li>
<li>查询当前专辑、并且 大于当前声音顺序号的声音、并且要按照序号进行升序排序 ，如果有已支付的声音Id，一定要除去已购买的声音Id 列表 并添加到返回的集合列表中，同时还要添加限制购买几条声音的条件。</li>
<li>等于0<ol>
<li>将查询的对象直接添加到的集合列表中</li>
</ol>
</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;TrackInfo&gt; <span class="hljs-title function_">findPaidTrackInfoList</span><span class="hljs-params">(Long trackId, Integer trackCount)</span> &#123;<br>   <span class="hljs-comment">// 根据声音Id 获取到声音对象</span><br>   <span class="hljs-type">TrackInfo</span> <span class="hljs-variable">trackInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(trackId);<br>   Assert.notNull(trackInfo,<span class="hljs-string">&quot;声音对象不能为空&quot;</span>);<br><br>   <span class="hljs-comment">// 获取已支付的声音id列表</span><br>   Result&lt;List&lt;Long&gt;&gt; trackIdListResult = userInfoFeignClient.findUserPaidTrackList(trackInfo.getAlbumId());<br>   Assert.notNull(trackIdListResult);<br>   List&lt;Long&gt; trackIdList = trackIdListResult.getData();<br>   Assert.notNull(trackIdList);<br>   <span class="hljs-comment">// 声明一个声音对象集合</span><br>   List&lt;TrackInfo&gt; trackInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>   <span class="hljs-keyword">if</span> (trackCount&gt;<span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-comment">// 构建查询条件</span><br>      LambdaQueryWrapper&lt;TrackInfo&gt; trackInfoLambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>      trackInfoLambdaQueryWrapper.eq(TrackInfo::getAlbumId,trackInfo.getAlbumId());<br>      trackInfoLambdaQueryWrapper.gt(TrackInfo::getOrderNum,trackInfo.getOrderNum());<br>      trackInfoLambdaQueryWrapper.orderByAsc(TrackInfo::getOrderNum);<br>      <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(trackIdList))&#123;<br>         trackInfoLambdaQueryWrapper.notIn(TrackInfo::getId,trackIdList);<br>      &#125;<br>      trackInfoLambdaQueryWrapper.last(<span class="hljs-string">&quot;limit &quot;</span>+trackCount);<br>      trackInfoList = <span class="hljs-built_in">this</span>.list(trackInfoLambdaQueryWrapper);<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      trackInfoList.add(trackInfo);<br>   &#125;<br>   <span class="hljs-comment">// 返回当前集合对象</span><br>   <span class="hljs-keyword">return</span> trackInfoList;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2、提交订单"><a href="#2、提交订单" class="headerlink" title="2、提交订单"></a>2、提交订单</h2><h3 id="2-1-submitOrder业务实现"><a href="#2-1-submitOrder业务实现" class="headerlink" title="2.1 submitOrder业务实现"></a>2.1 submitOrder业务实现</h3><p>在 service-order 微服务中添加提交订单控制器</p>
<ol>
<li><p>校验签名</p>
</li>
<li><p>验证交易号，防止重复提交订单</p>
</li>
<li><p>下单</p>
<ol>
<li><p>微信支付</p>
<ol>
<li>调用保存订单</li>
</ol>
</li>
<li><p>余额支付</p>
<ol>
<li><p>检查扣减金额</p>
</li>
<li><p>保存订单</p>
</li>
<li><p>记录用户购买信息</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>分集购买声音只支持余额支付</p>
<p>购买vip或专辑分为余额，微信支付</p>
<p>声音购买：</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu035.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu035.png)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu036.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu036.png)

-->

<p>专辑购买：</p>
<p>大自然古琴钵音疗愈|禅意空灵 心生宁静</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu037.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu037.png)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu039.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu039.png)

-->

<p>VIP 购买：</p>
<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu038.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu038.png)

-->

<p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/tingshu033.png" srcset="/img/loading.gif" lazyload></p>
<!--
![](第7章 订单/tingshu033.png)

-->

<p>我们将前端页面提交的数据统一封装到实体类<strong>OrderInfoVo</strong>中 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.vo.order;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.util.Decimal2Serializer;<br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;<br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;<br><span class="hljs-keyword">import</span> jakarta.validation.Valid;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.DecimalMax;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.DecimalMin;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.Digits;<br><span class="hljs-keyword">import</span> jakarta.validation.constraints.NotEmpty;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Schema(description = &quot;订单对象&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderInfoVo</span> &#123;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;交易号不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;交易号&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String tradeNo;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;支付方式不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;支付方式：1101-微信 1102-支付宝 1103-账户余额&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String payWay;<br><br>    <span class="hljs-meta">@NotEmpty(message = &quot;付款项目类型不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;付款项目类型: 1001-专辑 1002-声音 1003-vip会员&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String itemType;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * value：最小值</span><br><span class="hljs-comment">     * inclusive：是否可以等于最小值，默认true，&gt;= 最小值</span><br><span class="hljs-comment">     * message：错误提示（默认有一个错误提示i18n支持中文）</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@DecimalMax</span> 同上</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Digits</span> integer： 整数位最多几位</span><br><span class="hljs-comment">     * fraction：小数位最多几位</span><br><span class="hljs-comment">     * message：同上，有默认提示</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@DecimalMin(value = &quot;0.00&quot;, inclusive = false, message = &quot;订单原始金额必须大于0.00&quot;)</span><br>    <span class="hljs-meta">@DecimalMax(value = &quot;9999.99&quot;, inclusive = true, message = &quot;订单原始金额必须大于9999.99&quot;)</span><br>    <span class="hljs-meta">@Digits(integer = 4, fraction = 2)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单原始金额&quot;, required = true)</span><br>    <span class="hljs-meta">@JsonSerialize(using = Decimal2Serializer.class)</span><br>    <span class="hljs-keyword">private</span> BigDecimal originalAmount;<br><br>    <span class="hljs-meta">@DecimalMin(value = &quot;0.00&quot;, inclusive = true, message = &quot;减免总金额必须大于0.00&quot;)</span><br>    <span class="hljs-meta">@DecimalMax(value = &quot;9999.99&quot;, inclusive = true, message = &quot;减免总金额必须大于9999.99&quot;)</span><br>    <span class="hljs-meta">@Digits(integer = 4, fraction = 2)</span><br>    <span class="hljs-meta">@Schema(description = &quot;减免总金额&quot;, required = true)</span><br>    <span class="hljs-meta">@JsonSerialize(using = Decimal2Serializer.class)</span><br>    <span class="hljs-keyword">private</span> BigDecimal derateAmount;<br><br>    <span class="hljs-meta">@DecimalMin(value = &quot;0.00&quot;, inclusive = false, message = &quot;订单总金额必须大于0.00&quot;)</span><br>    <span class="hljs-meta">@DecimalMax(value = &quot;9999.99&quot;, inclusive = true, message = &quot;订单总金额必须大于9999.99&quot;)</span><br>    <span class="hljs-meta">@Digits(integer = 4, fraction = 2)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单总金额&quot;, required = true)</span><br>    <span class="hljs-meta">@JsonSerialize(using = Decimal2Serializer.class)</span><br>    <span class="hljs-keyword">private</span> BigDecimal orderAmount;<br><br>    <span class="hljs-meta">@Valid</span><br>    <span class="hljs-meta">@NotEmpty(message = &quot;订单明细列表不能为空&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单明细列表&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderDetailVo&gt; orderDetailVoList;<br><br>    <span class="hljs-meta">@Schema(description = &quot;订单减免明细列表&quot;)</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderDerateVo&gt; orderDerateVoList;<br><br>    <span class="hljs-meta">@Schema(description = &quot;时间戳&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> Long timestamp;<br>    <span class="hljs-meta">@Schema(description = &quot;签名&quot;, required = true)</span><br>    <span class="hljs-keyword">private</span> String sign;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-1-1-控制器"><a href="#2-1-1-控制器" class="headerlink" title="2.1.1 控制器"></a>2.1.1 控制器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 提交订单</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> orderInfoVo</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;提交订单&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;submitOrder&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Validated</span> OrderInfoVo orderInfoVo)</span> &#123;<br>  <span class="hljs-comment">//  获取到用户Id</span><br>  <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> AuthContextHolder.getUserId();<br>  <span class="hljs-comment">//  调用服务层方法</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> orderInfoService.submitOrder(orderInfoVo, userId);<br>  Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>  map.put(<span class="hljs-string">&quot;orderNo&quot;</span>, orderNo);<br>  <span class="hljs-comment">//	返回数据</span><br>  <span class="hljs-keyword">return</span> Result.ok(map);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-1-2-接口与实现"><a href="#2-1-2-接口与实现" class="headerlink" title="2.1.2 接口与实现"></a>2.1.2 接口与实现</h4><p>参考：分布式事务.md 课件，先讲前置知识点</p>
<p>检查与扣减实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.vo.account;<br><br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;<br><span class="hljs-keyword">import</span> lombok.Data;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Schema(description = &quot;检查扣减金额对象&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountDeductVo</span> &#123;<br><br>   <span class="hljs-meta">@Schema(description = &quot;订单号&quot;)</span><br>   <span class="hljs-keyword">private</span> String orderNo;<br><br>   <span class="hljs-meta">@Schema(description = &quot;用户id&quot;)</span><br>   <span class="hljs-keyword">private</span> Long userId;<br><br>   <span class="hljs-meta">@Schema(description = &quot;锁定金额&quot;)</span><br>   <span class="hljs-keyword">private</span> BigDecimal amount;<br><br>   <span class="hljs-meta">@Schema(description = &quot;锁定内容&quot;)</span><br>   <span class="hljs-keyword">private</span> String content;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 提交订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderInfoVo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>String <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrderInfoVo orderInfoVo, Long userId)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@GlobalTransactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrderInfoVo orderInfoVo, Long userId)</span> &#123;<br>  <span class="hljs-comment">//  校验签名</span><br>  <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(JSON.toJSONString(orderInfoVo), Map.class);<br>  map.put(<span class="hljs-string">&quot;payWay&quot;</span>,SystemConstant.ORDER_PAY_WAY_WEIXIN);<br>  SignHelper.checkSign(map);<br><br>  <span class="hljs-comment">//  验证校验好，防止重复提交订单</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">tradeNo</span> <span class="hljs-operator">=</span> orderInfoVo.getTradeNo();<br>  <span class="hljs-keyword">if</span> (StringUtils.isEmpty(tradeNo))&#123;<br>    <span class="hljs-comment">//  非法提交</span><br>    <span class="hljs-keyword">throw</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);<br>  &#125;<br>  <span class="hljs-type">String</span> <span class="hljs-variable">tradeNoKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:trade:&quot;</span> + userId;<br>  <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if(redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1]) then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;<br>  <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> (Boolean) redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class), Arrays.asList(tradeNoKey), tradeNo);<br>  <span class="hljs-keyword">if</span> (!flag) &#123;<br>    <span class="hljs-comment">// 不能重复提交订单！</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.ORDER_SUBMIT_REPEAT);<br>  &#125;<br>  <span class="hljs-comment">//  3.下单</span><br>  <span class="hljs-comment">//  使用交易号座位订单号，或者重新生成订单号</span><br>  <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>  <span class="hljs-comment">//  支付类型</span><br>  <span class="hljs-keyword">if</span> (!SystemConstant.ORDER_PAY_ACCOUNT.equals(orderInfoVo.getPayWay()))&#123;<br>    <span class="hljs-comment">//  在线支付</span><br>    <span class="hljs-built_in">this</span>.saveOrder(orderInfoVo,userId,orderNo);<br>  &#125;<span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//  余额支付</span><br>      <span class="hljs-comment">//  锁定账户可用金额</span><br>      <span class="hljs-type">AccountDeductVo</span> <span class="hljs-variable">accountDeductVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountDeductVo</span>();<br>      accountDeductVo.setOrderNo(orderNo);<br>      accountDeductVo.setUserId(userId);<br>      accountDeductVo.setAmount(orderInfoVo.getOrderAmount());<br>      accountDeductVo.setContent(orderInfoVo.getOrderDetailVoList().get(<span class="hljs-number">0</span>).getItemName());<br>      <span class="hljs-comment">//  检查与锁定账户金额</span><br>      <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userAccountFeignClient.checkAndDeduct(accountDeductVo);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-number">200</span> != result.getCode())&#123;<br>        <span class="hljs-keyword">throw</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(result.getCode(),result.getMessage());<br>      &#125;<br>      <span class="hljs-comment">//  保存订单</span><br>      <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.saveOrder(orderInfoVo, userId, orderNo);<br>      <span class="hljs-comment">//  创建用户购买记录对象</span><br>      <span class="hljs-type">UserPaidRecordVo</span> <span class="hljs-variable">userPaidRecordVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPaidRecordVo</span>();<br>      <span class="hljs-comment">//  记录用户购买信息</span><br>      userPaidRecordVo.setOrderNo(orderNo);<br>      userPaidRecordVo.setUserId(orderInfo.getUserId());<br>      userPaidRecordVo.setItemType(orderInfo.getItemType());<br>      <span class="hljs-comment">//  购买项目的Id 专辑Id，声音Id, 服务配置Id: 在哪? order_detail.item_id</span><br>      List&lt;Long&gt; itemIdList = orderInfoVo.getOrderDetailVoList().stream().map(OrderDetailVo::getItemId).collect(Collectors.toList());<br>      userPaidRecordVo.setItemIdList(itemIdList);<br>      <span class="hljs-comment">//  远程调用：</span><br>      <span class="hljs-type">Result</span> <span class="hljs-variable">userResult</span> <span class="hljs-operator">=</span> userInfoFeignClient.savePaidRecord(userPaidRecordVo);<br>      <span class="hljs-comment">//  判断</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-number">200</span> != userResult.getCode()) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(<span class="hljs-number">211</span>, <span class="hljs-string">&quot;新增购买记录异常&quot;</span>);<br>      &#125;<br>      <span class="hljs-comment">//  返回订单编号</span><br>      <span class="hljs-keyword">return</span> orderNo;<br>      <br>    &#125; <span class="hljs-keyword">catch</span> (GuiguException e) &#123;<br>      e.printStackTrace();<br>      <span class="hljs-comment">//抛出异常</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(e.getCode(), e.getMessage());<br>    &#125;  <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>      e.printStackTrace();<br>      <span class="hljs-comment">//抛出异常</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> orderNo;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>方案二</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrderInfoVo orderInfoVo, Long userId)</span> &#123;<br>	<span class="hljs-comment">//  1.  校验签名 : 签名格式：</span><br>	<span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSON.parseObject(JSON.toJSONString(orderInfoVo), Map.class);<br>	map.put(<span class="hljs-string">&quot;payWay&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>	SignHelper.checkSign(map);<br>	<span class="hljs-comment">//  2.  校验tradeNo</span><br>	<span class="hljs-comment">//  2.1 先获取到页面流水号;</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">tradeNo</span> <span class="hljs-operator">=</span> orderInfoVo.getTradeNo();<br>	<span class="hljs-comment">//  2.2 获取到redis 流水号;</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">tradeNoKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;tradeNo:&quot;</span> + userId;<br>	<span class="hljs-comment">//        String tradeNoStr = (String) this.redisTemplate.opsForValue().get(tradeNoKey);</span><br>	<span class="hljs-comment">//        //  2.3 判断是否一致.</span><br>	<span class="hljs-comment">//        if (!tradeNo.equals(tradeNoStr))&#123;</span><br>	<span class="hljs-comment">//            return &quot;交易流水号不一致,重复提交订单.&quot;;</span><br>	<span class="hljs-comment">//        &#125;</span><br>	<span class="hljs-comment">//        //  2.4 删除redis 流水号</span><br>	<span class="hljs-comment">//        this.redisTemplate.delete(tradeNoKey);</span><br>	<span class="hljs-comment">//  创建RedisScript 对象</span><br>	DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>	<span class="hljs-comment">//  定义lua 脚本;</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">scriptText</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1]\n&quot;</span> +<br>			<span class="hljs-string">&quot;then\n&quot;</span> +<br>			<span class="hljs-string">&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot;</span> +<br>			<span class="hljs-string">&quot;else\n&quot;</span> +<br>			<span class="hljs-string">&quot;    return 0\n&quot;</span> +<br>			<span class="hljs-string">&quot;end&quot;</span>;<br>	redisScript.setScriptText(scriptText);<br>	redisScript.setResultType(Long.class);<br>	<span class="hljs-comment">//  判断是否删除成功.</span><br>	<span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> (Long) <span class="hljs-built_in">this</span>.redisTemplate.execute(redisScript, Arrays.asList(tradeNoKey), tradeNo);<br>	<span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(ResultCodeEnum.REPEAT_BUY_ERROR);<br>	&#125;<br>	<span class="hljs-comment">//  声明一个订单编号;</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>	<span class="hljs-comment">//  3.  判断支付方式：</span><br>	<span class="hljs-keyword">if</span> (!SystemConstant.ORDER_PAY_ACCOUNT.equals(orderInfoVo.getPayWay())) &#123;<br>		<span class="hljs-comment">//  微信支付; 保存订单信息，并发送一个消息，来实现取消订单功能</span><br>		<span class="hljs-built_in">this</span>.saveOrderInfo(orderInfoVo,orderNo,userId);<br>		<span class="hljs-comment">//  在线支付； 延迟消息实现方式： 1. 基于死信队列； 2. 基于延迟插件(具有顺序性) 有啥区别?</span><br>		rabbitService.sendDealyMessage(MqConst.EXCHANGE_CANCEL_ORDER,MqConst.ROUTING_CANCEL_ORDER,orderNo,MqConst.CANCEL_ORDER_DELAY_TIME);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">//  余额支付;</span><br>		<span class="hljs-comment">//  1. 判断是否有可用余额; account 创建扣减金额对象</span><br>		<span class="hljs-comment">//  1. 保存订单信息; order order_info order_detail order_derate</span><br>		<span class="hljs-built_in">this</span>.saveOrderInfo(orderInfoVo,orderNo,userId);<br><br>		<span class="hljs-comment">//  2. 判断是否有可用余额; account 创建扣减金额对象</span><br>		<span class="hljs-type">AccountDeductVo</span> <span class="hljs-variable">accountDeductVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountDeductVo</span>();<br>		accountDeductVo.setOrderNo(orderNo);<br>		accountDeductVo.setUserId(userId);<br>		accountDeductVo.setAmount(orderInfoVo.getOrderAmount());<br>		accountDeductVo.setContent(orderInfoVo.getOrderDetailVoList().get(<span class="hljs-number">0</span>).getItemName());<br>		<span class="hljs-comment">//  远程调用</span><br>		<span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userAccountFeignClient.checkAndDeduct(accountDeductVo);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-number">200</span> != result.getCode())&#123;<br>			<span class="hljs-comment">//  检查扣减失败，则抛出异常！</span><br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(result.getCode(),result.getMessage());<br>		&#125;<br>		<span class="hljs-comment">//  2. 保存订单信息; order order_info order_detail order_derate</span><br>		<span class="hljs-built_in">this</span>.saveOrderInfo(orderInfoVo,orderNo,userId);<br>		<span class="hljs-comment">//  修改订单状态！</span><br>		<span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();<br>		orderInfo.setOrderStatus(SystemConstant.ORDER_STATUS_PAID);<br>		LambdaQueryWrapper&lt;OrderInfo&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>		wrapper.eq(OrderInfo::getOrderNo,orderNo);<br>		<span class="hljs-built_in">this</span>.orderInfoMapper.update(orderInfo,wrapper);<br><br>		<span class="hljs-comment">//  3. 保存用户购买交易记录; user; user_paid_album user_paid_track user_vip_service</span><br>		<span class="hljs-type">UserPaidRecordVo</span> <span class="hljs-variable">userPaidRecordVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPaidRecordVo</span>();<br>		<span class="hljs-comment">//  3.1 给属性赋值</span><br>		userPaidRecordVo.setUserId(userId);<br>		userPaidRecordVo.setOrderNo(orderNo);<br>		userPaidRecordVo.setItemType(orderInfoVo.getItemType());<br>		<span class="hljs-comment">//  获取到订单明细的 itemId; order_detail.item_id = 购买条目的Id;vip_service_config.id ;如果购买声音，它属于声音id</span><br>		List&lt;Long&gt; itemIdList = orderInfoVo.getOrderDetailVoList().stream().map(OrderDetailVo::getItemId).collect(Collectors.toList());<br>		userPaidRecordVo.setItemIdList(itemIdList);<br>		<span class="hljs-comment">//  远程调用;</span><br>		<span class="hljs-type">Result</span> <span class="hljs-variable">userResult</span> <span class="hljs-operator">=</span> userInfoFeignClient.savePaidRecord(userPaidRecordVo);<br>		<span class="hljs-comment">//  判断</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-number">200</span> != userResult.getCode()) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(<span class="hljs-number">211</span>, <span class="hljs-string">&quot;新增购买记录异常&quot;</span>);<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">//  返回订单编号</span><br>	<span class="hljs-keyword">return</span> orderNo;<br>&#125;<br><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveOrderInfo</span><span class="hljs-params">(OrderInfoVo orderInfoVo, String orderNo, Long userId)</span> &#123;<br>	<span class="hljs-comment">//  order_info</span><br>	<span class="hljs-comment">//  属性拷贝：</span><br>	<span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();<br>	BeanUtils.copyProperties(orderInfoVo,orderInfo);<br>	orderInfo.setUserId(userId);<br>	orderInfo.setOrderNo(orderNo);<br>	orderInfo.setOrderTitle(orderInfoVo.getOrderDetailVoList().get(<span class="hljs-number">0</span>).getItemName());<br>	orderInfo.setOrderStatus(SystemConstant.ORDER_STATUS_UNPAID);<br>	<span class="hljs-comment">//  保存对象</span><br>	orderInfoMapper.insert(orderInfo);<br><br>	<span class="hljs-comment">//  order_detail || order_detail.item_id = 购买条目的Id;vip_service_config.id ;如果购买声音，它属于声音id</span><br>	<span class="hljs-comment">//  如果购买专辑 则它属于专辑id</span><br>	List&lt;OrderDetailVo&gt; orderDetailVoList = orderInfoVo.getOrderDetailVoList();<br>	<span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(orderDetailVoList))&#123;<br>		<span class="hljs-keyword">for</span> (OrderDetailVo orderDetailVo : orderDetailVoList) &#123;<br>			<span class="hljs-comment">//  创建订单对象</span><br>			<span class="hljs-type">OrderDetail</span> <span class="hljs-variable">orderDetail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetail</span>();<br>			<span class="hljs-comment">//  属性拷贝：</span><br>			BeanUtils.copyProperties(orderDetailVo,orderDetail);<br>			<span class="hljs-comment">//  赋值订单Id;</span><br>			orderDetail.setOrderId(orderInfo.getId());<br>			<span class="hljs-built_in">this</span>.orderDetailMapper.insert(orderDetail);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">//  order_derate</span><br>	List&lt;OrderDerateVo&gt; orderDerateVoList = orderInfoVo.getOrderDerateVoList();<br>	<span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(orderDerateVoList))&#123;<br>		<span class="hljs-keyword">for</span> (OrderDerateVo orderDerateVo : orderDerateVoList) &#123;<br>			<span class="hljs-comment">//  创建订单对象</span><br>			<span class="hljs-type">OrderDerate</span> <span class="hljs-variable">orderDerate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDerate</span>();<br>			<span class="hljs-comment">//  属性拷贝：</span><br>			BeanUtils.copyProperties(orderDerateVo,orderDerate);<br>			<span class="hljs-comment">//  赋值订单Id;</span><br>			orderDerate.setOrderId(orderInfo.getId());<br>			<span class="hljs-built_in">this</span>.orderDerateMapper.insert(orderDerate);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h5 id="2-1-2-1-检查扣减金额"><a href="#2-1-2-1-检查扣减金额" class="headerlink" title="2.1.2.1 检查扣减金额"></a>2.1.2.1 检查扣减金额</h5><h6 id="2-1-2-1-1-远程调用"><a href="#2-1-2-1-1-远程调用" class="headerlink" title="2.1.2.1.1 远程调用"></a>2.1.2.1.1 远程调用</h6><p>远程调用类 UserAccountFeignClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检查及扣减账户余额</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> accountDeductVo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(&quot;api/account/userAccount/checkAndDeduct&quot;)</span><br>Result <span class="hljs-title function_">checkAndDeduct</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AccountDeductVo accountDeductVo)</span>;<br></code></pre></td></tr></table></figure>

<p>熔断类 UserAccountDegradeFeignClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">checkAndDeduct</span><span class="hljs-params">(AccountDeductVo accountDeductVo)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="2-1-2-2-account微服务"><a href="#2-1-2-2-account微服务" class="headerlink" title="2.1.2.2 account微服务"></a>2.1.2.2 account微服务</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检查及扣减账户余额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> accountDeductVo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;检查及扣减账户余额&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/checkAndDeduct&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">checkAndDeduct</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AccountDeductVo accountDeductVo)</span>&#123;<br>   <span class="hljs-comment">// 调用服务此方法.</span><br>   userAccountService.checkAndDeduct(accountDeductVo);<br>   <span class="hljs-comment">// 返回数据</span><br>   <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口与实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检查与扣减余额</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> accountDeductVo</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">checkAndDeduct</span><span class="hljs-params">(AccountDeductVo accountDeductVo)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">checkAndDeduct</span><span class="hljs-params">(AccountDeductVo accountDeductVo)</span> &#123;<br>    <span class="hljs-comment">//  调用mapper 层方法.</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> userAccountMapper.checkAndDeduct(accountDeductVo.getUserId(),accountDeductVo.getAmount());<br>    <span class="hljs-comment">//  判断</span><br>    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span> )&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;账户余额不足！&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//  记录明细</span><br>    <span class="hljs-built_in">this</span>.addUserAccountDetail(<br>            accountDeductVo.getUserId(),<br>            accountDeductVo.getContent(),<br>            SystemConstant.ACCOUNT_TRADE_TYPE_MINUS,<br>            accountDeductVo.getAmount(),<br>            accountDeductVo.getOrderNo()<br>            );<br>    <span class="hljs-comment">//  返回受影响的行数</span><br>    <span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>UserAccountMapper.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 检查与扣减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> amount</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">checkAndDeduct</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;userId&quot;)</span> Long userId, <span class="hljs-meta">@Param(&quot;amount&quot;)</span> BigDecimal amount)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">   检查与扣减</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;checkAndDeduct&quot;</span>&gt;</span><br>   UPDATE user_account<br>   SET total_amount = total_amount - #&#123;amount&#125;,<br>      available_amount = available_amount - #&#123;amount&#125;,<br>      total_pay_amount = total_pay_amount + #&#123;amount&#125;<br>   WHERE<br>      user_id = #&#123;userId&#125;<br>     AND available_amount &gt;= #&#123;amount&#125;<br>     AND is_deleted = 0<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>记录用户账户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 记录用户账户信息</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> title</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> tradeType</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> amount</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderNo</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUserAccountDetail</span><span class="hljs-params">(Long userId, String title, String tradeType, BigDecimal amount, String orderNo)</span> &#123;<br>    <span class="hljs-type">UserAccountDetail</span> <span class="hljs-variable">userAccountDetail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserAccountDetail</span>();<br>    userAccountDetail.setUserId(userId);<br>    userAccountDetail.setTitle(title);<br>    userAccountDetail.setTradeType(tradeType);<br>    userAccountDetail.setAmount(amount);<br>    userAccountDetail.setOrderNo(orderNo);<br>    userAccountDetailMapper.insert(userAccountDetail);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-1-2-2-保存订单方法"><a href="#2-1-2-2-保存订单方法" class="headerlink" title="2.1.2.2 保存订单方法"></a>2.1.2.2 保存订单方法</h5><h6 id="2-1-2-2-1-接口与实现类"><a href="#2-1-2-2-1-接口与实现类" class="headerlink" title="2.1.2.2.1  接口与实现类"></a>2.1.2.2.1  接口与实现类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderInfoVo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderNo</span><br><span class="hljs-comment"> */</span><br>OrderInfo <span class="hljs-title function_">saveOrder</span><span class="hljs-params">(OrderInfoVo orderInfoVo, Long userId, String orderNo)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderInfo <span class="hljs-title function_">saveOrder</span><span class="hljs-params">(OrderInfoVo orderInfoVo, Long userId, String orderNo)</span> &#123;<br>  <span class="hljs-comment">//  创建对象对象</span><br>  <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();<br>  <span class="hljs-comment">//  属性拷贝</span><br>  BeanUtils.copyProperties(orderInfoVo, orderInfo);<br>  orderInfo.setOrderNo(orderNo);<br>  <span class="hljs-type">String</span> <span class="hljs-variable">orderTitle</span> <span class="hljs-operator">=</span> orderInfoVo.getOrderDetailVoList().get(<span class="hljs-number">0</span>).getItemName();<br>  orderInfo.setOrderTitle(orderTitle);<br>  orderInfo.setUserId(userId);<br>  orderInfo.setOrderStatus(SystemConstant.ORDER_STATUS_UNPAID);<br>  <span class="hljs-comment">//  保存订单</span><br>  orderInfoMapper.insert(orderInfo);<br><br>  <span class="hljs-comment">// 订单明细</span><br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(orderInfoVo.getOrderDetailVoList())) &#123;<br>    orderInfoVo.getOrderDetailVoList().forEach(orderDetailVo -&gt; &#123;<br>      <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">orderDetail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetail</span>();<br>      BeanUtils.copyProperties(orderDetailVo, orderDetail);<br>      orderDetail.setOrderId(orderInfo.getId());<br>      orderDetailMapper.insert(orderDetail);<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-comment">// 订单减免</span><br>  <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(orderInfoVo.getOrderDerateVoList())) &#123;<br>    orderInfoVo.getOrderDerateVoList().forEach(orderDerateVo -&gt; &#123;<br>      <span class="hljs-type">OrderDerate</span> <span class="hljs-variable">orderDerate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDerate</span>();<br>      BeanUtils.copyProperties(orderDerateVo, orderDerate);<br>      orderDerate.setOrderId(orderInfo.getId());<br>      orderDerateMapper.insert(orderDerate);<br>    &#125;);<br>  &#125;<br><br>  <span class="hljs-comment">// 订单支付方式 1101-微信 1102-支付宝 1103-账户余额</span><br>  <span class="hljs-keyword">if</span> (SystemConstant.ORDER_PAY_ACCOUNT.equals(orderInfo.getPayWay())) &#123;<br>    <span class="hljs-comment">// 余额支付成功保存交易数据</span><br>    <span class="hljs-built_in">this</span>.orderPaySuccess(orderNo);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 发送延迟队列，如果定时未支付，取消订单</span><br>    rabbitService.sendDealyMessage(MqConst.EXCHANGE_CANCEL_ORDER, MqConst.ROUTING_CANCEL_ORDER, orderInfo.getId(), MqConst.CANCEL_ORDER_DELAY_TIME);<br>  &#125;<br>  <span class="hljs-comment">// 返回订单信息</span><br>  <span class="hljs-keyword">return</span> orderInfo;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="2-1-2-2-2-余额支付成功更改订单状态"><a href="#2-1-2-2-2-余额支付成功更改订单状态" class="headerlink" title="2.1.2.2.2 余额支付成功更改订单状态"></a>2.1.2.2.2 余额支付成功更改订单状态</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">orderPaySuccess</span><span class="hljs-params">(String orderNo)</span> &#123;<br>    <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getOrderInfoByOrderNo(orderNo);<br>    <span class="hljs-comment">//  判断当前订单状态。</span><br>    <span class="hljs-keyword">if</span> (orderInfo.getOrderStatus().equals(SystemConstant.ORDER_STATUS_UNPAID)) &#123;<br>        <span class="hljs-comment">//  赋值：</span><br>        orderInfo.setOrderStatus(SystemConstant.ORDER_STATUS_PAID);<br>        <span class="hljs-comment">//  修改订单状态.</span><br>        <span class="hljs-built_in">this</span>.orderInfoMapper.updateById(orderInfo);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据orderNo 查询订单对象 需要包含订单明细，订单免减明细</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据订单orderNo 获取订单对象</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> orderNo</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br><span class="hljs-keyword">public</span> OrderInfo <span class="hljs-title function_">getOrderInfoByOrderNo</span><span class="hljs-params">(String orderNo)</span> &#123;<br>  <span class="hljs-comment">//  获取订单对象</span><br>  <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;OrderInfo&gt;().eq(OrderInfo::getOrderNo, orderNo));<br>  <span class="hljs-comment">//  查看订单明细</span><br>  List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;OrderDetail&gt;().eq(OrderDetail::getOrderId, orderInfo.getId()));<br>  <br>  <span class="hljs-comment">// 赋值订单明细</span><br>  orderInfo.setOrderDetailList(orderDetailList);<br>  <span class="hljs-comment">// 返回数据</span><br>  <span class="hljs-keyword">return</span> orderInfo;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="2-1-2-2-3-延迟消息处理"><a href="#2-1-2-2-3-延迟消息处理" class="headerlink" title="2.1.2.2.3 延迟消息处理"></a>2.1.2.2.3 延迟消息处理</h6><p>配置延迟消息</p>
<p>service&#x2F;service-order&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;atguigu&#x2F;tingshu&#x2F;order&#x2F;config&#x2F;CanelOrderMqConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.order.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanelOrderMqConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">cancelQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(MqConst.QUEUE_CANCEL_ORDER, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title function_">cancelExchange</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        args.put(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomExchange</span>(MqConst.EXCHANGE_CANCEL_ORDER, <span class="hljs-string">&quot;x-delayed-message&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindingCancel</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(cancelQueue()).to(cancelExchange()).with(MqConst.ROUTING_CANCEL_ORDER).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>监听延迟消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.order.receiver;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderReciever</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderInfoService orderInfoService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消订单消费者</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@RabbitListener(queues = MqConst.QUEUE_CANCEL_ORDER)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">orderCancel</span><span class="hljs-params">(Long orderId, Message message, Channel channel)</span> &#123;<br>        <span class="hljs-comment">//1.处理业务</span><br>        <span class="hljs-keyword">if</span> (orderId != <span class="hljs-literal">null</span>) &#123;<br>            orderInfoService.orderCancel(orderId);<br>        &#125;<br>        <span class="hljs-comment">//2.手动应答</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口与实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderInfoService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;OrderInfo&gt; &#123;    <br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据订单Id 取消订单</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">orderCancel</span><span class="hljs-params">(Long orderId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">orderCancel</span><span class="hljs-params">(Long orderId)</span> &#123;<br>  <span class="hljs-comment">// 设置更新数据</span><br>  <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfoUpt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();<br>  orderInfoUpt.setId(orderId);<br>  orderInfoUpt.setOrderStatus(SystemConstant.ORDER_STATUS_CANCEL);<br>  <span class="hljs-comment">// 执行更新方法</span><br>  <span class="hljs-built_in">this</span>.updateById(orderInfoUpt);<br>&#125;<br><br><br>或者<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(String orderNo)</span> &#123;<br>	<span class="hljs-comment">//设置更新数据</span><br>	<span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();<br>	orderInfo.setOrderStatus(SystemConstant.ORDER_STATUS_CANCEL);<br><br>	orderInfoMapper.update(orderInfo,<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;OrderInfo()<br>                           .eq(OrderInfo::getOrderNo,orderNo));<br>    &#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-1-2-3-保存用户交易记录"><a href="#2-1-2-3-保存用户交易记录" class="headerlink" title="2.1.2.3 保存用户交易记录"></a>2.1.2.3 保存用户交易记录</h5><h6 id="2-1-2-3-1-远程调用"><a href="#2-1-2-3-1-远程调用" class="headerlink" title="2.1.2.3.1 远程调用"></a>2.1.2.3.1 远程调用</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理用户购买记录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(&quot;api/user/userInfo/savePaidRecord&quot;)</span><br>Result <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserPaidRecordVo userPaidRecordVo)</span>;<br></code></pre></td></tr></table></figure>

<p>熔断类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="2-1-2-3-2-user微服务"><a href="#2-1-2-3-2-user微服务" class="headerlink" title="2.1.2.3.2 user微服务"></a>2.1.2.3.2 user微服务</h6><p>控制器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理用户购买记录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;处理用户购买记录&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;/savePaidRecord&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserPaidRecordVo userPaidRecordVo)</span>&#123;<br>   <span class="hljs-comment">// 调用服务层方法.</span><br>   userInfoService.savePaidRecord(userPaidRecordVo);<br>   <span class="hljs-comment">// 默认返回</span><br>   <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存用户交易记录</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span>;<br></code></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span> &#123;<br>    <span class="hljs-comment">//  根据购买类型判断向哪张表插入数据.</span><br>    <span class="hljs-keyword">if</span> (userPaidRecordVo.getItemType().equals(SystemConstant.ORDER_ITEM_TYPE_ALBUM))&#123;<br>        <span class="hljs-comment">//  专辑 user_paid_album</span><br>        <span class="hljs-comment">//  防止重复添加.</span><br>        LambdaQueryWrapper&lt;UserPaidAlbum&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        wrapper.eq(UserPaidAlbum::getUserId,userPaidRecordVo.getUserId());<br>        <span class="hljs-comment">//  wrapper.eq(UserPaidAlbum::getAlbumId,userPaidRecordVo.getItemIdList().get(0));</span><br>        wrapper.eq(UserPaidAlbum::getOrderNo,userPaidRecordVo.getOrderNo());<br>        <span class="hljs-type">UserPaidAlbum</span> <span class="hljs-variable">userPaidAlbum</span> <span class="hljs-operator">=</span> userPaidAlbumMapper.selectOne(wrapper);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != userPaidAlbum)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//  新增：</span><br>        userPaidAlbum = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPaidAlbum</span>();<br>        userPaidAlbum.setUserId(userPaidRecordVo.getUserId());<br>        userPaidAlbum.setOrderNo(userPaidRecordVo.getOrderNo());<br>        <span class="hljs-comment">//  专辑Id 声音Id vip_service_config.id ==&gt; order_detial.item_id;</span><br>        userPaidAlbum.setAlbumId(userPaidRecordVo.getItemIdList().get(<span class="hljs-number">0</span>));<br>        userPaidAlbumMapper.insert(userPaidAlbum);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userPaidRecordVo.getItemType().equals(SystemConstant.ORDER_ITEM_TYPE_TRACK))&#123;<br>        <span class="hljs-comment">//  声音 user_paid_track</span><br>        LambdaQueryWrapper&lt;UserPaidTrack&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        wrapper.eq(UserPaidTrack::getUserId,userPaidRecordVo.getUserId());<br>        wrapper.eq(UserPaidTrack::getOrderNo,userPaidRecordVo.getOrderNo());<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> userPaidTrackMapper.selectCount(wrapper);<br>        <span class="hljs-keyword">if</span> (count&gt;<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//  获取专辑Id</span><br>        Result&lt;TrackInfo&gt; trackInfoResult = trackInfoFeignClient.getTrackInfo(userPaidRecordVo.getItemIdList().get(<span class="hljs-number">0</span>));<br>        <span class="hljs-type">TrackInfo</span> <span class="hljs-variable">trackInfo</span> <span class="hljs-operator">=</span> trackInfoResult.getData();<br>        <span class="hljs-comment">//  声音Id 有可能一次购买多个.需要循环遍历</span><br>        userPaidRecordVo.getItemIdList().stream().forEach(trackId-&gt;&#123;<br>            <span class="hljs-comment">//  保存数据：</span><br>            <span class="hljs-type">UserPaidTrack</span> <span class="hljs-variable">userPaidTrack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPaidTrack</span>();<br>            userPaidTrack.setTrackId(trackId);<br>            userPaidTrack.setOrderNo(userPaidRecordVo.getOrderNo());<br>            userPaidTrack.setUserId(userPaidRecordVo.getUserId());<br>            <span class="hljs-comment">//  获取专辑Id</span><br>            userPaidTrack.setAlbumId(trackInfo.getAlbumId());<br>            userPaidTrackMapper.insert(userPaidTrack);<br>        &#125;);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//  vip user_vip_service 保存： vip:续期</span><br>        <span class="hljs-comment">//  获取用户对象信息.</span><br>        <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userInfoMapper.selectById(userPaidRecordVo.getUserId());<br>        <span class="hljs-comment">//  系统时间</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-comment">//  判断是否要做续期：</span><br>        <span class="hljs-keyword">if</span> (userInfo.getIsVip().intValue()==<span class="hljs-number">1</span> &amp;&amp; userInfo.getVipExpireTime().after(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()))&#123;<br>            <span class="hljs-comment">//  续期：</span><br>            currentTime = userInfo.getVipExpireTime();<br>        &#125;<br>        <span class="hljs-type">VipServiceConfig</span> <span class="hljs-variable">vipServiceConfig</span> <span class="hljs-operator">=</span> vipServiceConfigMapper.selectById(userPaidRecordVo.getItemIdList().get(<span class="hljs-number">0</span>));<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">serviceMonth</span> <span class="hljs-operator">=</span> vipServiceConfig.getServiceMonth();<br>        <span class="hljs-comment">//  LocalDate LocalDateTime LocalTime</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateTime</span>(currentTime).plusMonths(serviceMonth).toDate();<br>        <span class="hljs-comment">//  创建对象</span><br>        <span class="hljs-type">UserVipService</span> <span class="hljs-variable">userVipService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVipService</span>();<br>        userVipService.setOrderNo(userPaidRecordVo.getOrderNo());<br>        userVipService.setUserId(userPaidRecordVo.getUserId());<br>        userVipService.setStartTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-comment">//--------------&gt; 购买的时长:</span><br>        userVipService.setExpireTime(expireTime);<br>        <span class="hljs-comment">//  保存</span><br>        userVipServiceMapper.insert(userVipService);<br>        <span class="hljs-comment">//  修改user_info.is_vip=1;</span><br>        userInfo.setIsVip(<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//  设置过期时间</span><br>        userInfo.setVipExpireTime(expireTime);<br>        <span class="hljs-comment">//  手动模拟异常信息。</span><br>        <span class="hljs-comment">//  int i = 1/0;</span><br>        <span class="hljs-comment">//  修改</span><br>        <span class="hljs-built_in">this</span>.userInfoMapper.updateById(userInfo);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service-track-client 模块中添加远程调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取声音信息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;api/album/trackInfo/getTrackInfo/&#123;id&#125;&quot;)</span><br>Result&lt;TrackInfo&gt; <span class="hljs-title function_">getTrackInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br></code></pre></td></tr></table></figure>

<p>熔断类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackInfoDegradeFeignClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TrackInfoFeignClient</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result&lt;TrackInfo&gt; <span class="hljs-title function_">getTrackInfo</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-1-3-代码优化"><a href="#2-1-3-代码优化" class="headerlink" title="2.1.3 代码优化"></a>2.1.3 代码优化</h4><p>​	策略模式（Strategy Pattern）又叫政策模式（Policy Pattern），它是将定义的算法家族分别封装起来，让它们之间可以互相替换，从而让算法的变化不会影响到使用算法的用户。属于行为型模式。</p>
<p><strong>策略模式</strong>使用的就是面向对象的继承和多态机制，从而实现<strong>同一行为在不同场景下具备不同实现</strong>。</p>
<p>优点：</p>
<ul>
<li>策略类之间可以自由切换：由于策略类都实现同一个接口，所以使它们之间可以自由切换。</li>
<li>易于扩展：增加一个新的策略只需要添加一个具体的策略类即可，基本不需要改变原有的代码，符合“开闭原则“</li>
<li>避免使用多重条件选择语句（if else），充分体现面向对象设计思想。</li>
</ul>
<p>缺点：</p>
<ul>
<li>客户端必须知道所有的策略类，并自行决定使用哪一个策略类。</li>
</ul>
<p>策略模式的主要角色如下：</p>
<ul>
<li>抽象策略（Strategy）类：这是一个抽象角色，通常由一个接口或抽象类实现。此角色给出所有的具体策略类所需的接口。</li>
<li>具体策略（Concrete Strategy）类：实现了抽象策略定义的接口，提供具体的算法实现或行为。</li>
<li>环境（Context）类：用来操作策略的上下文环境，屏蔽高层模块（客户端）对策略、算法的直接访问，封装可能存在的变化。</li>
</ul>
<p><strong>策略接口</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.user.strategy;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.vo.user.UserPaidRecordVo;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 抽象：策略接口</span><br><span class="hljs-comment"> * 定义抽象方法：</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemTypeStrategy</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理用户购买记录</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>VIP购买项处理策略实现类</strong>：其中Bean对象ID要跟前端提交项目类型一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.user.strategy.impl;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.UserInfo;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.UserVipService;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.VipServiceConfig;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.mapper.UserInfoMapper;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.mapper.UserVipServiceMapper;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.mapper.VipServiceConfigMapper;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.strategy.ItemTypeStrategy;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.vo.user.UserPaidRecordVo;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.joda.time.LocalDateTime;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: atguigu</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2023-12-27 11:43</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component(&quot;1003&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VipStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ItemTypeStrategy</span> &#123;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserInfoMapper userInfoMapper;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> VipServiceConfigMapper vipServiceConfigMapper;<br><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserVipServiceMapper userVipServiceMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理购买项目类型为：VIP会员</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;处理购买项目类型为：VIP会员&quot;</span>);<br>        <span class="hljs-comment">//3.判断购买项目类型-处理VIP会员-允许多次购买</span><br>        <span class="hljs-comment">//3.1 新增VIP购买记录</span><br>        <span class="hljs-type">UserVipService</span> <span class="hljs-variable">userVipService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVipService</span>();<br>        <span class="hljs-comment">//3.1.1 根据VIP套餐ID查询套餐信息-得到VIP会员服务月数</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">vipConfigId</span> <span class="hljs-operator">=</span> userPaidRecordVo.getItemIdList().get(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">VipServiceConfig</span> <span class="hljs-variable">vipServiceConfig</span> <span class="hljs-operator">=</span> vipServiceConfigMapper.selectById(vipConfigId);<br>        <span class="hljs-comment">//3.1.2 获取用户身份，如果是VIP会员，则续费</span><br>        <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userInfoMapper.selectById(userPaidRecordVo.getUserId());<br>        <span class="hljs-comment">//  当前系统时间</span><br>        <span class="hljs-type">Date</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-keyword">if</span> (userInfo.getIsVip().intValue() == <span class="hljs-number">1</span> &amp;&amp; userInfo.getVipExpireTime().after(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())) &#123;<br>            <span class="hljs-comment">//  设置vip 续费的起始时间</span><br>            currentTime = userInfo.getVipExpireTime();<br>        &#125;<br>        currentTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalDateTime</span>(currentTime).plusMonths(vipServiceConfig.getServiceMonth()).toDate();<br>        <span class="hljs-comment">//  设置过期时间</span><br>        userVipService.setExpireTime(currentTime);<br>        userVipService.setStartTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-comment">//3.1.4 构建VIP购买记录对象保存</span><br>        userVipService.setUserId(userPaidRecordVo.getUserId());<br>        userVipService.setOrderNo(userPaidRecordVo.getOrderNo());<br>        userVipServiceMapper.insert(userVipService);<br><br>        <span class="hljs-comment">//3.2 更新用户表中VIP状态及会员过期时间</span><br>        userInfo.setIsVip(<span class="hljs-number">1</span>);<br>        userInfo.setVipExpireTime(userVipService.getExpireTime());<br>        userInfoMapper.updateById(userInfo);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>专辑购买项处理策略实现类</strong>：其中Bean对象ID要跟前端提交项目类型一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.user.strategy.imp;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.UserPaidAlbum;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.mapper.UserPaidAlbumMapper;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.strategy.ItemTypeStrategy;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.vo.user.UserPaidRecordVo;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: atguigu</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2023-12-27 11:43</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component(&quot;1001&quot;)</span> <span class="hljs-comment">//将专辑类型购买策略实现类beanId跟前端提交购买项目类型一致</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlbumStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ItemTypeStrategy</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserPaidAlbumMapper userPaidAlbumMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理购买项目类型为：专辑</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;处理购买项目类型为：专辑&quot;</span>);<br>        <span class="hljs-comment">//1.1 根据订单编号查询专辑购买记录</span><br>        LambdaQueryWrapper&lt;UserPaidAlbum&gt; userPaidAlbumLambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        userPaidAlbumLambdaQueryWrapper.eq(UserPaidAlbum::getOrderNo, userPaidRecordVo.getOrderNo());<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> userPaidAlbumMapper.selectCount(userPaidAlbumLambdaQueryWrapper);<br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//1.2 查询到专辑购买记录为空则新增购买记录</span><br>        <span class="hljs-type">UserPaidAlbum</span> <span class="hljs-variable">userPaidAlbum</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPaidAlbum</span>();<br>        userPaidAlbum.setOrderNo(userPaidRecordVo.getOrderNo());<br>        userPaidAlbum.setUserId(userPaidRecordVo.getUserId());<br>        userPaidAlbum.setAlbumId(userPaidRecordVo.getItemIdList().get(<span class="hljs-number">0</span>));<br>        userPaidAlbumMapper.insert(userPaidAlbum);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>声音购买项处理策略实现类</strong>：其中Bean对象ID要跟前端提交项目类型一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.user.strategy.impl;<br><br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.album.client.AlbumInfoFeignClient;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.album.client.TrackInfoFeignClient;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.album.TrackInfo;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.model.user.UserPaidTrack;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.mapper.UserPaidTrackMapper;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.user.strategy.ItemTypeStrategy;<br><span class="hljs-keyword">import</span> com.atguigu.tingshu.vo.user.UserPaidRecordVo;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: atguigu</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2023-12-27 11:43</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component(&quot;1002&quot;)</span>  <span class="hljs-comment">//beanID:trackStrategy</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ItemTypeStrategy</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserPaidTrackMapper userPaidTrackMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TrackInfoFeignClient trackInfoFeignClient;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理购买项目类型为：声音</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userPaidRecordVo</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">savePaidRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;处理购买项目类型为：声音&quot;</span>);<br>        <span class="hljs-comment">//2.判断购买项目类型-处理声音</span><br>        <span class="hljs-comment">//2.1 根据订单编号查询声音购买记录</span><br>        LambdaQueryWrapper&lt;UserPaidTrack&gt; userPaidTrackLambdaQueryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        userPaidTrackLambdaQueryWrapper.eq(UserPaidTrack::getOrderNo, userPaidRecordVo.getOrderNo());<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> userPaidTrackMapper.selectCount(userPaidTrackLambdaQueryWrapper);<br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//2.2 查询到声音购买记录为空则新增购买记录（循环批量新增）</span><br>        <span class="hljs-comment">//2.2.1 远程调用专辑服务-根据声音ID查询声音对象-获取声音所属专辑ID</span><br>        <span class="hljs-type">TrackInfo</span> <span class="hljs-variable">trackInfo</span> <span class="hljs-operator">=</span> trackInfoFeignClient.getTrackInfo(userPaidRecordVo.getItemIdList().get(<span class="hljs-number">0</span>)).getData();<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">albumId</span> <span class="hljs-operator">=</span> trackInfo.getAlbumId();<br>        <span class="hljs-comment">//2.2.2 遍历购买项目ID集合批量新增声音购买记录</span><br>        userPaidRecordVo.getItemIdList().forEach(trackId -&gt; &#123;<br>            <span class="hljs-type">UserPaidTrack</span> <span class="hljs-variable">userPaidTrack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPaidTrack</span>();<br>            userPaidTrack.setOrderNo(userPaidRecordVo.getOrderNo());<br>            userPaidTrack.setUserId(userPaidRecordVo.getUserId());<br>            userPaidTrack.setAlbumId(albumId);<br>            userPaidTrack.setTrackId(trackId);<br>            userPaidTrackMapper.insert(userPaidTrack);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>提供工厂类</strong>组装所有的策略实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.tingshu.user.strategy;<br><br><span class="hljs-keyword">import</span> com.atguigu.tingshu.common.execption.GuiguException;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 策略工厂：封装可能存在的变化（具体策略实现类）</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span>: atguigu</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@create</span>: 2023-12-27 11:46</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrategyFactory</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将IOC容器中ItemTypeStrategy接口下所有实现类对象注入到Map中</span><br><span class="hljs-comment">     * Map中Key：Bean对象ID</span><br><span class="hljs-comment">     * Map中Value：实现类对象</span><br><span class="hljs-comment">     * &#123;&quot;1001&quot;:购买类型为专辑策略类对象&#125;</span><br><span class="hljs-comment">     * &#123;&quot;1002&quot;:购买类型为声音策略类对象&#125;</span><br><span class="hljs-comment">     * &#123;&quot;1003&quot;:购买类型为会员策略类对象&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, ItemTypeStrategy&gt; strategyMap;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据购买项目类型获取具体策略实现类对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> itemType 项目类型</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ItemTypeStrategy <span class="hljs-title function_">getStrategy</span><span class="hljs-params">(String itemType)</span> &#123;<br>        <span class="hljs-keyword">if</span> (strategyMap.containsKey(itemType)) &#123;<br>            <span class="hljs-keyword">return</span> strategyMap.get(itemType);<br>        &#125;<br>        log.error(<span class="hljs-string">&quot;该策略实现类不存在&quot;</span>);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguException</span>(<span class="hljs-number">500</span>, <span class="hljs-string">&quot;该策略&quot;</span> + itemType + <span class="hljs-string">&quot;实现类不存在&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>UserInfoServiceImpl</strong>业务调用工厂获取不同策略实现类完成方法调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> StrategyFactory strategyFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 处理用户购买记录（虚拟物品发货）</span><br><span class="hljs-comment"> *userPaidRecordVo.getItemType()  1001  1002  1003</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userPaidRecordVo 购买记录VO</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userPayRecord</span><span class="hljs-params">(UserPaidRecordVo userPaidRecordVo)</span> &#123;<br>    <span class="hljs-comment">//从策略工厂中获取对应的策略对象</span><br>    <span class="hljs-type">ItemTypeStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> strategyFactory.getStrategy(userPaidRecordVo.getItemType());<br>    <span class="hljs-comment">//执行策略对象的任务</span><br>    strategy.savePaidRecord(userPaidRecordVo);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>###2.2 根据orderNo 查看我的订单</p>
<h4 id="2-2-1-控制器"><a href="#2-2-1-控制器" class="headerlink" title="2.2.1 控制器"></a>2.2.1 控制器</h4><p>当支付成功之后，点击查看订单，直接调用上面写过的getOrderInfoByOrderNo方法即可。</p>
<p>在service-order 微服务中添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查看我的订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderNo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;根据订单号获取订单信息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;getOrderInfo/&#123;orderNo&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderInfo&gt; <span class="hljs-title function_">getOrderInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderNo)</span> &#123;<br>   <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> orderInfoService.getOrderInfoByOrderNo(orderNo);<br>   <span class="hljs-keyword">return</span> Result.ok(orderInfo);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>查看支付方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 修改getOrderInfoByOrderNo方法</span><br><span class="hljs-comment">//  获取支付方式：</span><br>orderInfo.setPayWayName(<span class="hljs-built_in">this</span>.getPayWayName(orderInfo.getPayWay()));<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 根据payWay 返回支付名称</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@param</span> payWay</span><br><span class="hljs-comment">  * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPayWayName</span><span class="hljs-params">(String payWay)</span> &#123;<br>  		<span class="hljs-comment">//  声明一个对象</span><br>  		<span class="hljs-keyword">return</span> SystemConstant.ORDER_PAY_WAY_WEIXIN.equals(payWay)?<span class="hljs-string">&quot;微信支付&quot;</span>:<span class="hljs-string">&quot;余额支付&quot;</span>;<br>  &#125;<br></code></pre></td></tr></table></figure>



<h3 id="2-3-查看我的订单"><a href="#2-3-查看我的订单" class="headerlink" title="2.3 查看我的订单"></a>2.3 查看我的订单</h3><p><img src="/2024/11/18/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC7%E7%AB%A0%20%E8%AE%A2%E5%8D%95/%E8%AE%A2%E5%8D%95-%E6%88%91%E7%9A%84%E8%AE%A2%E5%8D%95.gif" srcset="/img/loading.gif" lazyload></p>
<!--
![订单-我的订单](第7章 订单/订单-我的订单.gif)

-->

<p>入口：我的–&gt;我的订单</p>
<h4 id="2-3-1-控制器"><a href="#2-3-1-控制器" class="headerlink" title="2.3.1 控制器"></a>2.3.1 控制器</h4><p>service-order 的OrderInfoApiController 控制器 添加 直接返回OrderInfo 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查看我的订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> page</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> limit</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@YunYueTingLogin</span><br><span class="hljs-meta">@Operation(summary = &quot;获取用户订单&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;findUserPage/&#123;page&#125;/&#123;limit&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">index</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-meta">@Parameter(name = &quot;page&quot;, description = &quot;当前页码&quot;, required = true)</span></span><br><span class="hljs-params">      <span class="hljs-meta">@PathVariable</span> Long page,</span><br><span class="hljs-params">      <span class="hljs-meta">@Parameter(name = &quot;limit&quot;, description = &quot;每页记录数&quot;, required = true)</span></span><br><span class="hljs-params">      <span class="hljs-meta">@PathVariable</span> Long limit)</span> &#123;<br>   <span class="hljs-comment">// 获取到用户Id</span><br>   <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> AuthContextHolder.getUserId();<br>   Page&lt;OrderInfo&gt; pageParam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(page, limit);<br>   <span class="hljs-comment">// 调用服务层方法</span><br>   IPage&lt;OrderInfo&gt; pageModel = orderInfoService.findUserPage(pageParam, userId);<br>   <span class="hljs-keyword">return</span> Result.ok(pageModel);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-接口与实现类"><a href="#2-3-2-接口与实现类" class="headerlink" title="2.3.2 接口与实现类"></a>2.3.2 接口与实现类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查看我的订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageParam</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>IPage&lt;OrderInfo&gt; <span class="hljs-title function_">findUserPage</span><span class="hljs-params">(Page&lt;OrderInfo&gt; pageParam, Long userId)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> IPage&lt;OrderInfo&gt; <span class="hljs-title function_">findUserPage</span><span class="hljs-params">(Page&lt;OrderInfo&gt; pageParam, Long userId)</span> &#123;<br>    <span class="hljs-comment">//  调用mapper 层方法</span><br>    IPage&lt;OrderInfo&gt; infoIPage = orderInfoMapper.selectUserPage(pageParam,userId);<br>    infoIPage.getRecords().forEach(item-&gt;&#123;<br>        <span class="hljs-comment">//  设置状态名</span><br>        item.setOrderStatusName(getOrderStatusName(item.getOrderStatus()));<br>        item.setPayWayName(getPayWayName(item.getPayWay()));<br>    &#125;);<br>    <span class="hljs-keyword">return</span> infoIPage;<br>&#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据订单状态获取到订单名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderStatus</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getOrderStatusName</span><span class="hljs-params">(String orderStatus)</span> &#123;<br>        <span class="hljs-comment">//  声明订单状态名称</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">orderStatusName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-comment">//  判断</span><br>        <span class="hljs-keyword">if</span> (SystemConstant.ORDER_STATUS_UNPAID.equals(orderStatus))&#123;<br>            orderStatusName = <span class="hljs-string">&quot;未支付&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SystemConstant.ORDER_STATUS_PAID.equals(orderStatus)) &#123;<br>            orderStatusName = <span class="hljs-string">&quot;已支付&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            orderStatusName = <span class="hljs-string">&quot;已取消&quot;</span>;<br>        &#125;<br>        <span class="hljs-comment">//  返回</span><br>        <span class="hljs-keyword">return</span> orderStatusName;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>OrderInfoMapper.java 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderInfoMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;OrderInfo&gt; &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查看分页订单列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageParam</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    IPage&lt;OrderInfo&gt; <span class="hljs-title function_">selectUserPage</span><span class="hljs-params">(Page&lt;OrderInfo&gt; pageParam, Long userId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>OrderInfoMapper.xml 映射文件</p>
<p>这种方式以订单明细为主：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta"><span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta"><span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.order.mapper.OrderInfoMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderInfoMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.model.order.OrderInfo&quot;</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;orderDetailList&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.model.order.OrderDetail&quot;</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;detail_id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 用于select查询公用抽取的列 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;columns&quot;</span>&gt;</span><br>        oi.id ,<br>            oi.user_id,<br>            oi.order_title,<br>            oi.order_no,<br>            oi.order_status,<br>            oi.original_amount,<br>            oi.derate_amount,<br>            oi.order_amount,<br>            oi.item_type,<br>            oi.pay_way,<br>            od.id detail_id,<br>            od.item_id,<br>            od.item_name,<br>            od.item_url,<br>            od.item_price<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUserPage&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;orderInfoMap&quot;</span>&gt;</span><br>        select<br>            <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;columns&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>        from order_info oi inner join order_detail od on oi.id = od.order_id<br>        where oi.user_id = #&#123;userId&#125;<br>        order by oi.id desc<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>另一种方式：以订单为主</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta"><span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta"><span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.order.mapper.OrderInfoMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        返回数据映射配置</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderInfoMap&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.model.order.OrderInfo&quot;</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">               分步骤查询：</span><br><span class="hljs-comment">               1.  先查询订单：</span><br><span class="hljs-comment">               2.  在查询订单明细：</span><br><span class="hljs-comment">           --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">&quot;orderDetailList&quot;</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.model.order.OrderDetail&quot;</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">                    <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;selectDetail&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        订单的字段</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderInfoSql&quot;</span>&gt;</span><br>        oi.id,<br>       oi.user_id,<br>       oi.order_title,<br>       oi.order_no,<br>       oi.order_status,<br>       oi.original_amount,<br>       oi.derate_amount,<br>       oi.order_amount,<br>       oi.item_type,<br>       oi.pay_way<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        订单明细字段</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;orderDetailSql&quot;</span>&gt;</span><br>               od.id ,<br>               od.item_id,<br>               od.item_name,<br>               od.item_url,<br>               od.item_price<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        订单数据</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectUserPage&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;orderInfoMap&quot;</span>&gt;</span><br>        select<br>            <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;orderInfoSql&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>            from order_info oi<br>            <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>                oi.user_id = #&#123;userId&#125;<br>                <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;orderStatus!=null and orderStatus!=&#x27;&#x27;&quot;</span>&gt;</span><br>                    and oi.order_status = #&#123;orderStatus&#125;<br>                <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>                and oi.is_deleted = 0<br>            order by oi.id desc<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    订单明细数据</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDetail&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;com.atguigu.tingshu.model.order.OrderDetail&quot;</span>&gt;</span><br>        select<br>            <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;orderDetailSql&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>            from order_detail od<br>        where od.order_id = #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/" class="category-chain-item">云悦听</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>7、订单购买</div>
      <div>http://example.com/2024/11/18/项目/云悦听/第7章 订单/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>pz</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年11月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/01/29/%E6%8A%80%E6%9C%AF%E6%A0%88/C/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/%E7%AC%AC01%E7%AB%A0%E9%99%84%E5%BD%95%EF%BC%9AC%E5%BC%80%E5%8F%91%E5%88%A9%E5%99%A8%EF%BC%9ACLion%E7%9A%84%E4%BD%BF%E7%94%A8/" title="1-2、CLion的使用">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">1-2、CLion的使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/11/16/%E9%A1%B9%E7%9B%AE/%E4%BA%91%E6%82%A6%E5%90%AC/%E7%AC%AC6%E7%AB%A0%20%E8%AF%A6%E6%83%85%E4%BC%98%E5%8C%96/" title="6-2、详情优化">
                        <span class="hidden-mobile">6-2、详情优化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/headerPic.js"></script><!-- hexo injector body_end end --></body>
</html>
