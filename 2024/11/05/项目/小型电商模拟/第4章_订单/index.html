

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="https://p0.itc.cn/q_70/images03/20230516/bab1646e504942d4a9d964cde5d8b15d.jpeg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pz">
  <meta name="keywords" content="">
  
    <meta name="description" content="第4章 订单4.1 商品结算4.1.1 需求说明入口：购物车点击去结算按钮 ，进入结算页面(订单确认页面)，如图所示：      分析页面需要的数据： 1、 用户地址信息列表管理（增删改查），结算页选中默认地址 2、 购物车中选择的商品列表，及商品的总金额 查看接口文档： 用户地址信息接口地址及返回结果： 1234567891011121314151617181920212223242526272">
<meta property="og:type" content="article">
<meta property="og:title" content="4、订单">
<meta property="og:url" content="http://example.com/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC4%E7%AB%A0_%E8%AE%A2%E5%8D%95/index.html">
<meta property="og:site_name" content="PZ">
<meta property="og:description" content="第4章 订单4.1 商品结算4.1.1 需求说明入口：购物车点击去结算按钮 ，进入结算页面(订单确认页面)，如图所示：      分析页面需要的数据： 1、 用户地址信息列表管理（增删改查），结算页选中默认地址 2、 购物车中选择的商品列表，及商品的总金额 查看接口文档： 用户地址信息接口地址及返回结果： 1234567891011121314151617181920212223242526272">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/gouwuche.png">
<meta property="article:published_time" content="2024-11-05T12:44:41.067Z">
<meta property="article:modified_time" content="2024-11-19T00:33:10.227Z">
<meta property="article:author" content="pz">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/gouwuche.png">
  
  
  
  <title>4、订单 - PZ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>PZ</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="4、订单"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-11-05 20:44" pubdate>
          2024年11月5日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          77 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">4、订单</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="第4章-订单"><a href="#第4章-订单" class="headerlink" title="第4章 订单"></a>第4章 订单</h1><h2 id="4-1-商品结算"><a href="#4-1-商品结算" class="headerlink" title="4.1 商品结算"></a>4.1 商品结算</h2><h3 id="4-1-1-需求说明"><a href="#4-1-1-需求说明" class="headerlink" title="4.1.1 需求说明"></a>4.1.1 需求说明</h3><p>入口：购物车点击去结算按钮 ，进入结算页面(订单确认页面)，如图所示：</p>
<img src="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC4%E7%AB%A0_%E8%AE%A2%E5%8D%95/trade.gif" srcset="/img/loading.gif" lazyload alt style="zoom:67%;"> 

<!--

<img src="/第4章_订单/trade.gif" srcset="/img/loading.gif" lazyload alt="" style="zoom:67%;" /> 

-->

<p>分析页面需要的数据：</p>
<p>1、 用户地址信息列表管理（增删改查），结算页选中默认地址</p>
<p>2、 购物车中选择的商品列表，及商品的总金额</p>
<p><strong>查看接口文档：</strong></p>
<p>用户地址信息接口地址及返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs json">#用户地址列表<br>get /user/userAddress/list<br>返回结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;晴天&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15023656352&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;tagName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;家&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;provinceCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110000&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;cityCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110100&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;districtCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110101&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;东直门1号&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;fullAddress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;北京市北京市东城区东直门1号&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;isDefault&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        ...<br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br> <br>#添加用户地址<br>post /user/userAddress<br>参数：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cs&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15090909090&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;provinceCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110000&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;cityCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110100&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;districtCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110102&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;111&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;tagName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;家&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;isDefault&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span>     <br>返回结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><br><span class="hljs-punctuation">&#125;</span><br>        <br>#修改用户地址<br>put /user/userAddress<br>参数：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cs&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15090909090&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;provinceCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110000&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;cityCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110100&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;districtCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110102&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;111&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;tagName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;家&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;isDefault&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br><span class="hljs-punctuation">&#125;</span>     <br>返回结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><br><span class="hljs-punctuation">&#125;</span>     <br>        <br>#删除用户地址<br>delete /user/userAddress/<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br>返回结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>结算接口地址及返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json">get /order/orderInfo/trade<br>返回结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;totalAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8998.00</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;orderItemList&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;orderId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;skuId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;skuName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;华为笔记本 32G&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;thumbImg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://139.198.127.41:9000/20230525/c8f2eae0d36b6270.jpg.avif&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;skuPrice&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5999.00</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;skuNum&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            ...<br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;tradeNo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1d76f36b59414e869e843fc742e21469&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-1-2-地址管理接口"><a href="#4-1-2-地址管理接口" class="headerlink" title="4.1.2 地址管理接口"></a>4.1.2 地址管理接口</h3><p>操作模块：user</p>
<h4 id="1、UserAddressController"><a href="#1、UserAddressController" class="headerlink" title="1、UserAddressController"></a>1、UserAddressController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.user.controller;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/userAddress&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAddressController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseController</span><br>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IUserAddressService userAddressService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询用户地址列表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Operation(summary = &quot;查询用户地址列表&quot;)</span><br>    <span class="hljs-meta">@RequiresLogin</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">list</span><span class="hljs-params">()</span><br>    &#123;<br>        List&lt;UserAddress&gt; list = userAddressService.selectUserAddressList();<br>        <span class="hljs-keyword">return</span> success(list);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增用户地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Operation(summary = &quot;新增用户地址&quot;)</span><br>    <span class="hljs-meta">@RequiresLogin</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserAddress userAddress)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> toAjax(userAddressService.insertUserAddress(userAddress));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改用户地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Operation(summary = &quot;修改用户地址&quot;)</span><br>    <span class="hljs-meta">@RequiresLogin</span><br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">edit</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserAddress userAddress)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> toAjax(userAddressService.updateUserAddress(userAddress));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除用户地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Operation(summary = &quot;删除用户地址&quot;)</span><br>    <span class="hljs-meta">@RequiresLogin</span><br>    <span class="hljs-meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> toAjax(userAddressService.removeById(id));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2、IUserAddressService"><a href="#2、IUserAddressService" class="headerlink" title="2、IUserAddressService"></a>2、IUserAddressService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.user.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserAddressService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;UserAddress&gt;<br>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询用户地址列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 用户地址集合</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;UserAddress&gt; <span class="hljs-title function_">selectUserAddressList</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userAddress 用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insertUserAddress</span><span class="hljs-params">(UserAddress userAddress)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userAddress 用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateUserAddress</span><span class="hljs-params">(UserAddress userAddress)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3、UserAddressServiceImpl"><a href="#3、UserAddressServiceImpl" class="headerlink" title="3、UserAddressServiceImpl"></a>3、UserAddressServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.user.service.impl;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAddressServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserAddressMapper, UserAddress&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserAddressService</span><br>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserAddressMapper userAddressMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IRegionService regionService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询用户地址列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 用户地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;UserAddress&gt; <span class="hljs-title function_">selectUserAddressList</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-comment">// 获取当前登录用户的id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> SecurityContextHolder.getUserId();<br>        <span class="hljs-keyword">return</span> userAddressMapper.selectList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;UserAddress&gt;().eq(UserAddress::getUserId, userId));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userAddress 用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insertUserAddress</span><span class="hljs-params">(UserAddress userAddress)</span><br>    &#123;<br>        userAddress.setUserId(SecurityContextHolder.getUserId());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">provinceName</span> <span class="hljs-operator">=</span> regionService.getNameByCode(userAddress.getProvinceCode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cityName</span> <span class="hljs-operator">=</span> regionService.getNameByCode(userAddress.getCityCode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">districtName</span> <span class="hljs-operator">=</span> regionService.getNameByCode(userAddress.getDistrictCode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fullAddress</span> <span class="hljs-operator">=</span> provinceName + cityName + districtName + userAddress.getAddress();<br>        userAddress.setFullAddress(fullAddress);<br>        userAddress.setCreateTime(DateUtils.getNowDate());<br><br>        <span class="hljs-comment">//如果是默认地址，其他地址更新为非默认地址</span><br>        <span class="hljs-keyword">if</span>(userAddress.getIsDefault().intValue() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-type">UserAddress</span> <span class="hljs-variable">updateUserAddress</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserAddress</span>();<br>            updateUserAddress.setIsDefault(<span class="hljs-number">0L</span>);<br>            userAddressMapper.update(updateUserAddress, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;UserAddress&gt;().eq(UserAddress::getUserId, userAddress.getUserId()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> userAddressMapper.insert(userAddress);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userAddress 用户地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateUserAddress</span><span class="hljs-params">(UserAddress userAddress)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">provinceName</span> <span class="hljs-operator">=</span> regionService.getNameByCode(userAddress.getProvinceCode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cityName</span> <span class="hljs-operator">=</span> regionService.getNameByCode(userAddress.getCityCode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">districtName</span> <span class="hljs-operator">=</span> regionService.getNameByCode(userAddress.getDistrictCode());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fullAddress</span> <span class="hljs-operator">=</span> provinceName + cityName + districtName + userAddress.getAddress();<br>        userAddress.setFullAddress(fullAddress);<br>        userAddress.setUpdateTime(DateUtils.getNowDate());<br>        <span class="hljs-comment">//如果是默认地址，其他地址更新为非默认地址</span><br>        <span class="hljs-keyword">if</span>(userAddress.getIsDefault().intValue() == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-type">UserAddress</span> <span class="hljs-variable">updateUserAddress</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserAddress</span>();<br>            updateUserAddress.setIsDefault(<span class="hljs-number">0L</span>);<br>            userAddressMapper.update(updateUserAddress, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;UserAddress&gt;().eq(UserAddress::getUserId, userAddress.getUserId()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> userAddressMapper.updateById(userAddress);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4、IRegionService"><a href="#4、IRegionService" class="headerlink" title="4、IRegionService"></a>4、IRegionService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据code获取地区名称</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> code</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>String <span class="hljs-title function_">getNameByCode</span><span class="hljs-params">(String code)</span>;<br></code></pre></td></tr></table></figure>

<h4 id="5、RegionServiceImpl"><a href="#5、RegionServiceImpl" class="headerlink" title="5、RegionServiceImpl"></a>5、RegionServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNameByCode</span><span class="hljs-params">(String code)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(code)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-type">Region</span> <span class="hljs-variable">region</span> <span class="hljs-operator">=</span> regionMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;Region&gt;().eq(Region::getCode,code).select(Region::getName));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">null</span> != region) &#123;<br>        <span class="hljs-keyword">return</span> region.getName();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-1-3-获取选中购物项数据接口"><a href="#4-1-3-获取选中购物项数据接口" class="headerlink" title="4.1.3 获取选中购物项数据接口"></a>4.1.3 获取选中购物项数据接口</h3><h4 id="1、远程调用接口开发"><a href="#1、远程调用接口开发" class="headerlink" title="1、远程调用接口开发"></a>1、远程调用接口开发</h4><p>操作模块：cart</p>
<p>（1）CartController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary=&quot;查询用户购物车列表中选中商品列表&quot;)</span><br><span class="hljs-meta">@InnerAuth</span><br><span class="hljs-meta">@GetMapping(&quot;/getCartCheckedList/&#123;userId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;List&lt;CartInfo&gt;&gt; <span class="hljs-title function_">getCartCheckedList</span><span class="hljs-params">(<span class="hljs-meta">@Parameter(name = &quot;userId&quot;, description = &quot;会员id&quot;, required = true)</span> <span class="hljs-meta">@PathVariable</span> Long userId)</span>&#123;<br><span class="hljs-keyword">return</span> R.ok(cartService.getCartCheckedList(userId));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）ICartService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;CartInfo&gt; <span class="hljs-title function_">getCartCheckedList</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure>

<p>（3）CartServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;CartInfo&gt; <span class="hljs-title function_">getCartCheckedList</span><span class="hljs-params">(Long userId)</span> &#123;<br>    List&lt;CartInfo&gt; cartInfoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cartKey</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCartKey(userId);<br>    List&lt;CartInfo&gt; cartCachInfoList = redisTemplate.opsForHash().values(cartKey);<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(cartCachInfoList)) &#123;<br>        <span class="hljs-keyword">for</span> (CartInfo cartInfo : cartCachInfoList) &#123;<br>            <span class="hljs-comment">// 获取选中的商品！</span><br>            <span class="hljs-keyword">if</span> (cartInfo.getIsChecked().intValue() == <span class="hljs-number">1</span>) &#123;<br>                cartInfoList.add(cartInfo);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> cartInfoList;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2、openFeign接口定义"><a href="#2、openFeign接口定义" class="headerlink" title="2、openFeign接口定义"></a>2、openFeign接口定义</h4><p>操作模块：api-cart</p>
<p>（1）RemoteCartService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.cart.api;<br><br><span class="hljs-meta">@FeignClient(value = ServiceNameConstants.CART_SERVICE, fallbackFactory = RemoteCartFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteCartService</span><br>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/getCartCheckedList/&#123;userId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> R&lt;List&lt;CartInfo&gt;&gt; <span class="hljs-title function_">getCartCheckedList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> Long userId, <span class="hljs-meta">@RequestHeader(SecurityConstants.FROM_SOURCE)</span>String source)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）ServiceNameConstants</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 购物车服务的serviceid</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CART_SERVICE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cart&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>（3）RemoteCartFallbackFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.user.api.factory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 购物车降级处理</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> atguigu</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteCartFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;RemoteCartService&gt;<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(RemoteCartFallbackFactory.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RemoteCartService <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable throwable)</span><br>    &#123;<br>        log.error(<span class="hljs-string">&quot;购物车服务调用失败:&#123;&#125;&quot;</span>, throwable.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteCartService</span>()<br>        &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> R&lt;List&lt;CartInfo&gt;&gt; <span class="hljs-title function_">getCartCheckedList</span><span class="hljs-params">(Long userId, String source)</span> &#123;<br>                <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;获取用户购物车选中数据失败:&quot;</span> + throwable.getMessage());<br>            &#125;<br><br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（4）加载配置类</p>
<p>resources&#x2F;META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.cart.api.factory.RemoteCartFallbackFactory<br></code></pre></td></tr></table></figure>



<h3 id="4-1-4-后端业务接口"><a href="#4-1-4-后端业务接口" class="headerlink" title="4.1.4 后端业务接口"></a>4.1.4 后端业务接口</h3><p>操作模块：order</p>
<h4 id="1、TradeVo"><a href="#1、TradeVo" class="headerlink" title="1、TradeVo"></a>1、TradeVo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.domain;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Schema(description = &quot;结算实体类&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TradeVo</span> &#123;<br><br>    <span class="hljs-meta">@Schema(description = &quot;结算总金额&quot;)</span><br>    <span class="hljs-keyword">private</span> BigDecimal totalAmount;<br><br>    <span class="hljs-meta">@Schema(description = &quot;结算商品列表&quot;)</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; orderItemList;<br><br>    <span class="hljs-meta">@Schema(description = &quot;交易号&quot;)</span><br>    <span class="hljs-keyword">private</span> String tradeNo;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2、OrderInfoController"><a href="#2、OrderInfoController" class="headerlink" title="2、OrderInfoController"></a>2、OrderInfoController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary = &quot;订单结算&quot;)</span><br><span class="hljs-meta">@RequiresLogin</span><br><span class="hljs-meta">@GetMapping(&quot;/trade&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">orderTradeData</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> success(orderInfoService.orderTradeData());<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3、IOrderInfoService"><a href="#3、IOrderInfoService" class="headerlink" title="3、IOrderInfoService"></a>3、IOrderInfoService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">TradeVo <span class="hljs-title function_">orderTradeData</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>

<h4 id="4、OrderInfoServiceImpl"><a href="#4、OrderInfoServiceImpl" class="headerlink" title="4、OrderInfoServiceImpl"></a>4、OrderInfoServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RemoteCartService remoteCartService;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> TradeVo <span class="hljs-title function_">orderTradeData</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 获取当前登录用户的id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> SecurityContextHolder.getUserId();<br><br>    R&lt;List&lt;CartInfo&gt;&gt; cartInfoListResult = remoteCartService.getCartCheckedList(userId, SecurityConstants.INNER);<br>    <span class="hljs-keyword">if</span> (R.FAIL == cartInfoListResult.getCode()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(cartInfoListResult.getMsg());<br>    &#125;<br>    List&lt;CartInfo&gt; cartInfoList = cartInfoListResult.getData();<br>    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(cartInfoList)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;购物车无选中商品&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//将集合泛型从购物车改为订单明细</span><br>    List&lt;OrderItem&gt; orderItemList = <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0</span>);<br>    orderItemList = cartInfoList.stream().map(cartInfo -&gt; &#123;<br>         <span class="hljs-type">OrderItem</span> <span class="hljs-variable">orderItem</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>();<br>         BeanUtils.copyProperties(cartInfo, orderItem);<br>         <span class="hljs-comment">//注意注意，复制主要是为了getSkuPrice，这步纯属多余，但是提醒一下</span><br>         orderItem.setSkuPrice(cartInfo.getSkuPrice());<br>         <span class="hljs-keyword">return</span> orderItem;<br>        &#125;).collect(Collectors.toList());<br><br>        <span class="hljs-comment">//订单总金额</span><br>     <span class="hljs-keyword">for</span>(OrderItem orderItem : orderItemList) &#123;<br>         totalAmount = totalAmount.add(orderItem.getSkuPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(orderItem.getSkuNum())));<br>     &#125;<br><br>    <span class="hljs-comment">//渲染订单确认页面-生成用户流水号</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">tradeNo</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.generateTradeNo(userId);<br><br>    <span class="hljs-type">TradeVo</span> <span class="hljs-variable">tradeVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TradeVo</span>();<br>    tradeVo.setTotalAmount(totalAmount);<br>    tradeVo.setOrderItemList(orderItemList);<br>    tradeVo.setTradeNo(tradeNo);<br>    <span class="hljs-keyword">return</span> tradeVo;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 渲染订单确认页面-生成用户流水号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateTradeNo</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-comment">//1.构建流水号Key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">userTradeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:tradeNo:&quot;</span> + userId;<br>    <span class="hljs-comment">//2.构建流水号value</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">tradeNo</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-comment">//3.将流水号存入Redis 暂存5分钟</span><br>    redisTemplate.opsForValue().set(userTradeKey, tradeNo, <span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>    <span class="hljs-keyword">return</span> tradeNo;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-2-商品下单"><a href="#4-2-商品下单" class="headerlink" title="4.2 商品下单"></a>4.2 商品下单</h2><h3 id="4-2-1-需求说明"><a href="#4-2-1-需求说明" class="headerlink" title="4.2.1 需求说明"></a>4.2.1 需求说明</h3><p>需求说明：用户在结算页面点击提交订单按钮，那么此时就需要保存订单信息(order_info)、订单项信息(order_item)及记录订单日志(order_log)，下单成功重定向到订单支付页面</p>
<p><strong>查看接口文档：</strong></p>
<p>下单接口地址及返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">post /order/orderInfo/submitOrder<br>参数：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;orderItemList&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;skuId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;skuName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小米 红米Note10 5G手机 颜色:黑色 内存:18G&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;thumbImg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://139.198.127.41:9000/20230525/665832167-1_u_1.jpg&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;skuPrice&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2999</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;skuNum&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        ...<br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;userAddressId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;feightFee&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;remark&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;赶快发货&quot;</span><br><span class="hljs-punctuation">&#125;</span><br>返回结果(订单id)：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-2-2-创建order-log表代码"><a href="#4-2-2-创建order-log表代码" class="headerlink" title="4.2.2 创建order_log表代码"></a>4.2.2 创建order_log表代码</h3><p>操作order模块</p>
<p><strong>OrderLog</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.domain;<br><br><span class="hljs-keyword">import</span> io.swagger.v3.oas.annotations.media.Schema;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> com.common.core.annotation.Excel;<br><span class="hljs-keyword">import</span> com.common.core.web.domain.BaseEntity;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 订单操作日志记录对象 order_log</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Schema(description = &quot;订单操作日志记录&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderLog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-comment">/** 订单id */</span><br>    <span class="hljs-meta">@Excel(name = &quot;订单id&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long orderId;<br><br>    <span class="hljs-comment">/** 操作人：用户；系统；后台管理员 */</span><br>    <span class="hljs-meta">@Excel(name = &quot;操作人：用户；系统；后台管理员&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;操作人：用户；系统；后台管理员&quot;)</span><br>    <span class="hljs-keyword">private</span> String operateUser;<br><br>    <span class="hljs-comment">/** 订单状态 */</span><br>    <span class="hljs-meta">@Excel(name = &quot;订单状态&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;订单状态&quot;)</span><br>    <span class="hljs-keyword">private</span> Long processStatus;<br><br>    <span class="hljs-comment">/** 备注 */</span><br>    <span class="hljs-meta">@Excel(name = &quot;备注&quot;)</span><br>    <span class="hljs-meta">@Schema(description = &quot;备注&quot;)</span><br>    <span class="hljs-keyword">private</span> String note;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>OrderLogMapper</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.mapper;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderLogMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;OrderLog&gt;<br>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-2-3-批量获取商品价格接口"><a href="#4-2-3-批量获取商品价格接口" class="headerlink" title="4.2.3 批量获取商品价格接口"></a>4.2.3 批量获取商品价格接口</h3><p>获取最新商品sku价格与购物车价格比较，校验价格是否变化，价格变化就更新购物车价格</p>
<p>这个接口之前已经开发过了，这里直接使用。</p>
<h3 id="4-2-4-更新购物车最新价格"><a href="#4-2-4-更新购物车最新价格" class="headerlink" title="4.2.4 更新购物车最新价格"></a>4.2.4 更新购物车最新价格</h3><p>操作模块：cart</p>
<h4 id="1、远程调用接口开发-1"><a href="#1、远程调用接口开发-1" class="headerlink" title="1、远程调用接口开发"></a>1、远程调用接口开发</h4><p>（1）CartController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary=&quot;更新用户购物车列表价格&quot;)</span><br><span class="hljs-meta">@InnerAuth</span><br><span class="hljs-meta">@GetMapping(&quot;/updateCartPrice/&#123;userId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;Boolean&gt; <span class="hljs-title function_">updateCartPrice</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> Long userId)</span>&#123;<br>    <span class="hljs-keyword">return</span> R.ok(cartService.updateCartPrice(userId));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）ICartService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Boolean <span class="hljs-title function_">updateCartPrice</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure>

<p>（3）CartServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">updateCartPrice</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cartKey</span> <span class="hljs-operator">=</span> getCartKey(userId);<br>    BoundHashOperations&lt;String, String, CartInfo&gt; hashOperations = redisTemplate.boundHashOps(cartKey);<br>    List&lt;CartInfo&gt; cartCachInfoList = hashOperations.values();<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(cartCachInfoList)) &#123;<br>        <span class="hljs-keyword">for</span> (CartInfo cartInfo : cartCachInfoList) &#123;<br>            <span class="hljs-keyword">if</span> (cartInfo.getIsChecked().intValue() == <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-type">SkuPrice</span> <span class="hljs-variable">skuPrice</span> <span class="hljs-operator">=</span> remoteProductService.getSkuPrice(cartInfo.getSkuId(), SecurityConstants.INNER).getData();<br>                cartInfo.setCartPrice(skuPrice.getSalePrice());<br>                cartInfo.setSkuPrice(skuPrice.getSalePrice());<br>                hashOperations.put(cartInfo.getSkuId().toString(), cartInfo);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2、openFeign接口定义-1"><a href="#2、openFeign接口定义-1" class="headerlink" title="2、openFeign接口定义"></a>2、openFeign接口定义</h4><p>操作模块：api-cart</p>
<p>（1）RemoteCartService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/updateCartPrice/&#123;userId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;Boolean&gt; <span class="hljs-title function_">updateCartPrice</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> Long userId, <span class="hljs-meta">@RequestHeader(SecurityConstants.FROM_SOURCE)</span>String source)</span>;<br></code></pre></td></tr></table></figure>

<p>（2）RemoteCartFallbackFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> R&lt;Boolean&gt; <span class="hljs-title function_">updateCartPrice</span><span class="hljs-params">(Long userId, String source)</span> &#123;<br>    <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;更新购物车价格失败:&quot;</span> + throwable.getMessage());<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-2-5-删除购物车选中商品"><a href="#4-2-5-删除购物车选中商品" class="headerlink" title="4.2.5 删除购物车选中商品"></a>4.2.5 删除购物车选中商品</h3><p>下单成功后，删除购物车选中的商品</p>
<p>操作模块：cart</p>
<h4 id="1、远程调用接口开发-2"><a href="#1、远程调用接口开发-2" class="headerlink" title="1、远程调用接口开发"></a>1、远程调用接口开发</h4><p>（1）CartController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary=&quot;删除用户购物车列表中选中商品列表&quot;)</span><br><span class="hljs-meta">@InnerAuth</span><br><span class="hljs-meta">@GetMapping(&quot;/deleteCartCheckedList/&#123;userId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;Boolean&gt; <span class="hljs-title function_">deleteCartCheckedList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> Long userId)</span>&#123;<br>    <span class="hljs-keyword">return</span> R.ok(cartService.deleteCartCheckedList(userId));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）ICartService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Boolean <span class="hljs-title function_">deleteCartCheckedList</span><span class="hljs-params">(Long userId)</span>;<br></code></pre></td></tr></table></figure>

<p>（3）CartServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deleteCartCheckedList</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cartKey</span> <span class="hljs-operator">=</span> getCartKey(userId);<br>    BoundHashOperations&lt;String, String, CartInfo&gt; hashOperations = redisTemplate.boundHashOps(cartKey);<br>    List&lt;CartInfo&gt; cartCachInfoList = hashOperations.values();<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(cartCachInfoList)) &#123;<br>        <span class="hljs-keyword">for</span> (CartInfo cartInfo : cartCachInfoList) &#123;<br>            <span class="hljs-comment">// 获取选中的商品！</span><br>            <span class="hljs-keyword">if</span> (cartInfo.getIsChecked().intValue() == <span class="hljs-number">1</span>) &#123;<br>                hashOperations.delete(cartInfo.getSkuId().toString());<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2、openFeign接口定义-2"><a href="#2、openFeign接口定义-2" class="headerlink" title="2、openFeign接口定义"></a>2、openFeign接口定义</h4><p>操作模块：api-cart</p>
<p>（1）RemoteCartService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/deleteCartCheckedList/&#123;userId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;Boolean&gt; <span class="hljs-title function_">deleteCartCheckedList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> Long userId, <span class="hljs-meta">@RequestHeader(SecurityConstants.FROM_SOURCE)</span>String source)</span>;<br></code></pre></td></tr></table></figure>

<p>（2）RemoteCartFallbackFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> R&lt;Boolean&gt; <span class="hljs-title function_">deleteCartCheckedList</span><span class="hljs-params">(Long userId, String source)</span> &#123;<br>    <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;删除用户购物车选中数据失败:&quot;</span> + throwable.getMessage());<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-2-6-获取用户地址信息"><a href="#4-2-6-获取用户地址信息" class="headerlink" title="4.2.6 获取用户地址信息"></a>4.2.6 获取用户地址信息</h3><h4 id="1、远程调用接口"><a href="#1、远程调用接口" class="headerlink" title="1、远程调用接口"></a>1、远程调用接口</h4><p>操作模块：user</p>
<p>（1）UserAddressController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@InnerAuth</span><br><span class="hljs-meta">@GetMapping(value = &quot;/getUserAddress/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;UserAddress&gt; <span class="hljs-title function_">getUserAddress</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> R.ok(userAddressService.getById(id));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）UserAddress</p>
<p>将user模块UserAddress实体类，移动到api-user模块</p>
<h4 id="2、openFeign接口定义-3"><a href="#2、openFeign接口定义-3" class="headerlink" title="2、openFeign接口定义"></a>2、openFeign接口定义</h4><p>操作模块：api-user</p>
<p>（1）RemoteUserAddressService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.user.api;<br><br><span class="hljs-meta">@FeignClient(contextId = &quot;remoteUserAddressService&quot; , value = ServiceNameConstants.USER_SERVICE, fallbackFactory = RemoteUserAddressFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RemoteUserAddressService</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/userAddress/getUserAddress/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> R&lt;UserAddress&gt; <span class="hljs-title function_">getUserAddress</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id, <span class="hljs-meta">@RequestHeader(SecurityConstants.FROM_SOURCE)</span> String source)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）RemoteUserAddressFallbackFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.user.api.factory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 服务降级处理</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteUserAddressFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;RemoteUserAddressService&gt;<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(RemoteUserAddressFallbackFactory.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> RemoteUserAddressService <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable throwable)</span><br>    &#123;<br>        log.error(<span class="hljs-string">&quot;用户服务调用失败:&#123;&#125;&quot;</span>, throwable.getMessage());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteUserAddressService</span>()<br>        &#123;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> R&lt;UserAddress&gt; <span class="hljs-title function_">getUserAddress</span><span class="hljs-params">(Long id, String source)</span> &#123;<br>                <span class="hljs-keyword">return</span> R.fail(<span class="hljs-string">&quot;获取用户地址失败:&quot;</span> + throwable.getMessage());<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）加载配置类</p>
<p>resources&#x2F;META-INF.spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.user.api.factory.RemoteUserAddressFallbackFactory<br></code></pre></td></tr></table></figure>



<h3 id="4-2-7-后端业务接口"><a href="#4-2-7-后端业务接口" class="headerlink" title="4.2.7 后端业务接口"></a>4.2.7 后端业务接口</h3><p>操作模块：order</p>
<p>1、OrderForm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.domain;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderForm</span> &#123;<br><br>    <span class="hljs-meta">@Schema(description = &quot;用户流水号&quot;)</span><br>    <span class="hljs-keyword">private</span> String tradeNo;<br><br>    <span class="hljs-comment">//送货地址id</span><br>    <span class="hljs-meta">@Schema(description = &quot;送货地址id&quot;)</span><br>    <span class="hljs-keyword">private</span> Long userAddressId;<br><br>    <span class="hljs-comment">//运费</span><br>    <span class="hljs-meta">@Schema(description = &quot;运费&quot;)</span><br>    <span class="hljs-keyword">private</span> BigDecimal feightFee;<br>    <br>    <span class="hljs-comment">//备注</span><br>    <span class="hljs-meta">@Schema(description = &quot;备注&quot;)</span><br>    <span class="hljs-keyword">private</span> String remark;<br>    <br>    <span class="hljs-meta">@Schema(description = &quot;结算商品列表&quot;)</span><br>    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; orderItemList;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>2、OrderInfoController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary = &quot;用户提交订单&quot;)</span><br><span class="hljs-meta">@RequiresLogin</span><br><span class="hljs-meta">@PostMapping(&quot;/submitOrder&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderForm orderForm)</span> &#123;<br>    <span class="hljs-keyword">return</span> success(orderInfoService.submitOrder(orderForm));<br>&#125;<br></code></pre></td></tr></table></figure>



<p>3、IOrderInfoService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Long <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrderForm orderForm)</span>;<br></code></pre></td></tr></table></figure>



<p>4、OrderInfoServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RemoteProductService remoteProductService;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RemoteUserAddressService remoteUserAddressService;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> OrderLogMapper orderLogMapper;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 验证页面提交流水号是否有效</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> tradeNo</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">checkTradeNo</span><span class="hljs-params">(String userId, String tradeNo)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">userTradeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:tradeNo:&quot;</span> + userId;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisTradeNo</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(userTradeKey);<br>    <span class="hljs-keyword">return</span> tradeNo.equals(redisTradeNo);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 删除流水号</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteTradeNo</span><span class="hljs-params">(String userId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">userTradeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:tradeNo:&quot;</span> + userId;<br>    redisTemplate.delete(userTradeKey);<br>&#125;<br><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Long <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrderForm orderForm)</span> &#123;<br>    <span class="hljs-comment">// 获取当前登录用户的id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> SecurityContextHolder.getUserId();<br><br>    <span class="hljs-comment">//1.验证用户是否通过浏览器回退进行重复提交订单</span><br>    <span class="hljs-comment">//1.1 获取Redis中存放流水号 跟用户提交比较</span><br>    <span class="hljs-comment">//Boolean flag = this.checkTradeNo(orderInfo.getUserId().toString(), tradeNo);</span><br>    <span class="hljs-comment">//if (!flag) &#123;</span><br>    <span class="hljs-comment">//    throw new RuntimeException(&quot;请勿重复提交订单，请尝试重试&quot;);</span><br>    <span class="hljs-comment">//&#125;</span><br>    <span class="hljs-comment">//1.2 验证通过，将Redis中存放流水号删除</span><br>    <span class="hljs-comment">//this.deleteTradeNo(orderInfo.getUserId().toString());</span><br><br>    <span class="hljs-comment">//1.3 采用Lua脚本保证判断删除流水号原子性 KEYS[1]:流水号Key    ARGV[1]：用户流水号</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">userTradeKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user:tradeNo:&quot;</span> + userId;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">scriptText</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1]\n&quot;</span> +<br>            <span class="hljs-string">&quot;then\n&quot;</span> +<br>            <span class="hljs-string">&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot;</span> +<br>            <span class="hljs-string">&quot;else\n&quot;</span> +<br>            <span class="hljs-string">&quot;    return 0\n&quot;</span> +<br>            <span class="hljs-string">&quot;end&quot;</span>;<br>    DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>    redisScript.setScriptText(scriptText);<br>    redisScript.setResultType(Long.class);<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> (Long) redisTemplate.execute(redisScript, Arrays.asList(userTradeKey), orderForm.getTradeNo());<br>    <span class="hljs-keyword">if</span> (flag == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;请勿重复提交订单，请尝试重试&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//2. 判断购物项</span><br>    List&lt;OrderItem&gt; orderItemList = orderForm.getOrderItemList();<br>    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(orderItemList)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;请求不合法&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//3.订单校验</span><br>    <span class="hljs-comment">//3.1.校验价格</span><br>    List&lt;Long&gt; skuIdList = orderItemList.stream().map(OrderItem::getSkuId).collect(Collectors.toList());<br>    <br>    R&lt;List&lt;SkuPrice&gt;&gt; skuPriceListResult = remoteProductService.getSkuPriceList(skuIdList, SecurityConstants.INNER);<br>    <span class="hljs-keyword">if</span> (R.FAIL == skuPriceListResult.getCode()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(skuPriceListResult.getMsg());<br>    &#125;<br>    List&lt;SkuPrice&gt; skuPriceList = skuPriceListResult.getData();<br>    <br>    Map&lt;Long, BigDecimal&gt; skuIdToSalePriceMap = skuPriceList.stream().collect(Collectors.toMap(SkuPrice::getSkuId, SkuPrice::getSalePrice));<br>    <br>    <span class="hljs-type">String</span> <span class="hljs-variable">priceCheckResult</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        <span class="hljs-keyword">if</span> (orderItem.getSkuPrice().compareTo(skuIdToSalePriceMap.get(orderItem.getSkuId())) != <span class="hljs-number">0</span>) &#123;<br>            priceCheckResult += orderItem.getSkuName() + <span class="hljs-string">&quot;价格变化了; &quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(priceCheckResult)) &#123;<br>        <span class="hljs-comment">//更新购物车价格</span><br>        remoteCartService.updateCartPrice(userId, SecurityConstants.INNER);<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(priceCheckResult);<br>    &#125;<br><br>    <span class="hljs-comment">//3.2.校验库存并锁定库存</span><br>    <span class="hljs-comment">//TODO ...</span><br><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//4 下单</span><br>        orderId = <span class="hljs-built_in">this</span>.saveOrder(orderForm);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-comment">//抛出异常</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;下单失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//5 删除购物车选项</span><br>    remoteCartService.deleteCartCheckedList(userId, SecurityConstants.INNER);<br>    <span class="hljs-keyword">return</span> orderId;<br>&#125;<br><br><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> Long <span class="hljs-title function_">saveOrder</span><span class="hljs-params">(OrderForm orderForm)</span> &#123;<br>    <span class="hljs-comment">// 获取当前登录用户的id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> SecurityContextHolder.getUserId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> SecurityContextHolder.getUserName();<br><br>    <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();<br>    orderInfo.setOrderNo(orderForm.getTradeNo());<br>    orderInfo.setUserId(userId);<br>    orderInfo.setNickName(userName);<br>	orderInfo.setRemark(orderForm.getRemark());<br>    <span class="hljs-type">UserAddress</span> <span class="hljs-variable">userAddress</span> <span class="hljs-operator">=</span> remoteUserAddressService.getUserAddress(orderForm.getUserAddressId(), SecurityConstants.INNER).getData();<br>    orderInfo.setReceiverName(userAddress.getName());<br>    orderInfo.setReceiverPhone(userAddress.getPhone());<br>    orderInfo.setReceiverTagName(userAddress.getTagName());<br>    orderInfo.setReceiverProvince(userAddress.getProvinceCode());<br>    orderInfo.setReceiverCity(userAddress.getCityCode());<br>    orderInfo.setReceiverDistrict(userAddress.getDistrictCode());<br>    orderInfo.setReceiverAddress(userAddress.getFullAddress());<br><br>    List&lt;OrderItem&gt; orderItemList = orderForm.getOrderItemList();<br>    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalAmount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        totalAmount = totalAmount.add(orderItem.getSkuPrice().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(orderItem.getSkuNum())));<br>    &#125;<br>    orderInfo.setTotalAmount(totalAmount);<br>    orderInfo.setCouponAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0</span>));<br>    orderInfo.setOriginalTotalAmount(totalAmount);<br>    orderInfo.setFeightFee(orderForm.getFeightFee());<br>    <span class="hljs-comment">//OrderInfo类的orderStatus属性的类型改为Integer</span><br>    orderInfo.setOrderStatus(<span class="hljs-number">0</span>);<br>    orderInfoMapper.insert(orderInfo);<br><br>    <span class="hljs-comment">//保存订单明细</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setOrderId(orderInfo.getId());<br>        orderItemMapper.insert(orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//记录日志</span><br>    <span class="hljs-type">OrderLog</span> <span class="hljs-variable">orderLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderLog</span>();<br>    orderLog.setOrderId(orderInfo.getId());<br>    orderLog.setProcessStatus(<span class="hljs-number">0</span>);<br>    orderLog.setNote(<span class="hljs-string">&quot;提交订单&quot;</span>);<br>    orderLogMapper.insert(orderLog);<br>    <span class="hljs-keyword">return</span> orderInfo.getId();<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-3-检查与锁定库存"><a href="#4-3-检查与锁定库存" class="headerlink" title="4.3 检查与锁定库存"></a>4.3 检查与锁定库存</h2><p>我们的商品不允许超卖，为了防止超卖，我们下单必须检查与锁定库存，下单失败或取消订单要解锁库存，支付成功扣减库存</p>
<h3 id="4-3-1-远程调用接口"><a href="#4-3-1-远程调用接口" class="headerlink" title="4.3.1 远程调用接口"></a>4.3.1 远程调用接口</h3><p>操作模块：product</p>
<p>1、ProductController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@InnerAuth</span><br><span class="hljs-meta">@Operation(summary = &quot;检查与锁定库存&quot;)</span><br><span class="hljs-meta">@PostMapping(&quot;checkAndLock/&#123;orderNo&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;String&gt; <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String orderNo, <span class="hljs-meta">@RequestBody</span> List&lt;SkuLockVo&gt; skuLockVoList)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> R.ok(productService.checkAndLock(orderNo, skuLockVoList));<br>    &#125; <span class="hljs-keyword">catch</span> (ServiceException e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-keyword">return</span> R.ok(e.getMessage());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-keyword">return</span> R.ok(<span class="hljs-string">&quot;库存不足&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2、SkuLockVo</p>
<p>操作模块：api-product</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.product.api.domain;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkuLockVo</span><br>&#123;<br><br>    <span class="hljs-keyword">private</span> Long skuId;<br><br>    <span class="hljs-keyword">private</span> Integer skuNum;<br><br>    <span class="hljs-comment">/** 是否有库存 **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">isHaveStock</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>3、IProductService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">String <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">(String orderNo, List&lt;SkuLockVo&gt; skuLockVoList)</span>;<br></code></pre></td></tr></table></figure>

<p>4、ProductServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(rollbackFor = &#123;Exception.class&#125;)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">(String orderNo, List&lt;SkuLockVo&gt; skuLockVoList)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sku:checkAndLock:&quot;</span> + orderNo;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">dataKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sku:lock:data:&quot;</span> + orderNo;<br>    <span class="hljs-comment">//防止重复请求</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, orderNo, <span class="hljs-number">1</span>, TimeUnit.HOURS);<br>    <span class="hljs-keyword">if</span> (!isExist) &#123;<br>        <span class="hljs-comment">//如果存在，则已执行过库存锁定</span><br>        <span class="hljs-keyword">if</span>(redisTemplate.hasKey(dataKey)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;重复提交&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 遍历所有商品，验库存并锁库存，要具备原子性</span><br>    skuLockVoList.forEach(skuLockVo -&gt; &#123;<br>        <span class="hljs-comment">// 验库存：查询，返回的是满足要求的库存列表</span><br>        <span class="hljs-type">SkuStock</span> <span class="hljs-variable">skuStock</span> <span class="hljs-operator">=</span> skuStockMapper.check(skuLockVo.getSkuId(), skuLockVo.getSkuNum());<br>        <span class="hljs-comment">// 如果没有一个商品满足要求，这里就验库存失败</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == skuStock) &#123;<br>            skuLockVo.setIsHaveStock(<span class="hljs-literal">false</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            skuLockVo.setIsHaveStock(<span class="hljs-literal">true</span>);<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-comment">// 只要有一个商品锁定失败，所有锁定成功的商品要解锁库存</span><br>    <span class="hljs-keyword">if</span> (skuLockVoList.stream().anyMatch(skuLockVo -&gt; !skuLockVo.getIsHaveStock())) &#123;<br>        <span class="hljs-comment">// 获取所有锁定成功的商品，遍历解锁库存</span><br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-comment">//获取没有库存的对象列表</span><br>        List&lt;SkuLockVo&gt; noHaveStockSkuLockVoList = skuLockVoList.stream().filter(item -&gt; !item.getIsHaveStock()).collect(Collectors.toList());<br>        <span class="hljs-keyword">for</span>(SkuLockVo noHaveStockSkuLockVo : noHaveStockSkuLockVoList) &#123;<br>            <span class="hljs-comment">//解除去重</span><br>            <span class="hljs-comment">//you&#x27;dia</span><br>            <span class="hljs-comment">//this.redisTemplate.delete(key);</span><br>            result.append(<span class="hljs-string">&quot;商品: &quot;</span> + noHaveStockSkuLockVo.getSkuId() + <span class="hljs-string">&quot; 库存不足; &quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//锁定失败，解除</span><br>        redisTemplate.delete(key);<br>        <span class="hljs-comment">// 响应锁定状态</span><br>        <span class="hljs-keyword">return</span> result.toString();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//锁定库存</span><br>        skuLockVoList.forEach(skuLockVo -&gt; &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> skuStockMapper.lock(skuLockVo.getSkuId(), skuLockVo.getSkuNum());<br>            <span class="hljs-keyword">if</span>(row == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">//解除去重</span><br>                <span class="hljs-built_in">this</span>.redisTemplate.delete(key);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;库存锁定失败&quot;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 如果所有商品都锁定成功的情况下，需要缓存锁定信息到redis。以方便将来解锁库存 或者 减库存</span><br>    <span class="hljs-built_in">this</span>.redisTemplate.opsForValue().set(dataKey, skuLockVoList);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5、SkuStockMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">SkuStock <span class="hljs-title function_">check</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;skuId&quot;)</span> Long skuId, <span class="hljs-meta">@Param(&quot;num&quot;)</span>Integer num)</span>;<br><br>Integer <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;skuId&quot;)</span> Long skuId, <span class="hljs-meta">@Param(&quot;num&quot;)</span>Integer num)</span>;<br></code></pre></td></tr></table></figure>

<p>6、SkuStockMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta"><span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta"><span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.product.mapper.SkuStockMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;SkuStock&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;SkuStockResult&quot;</span> <span class="hljs-attr">autoMapping</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;check&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SkuStockResult&quot;</span>&gt;</span><br>        select * from sku_stock where sku_id = #&#123;skuId&#125; and available_num &gt; #&#123;num&#125; for update<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;lock&quot;</span>&gt;</span><br>        update sku_stock<br>        set lock_num = lock_num + #&#123;num&#125;, available_num = available_num - #&#123;num&#125;<br>        where sku_id = #&#123;skuId&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>select for update 这个语句的作用是在读取数据时给数据行加锁，以防止其他事务并发修改相同的数据行。</p>
<h3 id="4-3-2-openFeign接口定义"><a href="#4-3-2-openFeign接口定义" class="headerlink" title="4.3.2 openFeign接口定义"></a>4.3.2 openFeign接口定义</h3><p>RemoteProductService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/product/checkAndLock/&#123;orderNo&#125;&quot;)</span><br><span class="hljs-keyword">public</span> R&lt;String&gt; <span class="hljs-title function_">checkAndLock</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;orderNo&quot;)</span> String orderNo, <span class="hljs-meta">@RequestBody</span> List&lt;SkuLockVo&gt; skuLockVoList, <span class="hljs-meta">@RequestHeader(SecurityConstants.FROM_SOURCE)</span> String source)</span>;<br></code></pre></td></tr></table></figure>



<h2 id="4-4-RabbitMQ使用"><a href="#4-4-RabbitMQ使用" class="headerlink" title="4.4 RabbitMQ使用"></a>4.4 RabbitMQ使用</h2><h3 id="4-4-1-封装RabbitMQ"><a href="#4-4-1-封装RabbitMQ" class="headerlink" title="4.4.1 封装RabbitMQ"></a>4.4.1 封装RabbitMQ</h3><p>由于消息队列是公共模块，我们把mq的相关代码（生产者）封装到该模块，其他service微服务模块都可能使用，因此我们把他封装到一个单独的模块，需要使用mq的模块直接引用该模块即可</p>
<p>1、新建模块</p>
<p>在<code>common</code>模块下新建<code>common-rabbit</code>模块</p>
<p>2、pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span><br>        common-rabbit服务<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--rabbitmq消息队列--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 缓存服务 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>3、RabbitService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.common.rabbit.service;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exchange   交换机</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> routingKey 路由键</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message    消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String exchange, String routingKey, Object message)</span> &#123;<br>        rabbitTemplate.convertAndSend(exchange, routingKey, message);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>4、加载配置类</p>
<p>resources&#x2F;META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.common.rabbit.service.RabbitService<br></code></pre></td></tr></table></figure>

<p>5、MqConst</p>
<p>提供常量类 MqConst</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.common.rabbit.constant;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MqConst</span> &#123;<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_TEST</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_TEST</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_CONFIRM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;confirm&quot;</span>;<br>    <span class="hljs-comment">//队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_TEST</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_CONFIRM</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;confirm&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 库存</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_PRODUCT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;product&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_UNLOCK</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;unlock&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_MINUS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;minus&quot;</span>;<br>    <span class="hljs-comment">//队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_UNLOCK</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;unlock&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_MINUS</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;minus&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 支付</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_PAYMENT_PAY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payment&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_PAYMENT_PAY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payment.pay&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_PAYMENT_CLOSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payment.close&quot;</span>;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_PAYMENT_PAY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payment.pay&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_PAYMENT_CLOSE</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;queue.payment.close&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 取消订单延迟消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EXCHANGE_CANCEL_ORDER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cancel.order&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ROUTING_CANCEL_ORDER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cancel.order&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">QUEUE_CANCEL_ORDER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;cancel.order&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">CANCEL_ORDER_DELAY_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span> * <span class="hljs-number">60</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-4-2-RabbitMQ测试"><a href="#4-4-2-RabbitMQ测试" class="headerlink" title="4.4.2 RabbitMQ测试"></a>4.4.2 RabbitMQ测试</h3><p>我们在<code>order</code>模块测试mq消息</p>
<p>1、配置RabbitMQ</p>
<p>在nacos配置中心，order-dev.yml文件添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br></code></pre></td></tr></table></figure>

<p>说明：host改为实际的IP</p>
<p>2、引入common-rabbit模块</p>
<p>在<code>order</code>模块pom.xml文件添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>3、MqController</p>
<p> 发送消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.controller;<br><br><span class="hljs-meta">@Tag(name = &quot;Mq接口管理&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/mq&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MqController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseController</span><br>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitService rabbitService;<br><br>    <span class="hljs-meta">@Operation(summary = &quot;发送消息&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMessage&quot;)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">sendMessage</span><span class="hljs-params">()</span><br>    &#123;<br>        rabbitService.sendMessage(MqConst.EXCHANGE_TEST, MqConst.ROUTING_TEST, <span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-keyword">return</span> success();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>4、TestReceiver</p>
<p>监听消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.receiver;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestReceiver</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 监听消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            exchange = @Exchange(value = MqConst.EXCHANGE_TEST, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            value = @Queue(value = MqConst.QUEUE_TEST, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            key = MqConst.ROUTING_TEST</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(String content, Message message)</span> &#123;<br>        <span class="hljs-comment">//都可以</span><br>        log.info(<span class="hljs-string">&quot;接收消息：&#123;&#125;&quot;</span>, content);<br>        <span class="hljs-comment">//log.info(&quot;接收消息：&#123;&#125;&quot;, new String(message.getBody()));</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5、knife4j测试</p>
<p>发送消息</p>
<p><img src="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC4%E7%AB%A0_%E8%AE%A2%E5%8D%95/1709020757929.png" srcset="/img/loading.gif" lazyload></p>
<!--

![](第4章_订单/1709020757929.png)

-->

<p>监听消息：查看idea打印结果</p>
<h3 id="4-4-3-消息可靠性配置"><a href="#4-4-3-消息可靠性配置" class="headerlink" title="4.4.3 消息可靠性配置"></a>4.4.3 消息可靠性配置</h3><h4 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h4><p>MQ消息的可靠性，一般需要三个方面一起保证：</p>
<ol>
<li>生产者不丢数据</li>
<li>MQ服务器不丢数据</li>
<li>消费者不丢数据</li>
</ol>
<p>保证消息不丢失有两种实现方式：</p>
<ul>
<li>开启事务模式</li>
<li>消息确认模式（生产者，消费者）</li>
</ul>
<p><strong>说明：</strong>开启事务会大幅降低消息发送及接收效率，使用的相对较少，因此我们生产环境一般都采取消息确认模式，以下我们只是讲解消息确认模式</p>
<h4 id="2、消息发送确认配置"><a href="#2、消息发送确认配置" class="headerlink" title="2、消息发送确认配置"></a>2、消息发送确认配置</h4><p>消息发送确认可以保证生产者不丢数据</p>
<p>（1）封装发送端消息确认配置类</p>
<p>操作模块：<code>common-rabbit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.common.rabbit.config;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.event.ApplicationReadyEvent;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationListener;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitInitConfigApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ApplicationReadyEvent event)</span> &#123;<br>        <span class="hljs-built_in">this</span>.setupCallbacks();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setupCallbacks</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> correlation 相关数据  非消息本身业务数据</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> ack             应答结果</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (ack) &#123;<br>                <span class="hljs-comment">//消息到交换器成功</span><br>                log.info(<span class="hljs-string">&quot;消息发送到Exchange成功：&#123;&#125;&quot;</span>, correlationData);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//消息到交换器失败</span><br>                log.error(<span class="hljs-string">&quot;消息发送到Exchange失败：&#123;&#125;&quot;</span>, reason);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; &#123;<br>            log.error(<span class="hljs-string">&quot;Returned: &quot;</span> + returned.getMessage() + <span class="hljs-string">&quot;\nreplyCode: &quot;</span> + returned.getReplyCode()<br>                    + <span class="hljs-string">&quot;\nreplyText: &quot;</span> + returned.getReplyText() + <span class="hljs-string">&quot;\nexchange/rk: &quot;</span><br>                    + returned.getExchange() + <span class="hljs-string">&quot;/&quot;</span> + returned.getRoutingKey());<br><br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）加载配置类</p>
<p>resources&#x2F;META-INF&#x2F;spring&#x2F;org.springframework.boot.autoconfigure.AutoConfiguration.imports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">com.common.rabbit.config.RabbitInitConfigApplicationListener<br></code></pre></td></tr></table></figure>

<p>（3）修改配置</p>
<p>在nacos配置中心，修改order-dev.yml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">CORRELATED</span> <span class="hljs-comment">#发布消息成功到交换器后会触发回调方法</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 未投递到Queue退回模式</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">cknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment">#默认自动确认，手动确认manual</span><br>        <span class="hljs-attr">prefetch:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 消费者每次从队列获取的消息数量。不设置：轮询分发，设置1：能者多劳</span><br></code></pre></td></tr></table></figure>

<p><img src="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC4%E7%AB%A0_%E8%AE%A2%E5%8D%95/image-0610.png" srcset="/img/loading.gif" lazyload></p>
<!--

![](/第4章_订单/image-0610.png)

-->

<p>（4）MqController</p>
<p>发送确认消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary = &quot;发送确认消息&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/sendConfirmMessage&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">sendConfirmMessage</span><span class="hljs-params">()</span><br>&#123;<br>    rabbitService.sendMessage(MqConst.EXCHANGE_TEST, MqConst.ROUTING_CONFIRM, <span class="hljs-string">&quot;hello, confirm&quot;</span>);<br>    <span class="hljs-keyword">return</span> success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（5）TestReceiver</p>
<p>监听确认消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 监听确认消息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">        exchange = @Exchange(value = MqConst.EXCHANGE_TEST, durable = &quot;true&quot;),</span><br><span class="hljs-meta">        value = @Queue(value = MqConst.QUEUE_CONFIRM, durable = &quot;true&quot;),</span><br><span class="hljs-meta">        key = MqConst.ROUTING_CONFIRM</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(String content, Message message, Channel channel)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;接收确认消息：&#123;&#125;&quot;</span>, content);<br><br>    <span class="hljs-comment">// false 确认一个消息，true 批量确认</span><br>    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="3、消息发送失败后设置重发机制"><a href="#3、消息发送失败后设置重发机制" class="headerlink" title="3、消息发送失败后设置重发机制"></a>3、消息发送失败后设置重发机制</h4><p>实现思路：借助redis来实现重发机制</p>
<p>操作模块：<code>pzx-common-rabbit</code></p>
<p>（1）GmallCorrelationData</p>
<p>自定义一个实体类来接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.common.rabbit.entity;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GuiguCorrelationData</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CorrelationData</span> &#123;<br><br>    <span class="hljs-comment">//消息体</span><br>    <span class="hljs-keyword">private</span> Object message;<br>    <span class="hljs-comment">//交换机</span><br>    <span class="hljs-keyword">private</span> String exchange;<br>    <span class="hljs-comment">//路由键</span><br>    <span class="hljs-keyword">private</span> String routingKey;<br>    <span class="hljs-comment">//重试次数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//是否延迟消息</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isDelay</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">//延迟时长</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">delayTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）RabbitService</p>
<p>修改发送方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *  发送消息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> exchange 交换机</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> routingKey 路由键</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> message 消息</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String exchange, String routingKey, Object message)</span> &#123;<br>    <span class="hljs-comment">//1.创建自定义相关消息对象-包含业务数据本身，交换器名称，路由键，队列类型，延迟时间,重试次数</span><br>    <span class="hljs-type">GuiguCorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguCorrelationData</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq:&quot;</span> + UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    correlationData.setId(uuid);<br>    correlationData.setMessage(message);<br>    correlationData.setExchange(exchange);<br>    correlationData.setRoutingKey(routingKey);<br>    <br>    <span class="hljs-comment">//2.将相关消息存入Redis  Key：UUID  相关消息对象  10 分钟</span><br>    redisTemplate.opsForValue().set(uuid, JSON.toJSONString(correlationData), <span class="hljs-number">10</span>, TimeUnit.MINUTES);<br>    <br>    <span class="hljs-comment">//3.将相关消息封装到发送消息方法中（注意：步骤2和3的代码顺序）</span><br>    rabbitTemplate.convertAndSend(exchange, routingKey, message, correlationData);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）RabbitInitConfigApplicationListener</p>
<p>修改RabbitInitConfigApplicationListener类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.common.rabbit.config;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitInitConfigApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ApplicationReadyEvent event)</span> &#123;<br>        <span class="hljs-built_in">this</span>.setupCallbacks();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setupCallbacks</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> correlation 相关数据  非消息本身业务数据</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> ack         应答结果</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> reason      如果发送消息到交换器失败，错误原因</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (ack) &#123;<br>                <span class="hljs-comment">//消息到交换器成功</span><br>                log.info(<span class="hljs-string">&quot;消息发送到Exchange成功：&#123;&#125;&quot;</span>, correlationData);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//消息到交换器失败</span><br>                log.error(<span class="hljs-string">&quot;消息发送到Exchange失败：&#123;&#125;&quot;</span>, reason);<br><br>                <span class="hljs-comment">//执行消息重发</span><br>                <span class="hljs-built_in">this</span>.retrySendMsg(correlationData);<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; &#123;<br>            log.error(<span class="hljs-string">&quot;Returned: &quot;</span> + returned.getMessage() + <span class="hljs-string">&quot;\nreplyCode: &quot;</span> + returned.getReplyCode()<br>                    + <span class="hljs-string">&quot;\nreplyText: &quot;</span> + returned.getReplyText() + <span class="hljs-string">&quot;\nexchange/rk: &quot;</span><br>                    + returned.getExchange() + <span class="hljs-string">&quot;/&quot;</span> + returned.getRoutingKey());<br><br>            <span class="hljs-comment">//当路由队列失败 也需要重发</span><br>            <span class="hljs-comment">//1.构建相关数据对象</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> returned.getMessage().getMessageProperties().getHeader(<span class="hljs-string">&quot;spring_returned_message_correlation&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">correlationDataStr</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(redisKey);<br>            <span class="hljs-type">GuiguCorrelationData</span> <span class="hljs-variable">guiguCorrelationData</span> <span class="hljs-operator">=</span> JSON.parseObject(correlationDataStr, GuiguCorrelationData.class);<br>            <span class="hljs-comment">//2.调用消息重发方法</span><br>            <span class="hljs-built_in">this</span>.retrySendMsg(guiguCorrelationData);<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消息重新发送</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> correlationData</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">retrySendMsg</span><span class="hljs-params">(CorrelationData correlationData)</span> &#123;<br>        <span class="hljs-comment">//1.获取相关数据</span><br>        <span class="hljs-type">GuiguCorrelationData</span> <span class="hljs-variable">gmallCorrelationData</span> <span class="hljs-operator">=</span> (GuiguCorrelationData) correlationData;<br><br>        <span class="hljs-comment">//获取redis中存放重试次数</span><br>        <span class="hljs-comment">//先重发，在写会到redis中次数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> gmallCorrelationData.getRetryCount();<br>        <span class="hljs-keyword">if</span> (retryCount &gt;= <span class="hljs-number">3</span>) &#123;<br>            <span class="hljs-comment">//超过最大重试次数</span><br>            log.error(<span class="hljs-string">&quot;生产者超过最大重试次数，将失败的消息存入数据库用人工处理；给管理员发送邮件；给管理员发送短信；&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">//2.重发次数+1</span><br>        retryCount += <span class="hljs-number">1</span>;<br>        gmallCorrelationData.setRetryCount(retryCount);<br>        redisTemplate.opsForValue().set(gmallCorrelationData.getId(), JSON.toJSONString(gmallCorrelationData), <span class="hljs-number">10</span>, TimeUnit.MINUTES);<br>        <br>        <span class="hljs-comment">//3.重发消息（注意：步骤2和3的代码顺序）</span><br>        rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(), gmallCorrelationData.getRoutingKey(), gmallCorrelationData.getMessage(), gmallCorrelationData);<br><br>        log.info(<span class="hljs-string">&quot;进行消息重发！&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="4-4-4-延迟消息"><a href="#4-4-4-延迟消息" class="headerlink" title="4.4.4 延迟消息"></a>4.4.4 延迟消息</h3><p>延迟消息：生产者发送消息时指定一个时间，消费者不会立刻收到消息，而是在指定时间后才收到消息。</p>
<p>延迟消息有两种实现方案：</p>
<p>1，基于死信队列</p>
<p>2，集成延迟插件</p>
<h4 id="4-4-4-1-基于死信实现延迟消息"><a href="#4-4-4-1-基于死信实现延迟消息" class="headerlink" title="4.4.4.1 基于死信实现延迟消息"></a>4.4.4.1 基于死信实现延迟消息</h4><p>使用RabbitMQ来实现延迟消息必须先了解RabbitMQ的两个概念：消息的TTL和死信Exchange，通过这两者的组合来实现延迟队列</p>
<h5 id="1、消息的TTL（Time-To-Live）"><a href="#1、消息的TTL（Time-To-Live）" class="headerlink" title="1、消息的TTL（Time To Live）"></a>1、消息的TTL（Time To Live）</h5><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</p>
<p>如何设置TTL：</p>
<p>我们创建一个队列queue.temp，在Arguments 中添加x-message-ttl 为5000 （单位是毫秒），那所有压在这个队列的消息在5秒后会消失。</p>
<h5 id="2、死信交换机-Dead-Letter-Exchanges"><a href="#2、死信交换机-Dead-Letter-Exchanges" class="headerlink" title="2、死信交换机  Dead Letter Exchanges"></a>2、死信交换机  Dead Letter Exchanges</h5><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列，一个路由可以对应很多队列。</p>
<p>（1） 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</p>
<p>（2）<strong>上面的消息的TTL到了，消息过期了。</strong></p>
<p>（3）队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上。</p>
<p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p>
<p><img src="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC4%E7%AB%A0_%E8%AE%A2%E5%8D%95/wps157.jpg" srcset="/img/loading.gif" lazyload> </p>
<!--

![](第4章_订单/wps157-17314071724715.jpg) 

-->



<p>我们现在可以测试一下延迟队列。</p>
<p>（1）创建死信队列 </p>
<p>（2）创建交换机 </p>
<p>（3）建立交换器与队列之间的绑定 </p>
<p>（4）创建队列</p>
<h5 id="3、代码实现"><a href="#3、代码实现" class="headerlink" title="3、代码实现"></a>3、代码实现</h5><p>操作模块：<code>order</code></p>
<p>（1）DeadLetterMqConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.configure;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Binding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.BindingBuilder;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.DirectExchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Queue;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadLetterMqConfig</span> &#123;<br>    <span class="hljs-comment">// 声明一些变量</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">exchange_dead</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange.dead&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">routing_dead_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;routing.dead.1&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">routing_dead_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;routing.dead.2&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">queue_dead_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;queue.dead.1&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">queue_dead_2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;queue.dead.2&quot;</span>;<br><br>    <span class="hljs-comment">// 定义交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">exchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(exchange_dead, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 设置如果队列一 出现问题，则通过参数转到exchange_dead，routing_dead_2 上！</span><br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">// 参数绑定 此处的key 固定值，不能随意写</span><br>        map.put(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, exchange_dead);<br>        map.put(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, routing_dead_2);<br>        <span class="hljs-comment">// 设置延迟时间</span><br>        map.put(<span class="hljs-string">&quot;x-message-ttl&quot;</span>, <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>);<br>        <span class="hljs-comment">// 队列名称，是否持久化，是否独享、排外的【true:只可以在本次连接中访问】，是否自动删除，队列的其他属性参数</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(queue_dead_1, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, map);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 将队列一 通过routing_dead_1 key 绑定到exchange_dead 交换机上</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue1()).to(exchange()).with(routing_dead_1);<br>    &#125;<br><br>    <span class="hljs-comment">// 这个队列二就是一个普通队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(queue_dead_2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 设置队列二的绑定规则</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">binding2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 将队列二通过routing_dead_2 key 绑定到exchange_dead交换机上！</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue2()).to(exchange()).with(routing_dead_2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）MqController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 消息发送延迟消息：基于死信实现</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Operation(summary = &quot;发送延迟消息：基于死信实现&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/sendDeadLetterMsg&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">sendDeadLetterMsg</span><span class="hljs-params">()</span> &#123;<br>    rabbitService.sendMessage(DeadLetterMqConfig.exchange_dead, DeadLetterMqConfig.routing_dead_1, <span class="hljs-string">&quot;我是延迟消息&quot;</span>);<br>    <span class="hljs-keyword">return</span> success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）TestReceiver</p>
<p>接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 监听延迟消息</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> channel</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@RabbitListener(queues = &#123;DeadLetterMqConfig.queue_dead_2&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDeadLetterMsg</span><span class="hljs-params">(String msg, Message message, Channel channel)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;死信消费者：&#123;&#125;&quot;</span>, msg);<br>    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="4-4-4-2-基于延迟插件实现延迟消息"><a href="#4-4-4-2-基于延迟插件实现延迟消息" class="headerlink" title="4.4.4.2 基于延迟插件实现延迟消息"></a>4.4.4.2 基于延迟插件实现延迟消息</h4><p>Rabbitmq实现了一个插件x-delay-message来实现延时队列</p>
<h5 id="1、插件安装"><a href="#1、插件安装" class="headerlink" title="1、插件安装"></a>1、插件安装</h5><p>参考<code>01-软件环境准备#6</code></p>
<h5 id="2、代码实现"><a href="#2、代码实现" class="headerlink" title="2、代码实现"></a>2、代码实现</h5><p>操作模块：<code>order</code></p>
<p>（1）DelayedMqConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.order.configure;<br><br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Binding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.BindingBuilder;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.CustomExchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Queue;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedMqConfig</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">exchange_delay</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;exchange.delay&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">routing_delay</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;routing.delay&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">queue_delay_1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;queue.delay.1&quot;</span>;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">delayQeue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(queue_delay_1, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title function_">delayExchange</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        args.put(<span class="hljs-string">&quot;x-delayed-type&quot;</span>, <span class="hljs-string">&quot;direct&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomExchange</span>(exchange_delay, <span class="hljs-string">&quot;x-delayed-message&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">delayBbinding1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(delayQeue1()).to(delayExchange()).with(routing_delay).noargs();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）MqController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary = &quot;发送延迟消息：基于延迟插件&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/sendDelayMsg&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">sendDelayMsg</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//调用工具方法发送延迟消息</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">delayTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    rabbitService.sendDealyMessage(DelayedMqConfig.exchange_delay, DelayedMqConfig.routing_delay, <span class="hljs-string">&quot;我是延迟消息&quot;</span>, delayTime);<br>    <span class="hljs-keyword">return</span> success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）RabbitService</p>
<p>封装到工具类模块</p>
<p>操作模块：<code>common-rabbit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发送延迟消息方法</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> exchange 交换机</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> routingKey 路由键</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> message 消息数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> delayTime 延迟时间，单位为：秒</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">sendDealyMessage</span><span class="hljs-params">(String exchange, String routingKey, Object message, <span class="hljs-type">int</span> delayTime)</span> &#123;<br>    <span class="hljs-comment">//1.创建自定义相关消息对象-包含业务数据本身，交换器名称，路由键，队列类型，延迟时间,重试次数</span><br>    <span class="hljs-type">GuiguCorrelationData</span> <span class="hljs-variable">correlationData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuiguCorrelationData</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq:&quot;</span> + UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    correlationData.setId(uuid);<br>    correlationData.setMessage(message);<br>    correlationData.setExchange(exchange);<br>    correlationData.setRoutingKey(routingKey);<br>    correlationData.setDelay(<span class="hljs-literal">true</span>);<br>    correlationData.setDelayTime(delayTime);<br><br>    <span class="hljs-comment">//2.将相关消息封装到发送消息方法中</span><br>    rabbitTemplate.convertAndSend(exchange, routingKey, message,message1 -&gt; &#123;<br>        message1.getMessageProperties().setDelay(delayTime*<span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">return</span> message1;<br>    &#125;, correlationData);<br><br>    <span class="hljs-comment">//3.将相关消息存入Redis  Key：UUID  相关消息对象  10 分钟</span><br>    redisTemplate.opsForValue().set(uuid, JSON.toJSONString(correlationData), <span class="hljs-number">10</span>, TimeUnit.MINUTES);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3、消费者端幂等性处理"><a href="#3、消费者端幂等性处理" class="headerlink" title="3、消费者端幂等性处理"></a>3、消费者端幂等性处理</h5><p>消费结果会发送多次，也被消费多次！</p>
<p>如何保证消息幂等性？</p>
<ol>
<li>使用数据库方式</li>
<li><strong>使用redis setnx 命令解决（推荐）</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//监听延迟消息</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@RabbitListener(queues = &#123;DeadLetterMqConfig.queue_dead_2&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDeadLetterMsg</span><span class="hljs-params">(String msg, Message message, Channel channel)</span> &#123;<br>    <span class="hljs-comment">//接收消息，消费者端判断是否需要做幂等性处理，如果业务保证幂等性，基于redis setnx保证</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mq:&quot;</span> + msg;<br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">200</span>, TimeUnit.SECONDS);<br>    <span class="hljs-keyword">if</span> (!flag) &#123;<br>        <span class="hljs-comment">//说明该业务数据已经被执行</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 执行业务</span><br>    <span class="hljs-comment">//  TODO </span><br>    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-5-库存接口"><a href="#4-5-库存接口" class="headerlink" title="4.5 库存接口"></a>4.5 库存接口</h2><h3 id="4-5-1-解锁库存"><a href="#4-5-1-解锁库存" class="headerlink" title="4.5.1 解锁库存"></a>4.5.1 解锁库存</h3><p>下单失败，接口抛出异常，解锁库存我们必须保证执行成功，那么怎么办呢？前面讲解了Rabbit，它能保证数据的最终一致性，因此我们提供一个mq接口解锁库存。</p>
<p>操作模块：<code>product</code></p>
<p>1、pom.xml</p>
<p><code>product</code>模块添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2、product-dev.yml</p>
<p>添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">CORRELATED</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">cknowledge-mode:</span> <span class="hljs-string">manual</span> <span class="hljs-comment">#默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span><br>        <span class="hljs-attr">prefetch:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为1为：公平分发</span><br></code></pre></td></tr></table></figure>

<p>3、ProductReceiver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.product.receiver;<br><br><span class="hljs-keyword">import</span> com.common.rabbit.constant.MqConst;<br><span class="hljs-keyword">import</span> com.product.service.IProductService;<br><span class="hljs-keyword">import</span> lombok.SneakyThrows;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;<br><span class="hljs-keyword">import</span> org.springframework.amqp.core.Message;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;<br><span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> com.rabbitmq.client.Channel;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductReceiver</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IProductService productService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 解锁库存</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orderNo 订单号</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            exchange = @Exchange(value = MqConst.EXCHANGE_PRODUCT, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            value = @Queue(value = MqConst.QUEUE_UNLOCK, durable = &quot;true&quot;),</span><br><span class="hljs-meta">            key = &#123;MqConst.ROUTING_UNLOCK&#125;</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String orderNo, Message message, Channel channel)</span> &#123;<br>        <span class="hljs-comment">//业务处理</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(orderNo))&#123;<br>            log.info(<span class="hljs-string">&quot;[商品服务]监听解锁库存消息：&#123;&#125;&quot;</span>, orderNo);<br>            <span class="hljs-comment">//解锁库存</span><br>            productService.unlock(orderNo);<br>        &#125;<br><br>        <span class="hljs-comment">//手动应答</span><br>        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4、IProductService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String orderNo)</span>;<br></code></pre></td></tr></table></figure>

<p>5、ProductServiceI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(rollbackFor = &#123;Exception.class&#125;)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String orderNo)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sku:unlock:&quot;</span> + orderNo;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">dataKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sku:lock:data:&quot;</span> + orderNo;<br>    <span class="hljs-comment">//业务去重，防止重复消费</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, orderNo, <span class="hljs-number">1</span>, TimeUnit.HOURS);<br>    <span class="hljs-keyword">if</span>(!isExist) <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// 获取锁定库存的缓存信息</span><br>    List&lt;SkuLockVo&gt; skuLockVoList = (List&lt;SkuLockVo&gt;)<span class="hljs-built_in">this</span>.redisTemplate.opsForValue().get(dataKey);<br>    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(skuLockVoList))&#123;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    <span class="hljs-comment">// 解锁库存</span><br>    skuLockVoList.forEach(skuLockVo -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> skuStockMapper.unlock(skuLockVo.getSkuId(), skuLockVo.getSkuNum());<br>        <span class="hljs-keyword">if</span>(row == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//解除去重</span><br>            <span class="hljs-built_in">this</span>.redisTemplate.delete(key);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;解锁出库失败&quot;</span>);<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-comment">// 解锁库存之后，删除锁定库存的缓存。以防止重复解锁库存</span><br>    <span class="hljs-built_in">this</span>.redisTemplate.delete(dataKey);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>6、SkuStockMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Integer <span class="hljs-title function_">unlock</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;skuId&quot;)</span> Long skuId, <span class="hljs-meta">@Param(&quot;num&quot;)</span>Integer num)</span>;<br></code></pre></td></tr></table></figure>

<p>7、SkuStockMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;unlock&quot;</span>&gt;</span><br>    update sku_stock<br>    set lock_num = lock_num - #&#123;num&#125;, available_num = available_num + #&#123;num&#125;<br>    where sku_id = #&#123;skuId&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-5-2-扣减库存"><a href="#4-5-2-扣减库存" class="headerlink" title="4.5.2 扣减库存"></a>4.5.2 扣减库存</h3><p>订单支付成功之后，通过发送mq消息，实现库存的真正去扣减</p>
<p>扣减库存跟解锁库存一样，提供mq接收端</p>
<p>1、ProductReceiver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 扣减库存</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderNo  订单号</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">        exchange = @Exchange(value = MqConst.EXCHANGE_PRODUCT, durable = &quot;true&quot;),</span><br><span class="hljs-meta">        value = @Queue(value = MqConst.QUEUE_MINUS, durable = &quot;true&quot;),</span><br><span class="hljs-meta">        key = &#123;MqConst.ROUTING_MINUS&#125;</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(String orderNo, Channel channel, Message message)</span> &#123;<br>    <span class="hljs-comment">//业务处理</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(orderNo))&#123;<br>        log.info(<span class="hljs-string">&quot;[商品服务]监听减库存消息：&#123;&#125;&quot;</span>, orderNo);<br>        <span class="hljs-comment">//扣减库存</span><br>        productService.minus(orderNo);<br>    &#125;<br><br>    <span class="hljs-comment">//手动应答</span><br>    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2、IProductService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(String orderNo)</span>;<br></code></pre></td></tr></table></figure>

<p>3、ProductServiceI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(rollbackFor = &#123;Exception.class&#125;)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(String orderNo)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sku:minus:&quot;</span> + orderNo;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">dataKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sku:lock:data:&quot;</span> + orderNo;<br>    <span class="hljs-comment">//业务去重，防止重复消费</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, orderNo, <span class="hljs-number">1</span>, TimeUnit.HOURS);<br>    <span class="hljs-keyword">if</span>(!isExist) <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// 获取锁定库存的缓存信息</span><br>    List&lt;SkuLockVo&gt; skuLockVoList = (List&lt;SkuLockVo&gt;)<span class="hljs-built_in">this</span>.redisTemplate.opsForValue().get(dataKey);<br>    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(skuLockVoList))&#123;<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br><br>    <span class="hljs-comment">// 减库存</span><br>    skuLockVoList.forEach(skuLockVo -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> skuStockMapper.minus(skuLockVo.getSkuId(), skuLockVo.getSkuNum());<br>        <span class="hljs-keyword">if</span>(row == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//解除去重</span><br>            <span class="hljs-built_in">this</span>.redisTemplate.delete(key);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;减出库失败&quot;</span>);<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-comment">// 解锁库存之后，删除锁定库存的缓存。以防止重复解锁库存</span><br>    <span class="hljs-built_in">this</span>.redisTemplate.delete(dataKey);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4、SkuStockMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Integer <span class="hljs-title function_">minus</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;skuId&quot;)</span> Long skuId, <span class="hljs-meta">@Param(&quot;num&quot;)</span>Integer num)</span>;<br></code></pre></td></tr></table></figure>

<p>5、SkuStockMapper.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;minus&quot;</span>&gt;</span><br>    update sku_stock<br>    set lock_num = lock_num - #&#123;num&#125;, total_num = total_num - #&#123;num&#125;, sale_num = sale_num + #&#123;num&#125;<br>    where sku_id = #&#123;skuId&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-5-3-下单接口改造"><a href="#4-5-3-下单接口改造" class="headerlink" title="4.5.3 下单接口改造"></a>4.5.3 下单接口改造</h3><p><strong>操作OrderInfoServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Long <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(OrderForm orderForm)</span> &#123;<br>    ...<br><br>    <span class="hljs-comment">//3.2.校验库存并锁定库存</span><br>    List&lt;SkuLockVo&gt; skuLockVoList = orderItemList.stream().map(item -&gt; &#123;<br>        <span class="hljs-type">SkuLockVo</span> <span class="hljs-variable">skuLockVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkuLockVo</span>();<br>        skuLockVo.setSkuId(item.getSkuId());<br>        skuLockVo.setSkuNum(item.getSkuNum());<br>        <span class="hljs-keyword">return</span> skuLockVo;<br>    &#125;).collect(Collectors.toList());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">checkAndLockResult</span> <span class="hljs-operator">=</span> remoteProductService.checkAndLock(orderForm.getTradeNo(), skuLockVoList, SecurityConstants.INNER).getData();<br>    <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(checkAndLockResult)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(checkAndLockResult);<br>    &#125;<br><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//4 下单</span><br>        ...<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-comment">//4.1 下单失败，解锁库存</span><br>        rabbitService.sendMessage(MqConst.EXCHANGE_PRODUCT, MqConst.ROUTING_UNLOCK, orderForm.getTradeNo());<br>        <span class="hljs-comment">//抛出异常</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">&quot;下单失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//5 删除购物车选项</span><br>    ...<br><br>    <span class="hljs-keyword">return</span> orderId;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-6-支付页"><a href="#4-6-支付页" class="headerlink" title="4.6 支付页"></a>4.6 支付页</h2><h3 id="4-6-1-需求说明"><a href="#4-6-1-需求说明" class="headerlink" title="4.6.1 需求说明"></a>4.6.1 需求说明</h3><p>提交订单成功，跳转到支付页面，根据订单id获取订单详细信息，展示订单支付信息</p>
<p><strong>查看接口文档：</strong></p>
<p>根据订单id获取订单信息接口地址及返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json">get /order/orderInfo/getOrderInfo/<span class="hljs-punctuation">&#123;</span>orderId<span class="hljs-punctuation">&#125;</span><br>返回结果：<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;createTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2024-02-28 08:29:36&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;nickName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;13700032456&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;orderNo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;f1866bad38bc4627958542d72a15ca9c&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;couponId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;totalAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9997.00</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;couponAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.00</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;originalTotalAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9997.00</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;feightFee&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.00</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;orderStatus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;晴天&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverPhone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15023656352&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverTagName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;家&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverProvince&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110000&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverCity&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110100&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverDistrict&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;110101&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiverAddress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;北京市北京市东城区东直门1号&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;paymentTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;deliveryTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;receiveTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;cancelTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;cancelReason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;orderItemList&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="4-6-2-后端业务接口"><a href="#4-6-2-后端业务接口" class="headerlink" title="4.6.2 后端业务接口"></a>4.6.2 后端业务接口</h3><p><strong>操作OrderInfoController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Operation(summary = &quot;获取订单信息&quot;)</span><br><span class="hljs-meta">@RequiresLogin</span><br><span class="hljs-meta">@GetMapping(&quot;getOrderInfo/&#123;orderId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">getOrderInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> &#123;<br>    <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">orderInfo</span> <span class="hljs-operator">=</span> orderInfoService.getById(orderId);<br>    <span class="hljs-keyword">return</span> success(orderInfo);<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/" class="category-chain-item">小型电商模拟</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>4、订单</div>
      <div>http://example.com/2024/11/05/项目/小型电商模拟/第4章_订单/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>pz</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年11月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC5%E7%AB%A0_%E6%94%AF%E4%BB%98/" title="5、支付">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">5、支付</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/11/05/%E9%A1%B9%E7%9B%AE/%E5%B0%8F%E5%9E%8B%E7%94%B5%E5%95%86%E6%A8%A1%E6%8B%9F/%E7%AC%AC3%E7%AB%A0_%E8%B4%AD%E7%89%A9%E8%BD%A6/" title="3、购物车">
                        <span class="hidden-mobile">3、购物车</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
